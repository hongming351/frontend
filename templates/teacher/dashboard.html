<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师控制台 - 智能出题系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 引入highlight.js样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <!-- Tailwind 配置 -->
    <script>
        // HTML转义函数，避免代码中的特殊字符干扰HTML结构
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 智能出题API调用相关功能
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('apiForm');
            const testBtn = document.getElementById('testBtn');
            const clearBtn = document.getElementById('clearBtn');
            const importDbBtn = document.getElementById('importDbBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultArea = document.getElementById('resultArea');

            // 获取AI自测按钮
            const selfTestBtn = document.getElementById('selfTestBtn');

            // 确保元素存在
            if (testBtn && clearBtn && importDbBtn && selfTestBtn && loadingIndicator && resultArea) {
                // 测试API调用
                testBtn.addEventListener('click', async function() {
                    await callApi('/api/ai/problems/generate', true);
                });

                // AI自测
                selfTestBtn.addEventListener('click', async function() {
                    await performSelfTest();
                });

                // 导入数据库
                importDbBtn.addEventListener('click', async function() {
                    await importDatabase();
                });

                // 清空结果
                clearBtn.addEventListener('click', function() {
                    resultArea.innerHTML = '<p class="text-dark-2">请填写表单并点击上方按钮开始测试API调用</p>';
                    resultArea.className = 'result mt-6';
                    // 清空存储的题目数据
                    currentGeneratedProblem = null;
                    console.log('已清空存储的题目数据');
                });
            }
            
            // 全局变量存储生成的题目数据
            let currentGeneratedProblem = null;

            // 导入数据库函数
            async function importDatabase() {
                // 检查是否有生成的题目数据
                if (!currentGeneratedProblem) {
                    if (resultArea) {
                        resultArea.className = 'result mt-6 error';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">导入失败</h3>
                            </div>
                            <p class="text-danger mb-4">请先点击"生成题目"按钮生成题目数据</p>
                        `;
                    }
                    return;
                }

                // 设置按钮和加载状态
                if (testBtn) testBtn.disabled = true;
                if (importDbBtn) importDbBtn.disabled = true;
                if (clearBtn) clearBtn.disabled = true;
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (resultArea) resultArea.innerHTML = '';

                try {
                    const baseUrl = 'http://127.0.0.1:5000';
                    const url = baseUrl + '/api/ai/problems/import';
                    const startTime = Date.now();

                    // 发送生成的题目数据
                    console.log('准备发送数据到后端:', currentGeneratedProblem);
                    console.log('数据类型:', typeof currentGeneratedProblem);
                    console.log('数据JSON:', JSON.stringify(currentGeneratedProblem));

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(currentGeneratedProblem),
                        credentials: 'include'  // 包含会话cookie
                    });

                    const endTime = Date.now();
                    const responseTime = endTime - startTime;

                    console.log(`数据库导入API调用完成，状态码: ${response.status}，耗时: ${responseTime}ms`);
                    console.log('发送的数据:', currentGeneratedProblem);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.error || `API调用失败，状态码: ${response.status}`);
                    }

                    const data = await response.json();

                    // 显示成功结果
                    if (resultArea) {
                        resultArea.className = 'result mt-6 success';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">数据库导入成功！</h3>
                                <span class="text-sm text-dark-2">响应时间: ${responseTime}ms</span>
                            </div>
                            <p class="text-success mb-4">API状态码: ${response.status}</p>
                            <h4 class="font-medium mb-2">导入结果:</h4>
                            <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${JSON.stringify(data, null, 2)}</pre>
                        `;
                    }
                } catch (error) {
                    console.error('数据库导入失败:', error);
                    if (resultArea) {
                        resultArea.className = 'result mt-6 error';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">数据库导入失败</h3>
                            </div>
                            <p class="text-danger mb-4">错误信息: ${error.message}</p>
                            <p class="text-dark-2 mb-2">请检查控制台获取更多详细信息</p>
                            <h4 class="font-medium mb-2">调试信息:</h4>
                            <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${error.stack || '无详细错误信息'}</pre>
                        `;
                    }
                } finally {
                    // 恢复按钮状态
                    if (testBtn) testBtn.disabled = false;
                    if (importDbBtn) importDbBtn.disabled = false;
                    if (clearBtn) clearBtn.disabled = false;
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
            }

            // AI自测函数
            async function performSelfTest() {
                // 检查是否有生成的题目数据
                if (!currentGeneratedProblem) {
                    if (resultArea) {
                        resultArea.className = 'result mt-6 error';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">自测失败</h3>
                            </div>
                            <p class="text-danger mb-4">请先点击"生成题目"按钮生成题目数据</p>
                        `;
                    }
                    return;
                }

                // 设置按钮和加载状态
                if (testBtn) testBtn.disabled = true;
                if (importDbBtn) importDbBtn.disabled = true;
                if (selfTestBtn) selfTestBtn.disabled = true;
                if (clearBtn) clearBtn.disabled = true;
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (resultArea) resultArea.innerHTML = '';

                try {
                    const baseUrl = 'http://127.0.0.1:5000';
                    const url = baseUrl + '/api/ai/problems/self-test';
                    const startTime = Date.now();

                    // 发送生成的题目数据进行自测
                    console.log('准备发送题目数据进行AI自测:', currentGeneratedProblem);
                    console.log('数据类型:', typeof currentGeneratedProblem);
                    console.log('数据JSON:', JSON.stringify(currentGeneratedProblem));

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(currentGeneratedProblem),
                        credentials: 'include'  // 包含会话cookie
                    });

                    const endTime = Date.now();
                    const responseTime = endTime - startTime;

                    console.log(`AI自测API调用完成，状态码: ${response.status}，耗时: ${responseTime}ms`);
                    console.log('发送的数据:', currentGeneratedProblem);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.error || `API调用失败，状态码: ${response.status}`);
                    }

                    const data = await response.json();

                    // 显示自测成功结果
                    if (resultArea) {
                        try {
                            resultArea.className = 'result mt-6 success';
                            resultArea.innerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">AI自测完成！</h3>
                                    <span class="text-sm text-dark-2">响应时间: ${responseTime}ms</span>
                                </div>
                                <p class="text-success mb-4">API状态码: ${response.status}</p>
                                <h4 class="font-medium mb-2">自测结果:</h4>
                                <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${JSON.stringify(data, null, 2)}</pre>
                                <div class="mt-4 p-4 bg-light-1 rounded-lg">
                                    <h5 class="font-medium text-dark mb-2">自测总结</h5>
                                    <p class="text-sm text-dark-2">AI已对生成的题目进行了全面的自测验证，包括题目质量、答案正确性、格式规范性等方面的评估。</p>
                                </div>
                            `;
                        } catch (displayError) {
                            console.error('显示自测结果时出错:', displayError);
                            resultArea.innerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-danger">显示结果失败</h3>
                                    <span class="text-sm text-dark-2">响应时间: ${responseTime}ms</span>
                                </div>
                                <p class="text-success mb-4">API状态码: ${response.status}</p>
                                <p class="text-danger mb-4">显示结果时出现错误，请检查控制台获取详细信息</p>
                                <h4 class="font-medium mb-2">原始响应数据:</h4>
                                <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${JSON.stringify(data)}</pre>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('AI自测失败:', error);
                    if (resultArea) {
                        resultArea.className = 'result mt-6 error';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">AI自测失败</h3>
                            </div>
                            <p class="text-danger mb-4">错误信息: ${error.message}</p>
                            <p class="text-dark-2 mb-2">请检查控制台获取更多详细信息</p>
                            <h4 class="font-medium mb-2">调试信息:</h4>
                            <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${error.stack || '无详细错误信息'}</pre>
                        `;
                    }
                } finally {
                    // 恢复按钮状态
                    if (testBtn) testBtn.disabled = false;
                    if (importDbBtn) importDbBtn.disabled = false;
                    if (selfTestBtn) selfTestBtn.disabled = false;
                    if (clearBtn) clearBtn.disabled = false;
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
            }

            // 通用API调用函数
            async function callApi(endpoint, isGenerateCall = true) {
                // 设置按钮和加载状态
                if (testBtn) testBtn.disabled = true;
                if (importDbBtn) importDbBtn.disabled = true;
                if (selfTestBtn) selfTestBtn.disabled = true;
                if (clearBtn) clearBtn.disabled = true;
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (resultArea) resultArea.innerHTML = '';
                
                try {
                    const baseUrl = 'http://127.0.0.1:5000';
                    const url = baseUrl + endpoint;
                    
                    // 准备请求数据
                    let payload = {};
                    if (isGenerateCall) {
                        // 获取表单数据
                        payload = {
                            knowledge_point: document.getElementById('knowledgePoint').value || '动态规划',
                            difficulty: document.getElementById('difficulty').value,
                            language: document.getElementById('language').value,
                            problem_type: document.getElementById('problemType').value,
                        };
                        
                        // 添加可选字段（如果有值）
                        const title = document.getElementById('title').value.trim();
                        const customRequirements = document.getElementById('customRequirements').value.trim();

                        if (title) payload.title = title;
                        if (customRequirements) {
                            payload.custom_requirements = customRequirements.split('\n')
                                .map(req => req.trim())
                                .filter(req => req.length > 0);
                        }
                    }
                    
                    console.log('发送请求到API:', url);
                    console.log('请求参数:', payload);
                    
                    // 调用API
                    const startTime = Date.now();
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: isGenerateCall ? JSON.stringify(payload) : '{}',
                        credentials: 'include'  // 包含会话cookie
                    });
                    const endTime = Date.now();
                    const responseTime = endTime - startTime;
                    
                    console.log(`API调用完成，状态码: ${response.status}，耗时: ${responseTime}ms`);
                    
                    // 处理响应
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.error || `API调用失败，状态码: ${response.status}`);
                    }
                    
                    const data = await response.json();

                    // 调试API响应数据
                    console.log('API响应数据结构:', data);
                    if (data && data.success && (data.description || data.name)) {
                        const problem = data;
                        console.log('选择题API响应 - options:', problem.options);
                        console.log('选择题API响应 - correct_answer:', problem.correct_answer);
                        console.log('选择题API响应 - options类型:', typeof problem.options);
                    }

                    // 显示成功结果
                    if (resultArea) {
                        resultArea.className = 'result mt-6 success';

                        // 检查响应是否包含问题数据
                        if (data && data.success && (data.description || data.name)) {
                            const problem = data;

                            // 存储生成的题目数据以供导入使用
                            console.log('准备存储题目数据，problem对象:', problem);
                            console.log('problem.options类型:', typeof problem.options);
                            console.log('problem.options值:', problem.options);
                            console.log('problem.correct_answer类型:', typeof problem.correct_answer);
                            console.log('problem.correct_answer值:', problem.correct_answer);

                            currentGeneratedProblem = {
                                title: problem.title || problem.name,
                                description: problem.description,
                                difficulty: problem.difficulty || 'medium',
                                type: problem.type || 'programming',
                                language: problem.language || 'Python',
                                knowledge_points: problem.knowledge_point || document.getElementById('knowledgePoint').value,
                                solution_idea: problem.solution_idea,
                                input_description: problem.input_description,
                                output_description: problem.output_description,
                                test_cases: problem.test_cases,
                                reference_code: problem.reference_code,
                                options: problem.options,
                                correct_answer: problem.correct_answer
                            };

                            console.log('存储生成的题目数据:', currentGeneratedProblem);
                            console.log('存储的options数据:', currentGeneratedProblem.options);
                            console.log('存储的correct_answer数据:', currentGeneratedProblem.correct_answer);
                            console.log('存储后options类型:', typeof currentGeneratedProblem.options);
                            console.log('存储后options长度:', currentGeneratedProblem.options ? currentGeneratedProblem.options.length : 'undefined');

                            resultArea.innerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">API调用成功！</h3>
                                    <span class="text-sm text-dark-2">响应时间: ${responseTime}ms</span>
                                </div>
                                <p class="text-success mb-4">API状态码: ${response.status}</p>
                                <h4 class="font-medium mb-2">请求参数:</h4>
                                <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm mb-6">${JSON.stringify(payload, null, 2)}</pre>
                                
                                <!-- 分模块显示题目内容 -->
                                <div class="mt-6">
                                    <h3 class="text-lg font-semibold mb-4">生成的题目内容</h3>
                                    
                                    ${problem.name ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">题目标题</h4>
                                        <p class="text-dark">${problem.name}</p>
                                    </div>` : ''}
                                    
                                    ${problem.description ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">题目描述</h4>
                                        <p class="text-dark">${problem.description}</p>
                                    </div>` : ''}
                                    
                                    ${problem.input_description ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">输入说明</h4>
                                        <p class="text-dark">${problem.input_description}</p>
                                    </div>` : ''}
                                    
                                    ${problem.output_description ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">输出说明</h4>
                                        <p class="text-dark">${problem.output_description}</p>
                                    </div>` : ''}

                                    ${problem.type === 'choice' && problem.options ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">选择题选项</h4>
                                        <div class="space-y-2">
                                            ${(() => {
                                                const options = typeof problem.options === 'string' ? JSON.parse(problem.options) : problem.options;
                                                console.log('智能出题页面的options数据:', options);

                                                // 处理不同的选项格式
                                                if (Array.isArray(options)) {
                                                    // 新格式：数组
                                                    console.log('智能出题页面 - 使用数组格式处理');
                                                    let optionsHtml = '';
                                                    options.forEach((value, index) => {
                                                        const key = index.toString();
                                                        const optionLabel = String.fromCharCode(65 + index); // 0->A, 1->B, 2->C, 3->D
                                                        const isCorrectAnswer = problem.correct_answer === key;
                                                        let className = 'bg-light-1';

                                                        if (isCorrectAnswer) {
                                                            className = 'bg-success/10 border border-success/20';
                                                        }

                                                        optionsHtml += `
                                                            <div class="flex items-start gap-2 p-2 rounded ${className}">
                                                                <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                                                <span class="text-sm">${value}</span>
                                                                ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                                            </div>
                                                        `;
                                                    });
                                                    return optionsHtml;
                                                } else {
                                                    // 旧格式：对象（兼容性保留）
                                                    Object.entries(options).forEach(([key, value], index) => {
                                                        const optionLabel = String.fromCharCode(65 + index);
                                                        const isCorrectAnswer = problem.correct_answer === key;
                                                        let className = 'bg-light-1';

                                                        if (isCorrectAnswer) {
                                                            className = 'bg-success/10 border border-success/20';
                                                        }

                                                        optionsHtml += `
                                                            <div class="flex items-start gap-2 p-2 rounded ${className}">
                                                                <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                                                <span class="text-sm">${value}</span>
                                                                ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                                            </div>
                                                        `;
                                                    });
                                                    return optionsHtml;
                                                }
                                            })()}
                                            <div class="mt-3 p-2 bg-light-1 rounded text-sm">
                                                <strong class="text-dark-2">正确答案：</strong>
                                                <span class="text-success font-medium text-lg">${(() => {
                                                    if (problem.correct_answer) {
                                                        // 如果correct_answer是数字或者字符串索引，需要转换为字母
                                                        if (typeof problem.correct_answer === 'string' || typeof problem.correct_answer === 'number') {
                                                            const index = parseInt(problem.correct_answer);
                                                            if (!isNaN(index)) {
                                                                return String.fromCharCode(65 + index);
                                                            }
                                                            return problem.correct_answer.toUpperCase();
                                                        }
                                                        return problem.correct_answer;
                                                    }
                                                    return '未设置';
                                                })()}</span>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                    
                                    ${problem.test_cases && problem.test_cases.length > 0 ? `
                                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-3">测试用例</h4>
                                        <div class="space-y-3">
                                            ${problem.test_cases.map((testCase, index) => `
                                            <div class="bg-light-1 p-3 rounded-md">
                                                <div class="font-medium text-dark mb-2">测试用例 ${index + 1}</div>
                                                <div class="mb-2">
                                                    <strong class="text-dark-2">输入：</strong>
                                                    <pre class="bg-dark text-white p-2 rounded-md text-sm mt-1">${escapeHtml(testCase.input)}</pre>
                                                </div>
                                                <div>
                                                    <strong class="text-dark-2">输出：</strong>
                                                    <pre class="bg-dark text-white p-2 rounded-md text-sm mt-1">${escapeHtml(testCase.output)}</pre>
                                                </div>
                                            </div>`).join('')}
                                        </div>
                                    </div>` : ''}
                                    
                                    ${problem.solution_idea ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">解题思路</h4>
                                        <p class="text-dark">${problem.solution_idea}</p>
                                    </div>` : ''}
                                    
                                    ${problem.reference_code ? `<div class="bg-white p-4 rounded-lg shadow-sm mb-4 border-l-4 border-primary">
                                        <h4 class="font-medium text-primary mb-2">参考代码</h4>
                                        <pre class="bg-dark text-white p-3 rounded-md text-sm mt-1"><code class="language-${payload.language.toLowerCase()}">${escapeHtml(problem.reference_code)}</code></pre>
                                    </div>` : ''}
                                    
                                    <button id="viewRawDataBtn" class="px-4 py-2 bg-dark-2 text-white rounded-md text-sm hover:bg-dark transition-colors mt-4">查看原始响应数据</button>
                                    <div id="rawDataContainer" class="mt-4 bg-light-1 p-4 rounded-lg" style="display: none;">
                                        <h4 class="font-medium text-dark mb-2">原始响应数据</h4>
                                        <pre class="bg-dark text-white p-3 rounded-md text-sm overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                                    </div>
                                </div>
                            `;
                            
                            // 添加查看原始数据按钮的事件监听
                            setTimeout(() => {
                                const viewRawBtn = document.getElementById('viewRawDataBtn');
                                const rawContainer = document.getElementById('rawDataContainer');
                                if (viewRawBtn && rawContainer) {
                                    viewRawBtn.addEventListener('click', function() {
                                        if (rawContainer.style.display === 'none') {
                                            rawContainer.style.display = 'block';
                                            viewRawBtn.textContent = '隐藏原始响应数据';
                                        } else {
                                            rawContainer.style.display = 'none';
                                            viewRawBtn.textContent = '查看原始响应数据';
                                        }
                                    });
                                }
                            }, 10);
                        } else {
                            // 显示常规的API响应
                            resultArea.innerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">API调用成功！</h3>
                                    <span class="text-sm text-dark-2">响应时间: ${responseTime}ms</span>
                                </div>
                                <p class="text-success mb-4">API状态码: ${response.status}</p>
                                <h4 class="font-medium mb-2">请求参数:</h4>
                                <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm mb-4">${JSON.stringify(payload, null, 2)}</pre>
                                <h4 class="font-medium mb-2">响应数据:</h4>
                                <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${JSON.stringify(data, null, 2)}</pre>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('API调用失败:', error);
                    if (resultArea) {
                        resultArea.className = 'result mt-6 error';
                        resultArea.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">API调用失败</h3>
                            </div>
                            <p class="text-danger mb-4">错误信息: ${error.message}</p>
                            <p class="text-dark-2 mb-2">请检查控制台获取更多详细信息</p>
                            <h4 class="font-medium mb-2">调试信息:</h4>
                            <pre class="bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm">${error.stack || '无详细错误信息'}</pre>
                        `;
                    }
                } finally {
                    // 恢复按钮状态
                    if (testBtn) testBtn.disabled = false;
                    if (importDbBtn) importDbBtn.disabled = false;
                    if (selfTestBtn) selfTestBtn.disabled = false;
                    if (clearBtn) clearBtn.disabled = false;
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                }
            }
        });

        // 原有导航和其他功能的JavaScript代码
        
        // 引入highlight.js脚本
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js';
        document.head.appendChild(script);

        // 初始化代码高亮
        script.onload = function() {
            hljs.highlightAll();
        };

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0A66C2',
                        secondary: '#7B3FE4',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        'dark-2': '#4B5563',
                        'light-1': '#F9FAFB',
                        'light-2': '#E5E7EB',
                        'light-3': '#D1D5DB'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .nav-item {
                @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-primary/10 text-dark-2 cursor-pointer;
            }
            .nav-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 active:bg-primary/80;
            }
            .btn-outline {
                @apply border border-light-3 hover:border-primary hover:text-primary;
            }
            .stat-card {
                @apply bg-white rounded-xl shadow-sm border border-light-2 p-5 card-hover;
            }
            .form-input {
                @apply w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors;
            }
            .form-label {
                @apply block text-sm font-medium text-dark-2 mb-1;

            }
            .badge {
                @apply px-2 py-1 text-xs rounded-full;
            }
            /* 题目生成表单样式 */
            .form-group {
                @apply mb-4;
            }
            .form-select {
                @apply w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors;
            }
            .result {
                @apply bg-white rounded-xl shadow-sm border border-light-2 p-5;
            }
            .result.error {
                @apply border-danger/30 bg-danger/5;
            }
            .problem-section {
                @apply mb-6 p-4 bg-light-1 rounded-lg border border-light-2;
            }
            .problem-section h4 {
                @apply font-medium mb-2 text-primary;
            }
            .code-block {
                @apply bg-dark text-white p-4 rounded-lg overflow-x-auto text-sm my-3;
                white-space: pre-wrap !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
            }

            .code-block pre {
                white-space: pre-wrap !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
                line-height: 1.5;
            }

            .code-block code {
                white-space: pre !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
            }

            /* 全局代码显示样式，确保所有动态生成的代码块都保持缩进 */
            pre[class*="bg-dark"] {
                white-space: pre-wrap !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
                line-height: 1.5;
            }

            pre[class*="bg-dark"] code {
                white-space: pre-wrap !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
            }

            /* 表格中代码显示区域的缩进保护 */
            .overflow-x-auto pre {
                white-space: pre-wrap;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            }

            /* code标签内联代码样式保护 */
            pre code {
                white-space: pre !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
            }

            /* 确保pre内所有内容保持缩进 */
            pre {
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4 !important;
                -moz-tab-size: 4 !important;
                -webkit-tab-size: 4 !important;
                white-space: pre-wrap !important;
            }

            /* 代码块通用样式 */
            .code-block, .code-block * {
                white-space: pre-wrap !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                tab-size: 4;
                -moz-tab-size: 4;
                -webkit-tab-size: 4;
            }

            /* 清理highlight.js冲突样式 */
            pre[class*="bg-dark"] hljs {
                white-space: pre !important;
            }

            /* 对不同语言的强制样式 */
            pre[class*="bg-dark"] .hljs {
                white-space: pre !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
            }
            /* 页面切换样式 */
            .page-section {
                display: none;
            }
            .page-section.active {
                display: block;
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes blink {
                0%, 50% { opacity: 1; }
                25%, 75% { opacity: 0.7; }
            }
        }
    </style>
</head>
<body class="font-inter bg-light-1 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-light-2 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md hover:bg-light-1 transition-colors">
                    <i class="fa fa-bars text-dark-2"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white">
                        <i class="fa fa-graduation-cap"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-dark hidden sm:block">智能OJ系统 - 教师端</h1>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative hidden md:block">
                    <input type="text" placeholder="搜索作业或学生..." class="pl-10 pr-4 py-2 rounded-lg border border-light-2 focus:outline-none focus:border-primary w-64 text-sm transition-all">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                </div>
                
                <button class="p-2 rounded-full hover:bg-light-1 relative transition-colors">
                    <i class="fa fa-bell-o text-dark-2"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-danger rounded-full"></span>
                </button>
                
                    <div class="flex items-center gap-2 group">
                    <img src="https://picsum.photos/id/1005/40/40" alt="教师头像" class="w-8 h-8 rounded-full object-cover border border-light-2">
                    <span class="text-sm font-medium hidden sm:block">{{ user.username }}</span>
                    <i class="fa fa-angle-down text-light-3 text-xs transition-transform group-hover:rotate-180"></i>
                    
                    <!-- 用户菜单 -->
                    <div class="absolute right-4 mt-14 w-48 bg-white rounded-lg shadow-lg border border-light-2 py-2 hidden group-hover:block z-50">
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-light-1 transition-colors" onclick="navigateTo('profile')">
                            <i class="fa fa-user-o mr-2 text-light-3"></i>个人资料
                        </a>
                        <a href="#" class="block px-4 py-2 text-sm hover:bg-light-1 transition-colors" onclick="navigateTo('password-reset-self')">
                            <i class="fa fa-key mr-2 text-light-3"></i>修改密码
                        </a>
                        <div class="border-t border-light-2 my-1"></div>
                        <a href="/logout" class="block px-4 py-2 text-sm text-danger hover:bg-light-1 transition-colors">
                            <i class="fa fa-sign-out mr-2"></i>退出登录
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- 侧边栏 -->
        <aside id="sidebar" class="w-64 bg-white border-r border-light-2 flex-shrink-0 hidden lg:block transition-all duration-300 ease-in-out transform z-40 h-[calc(100vh-61px)] overflow-y-auto">
            <div class="h-full flex flex-col">
                <nav class="p-3 flex-1 overflow-y-auto">
                    <div class="space-y-1">
                        <p class="px-4 text-xs font-medium text-light-3 uppercase tracking-wider mb-2">主菜单</p>
                        <a href="#dashboard" class="nav-item active" onclick="return navigateTo('dashboard')">
                            <i class="fa fa-tachometer w-5 text-center"></i>
                            <span>仪表盘</span>
                        </a>
                        <a href="#assignment" class="nav-item" onclick="return navigateTo('assignment')">
                            <i class="fa fa-book w-5 text-center"></i>
                            <span>作业管理</span>
                        </a>
                        <a href="#grading" class="nav-item" onclick="return navigateTo('grading')">
                            <i class="fa fa-check-square-o w-5 text-center"></i>
                            <span>批改作业</span>
                        </a>
                        <a href="#course-management" class="nav-item" onclick="return navigateTo('course-management')">
                            <i class="fa fa-book w-5 text-center"></i>
                            <span>课程管理</span>
                        </a>
                        <a href="#problems" class="nav-item" onclick="return navigateTo('problems')">
                            <i class="fa fa-question-circle w-5 text-center"></i>
                            <span>题库管理</span>
                        </a>
                        <a href="#ai-problem" class="nav-item" onclick="return navigateTo('ai-problem')">
                            <i class="fa fa-magic w-5 text-center"></i>
                            <span>智能出题</span>
                        </a>
                    </div>
                </nav>
                
                <div class="p-4 border-t border-light-2">
                    <div class="bg-secondary/5 rounded-xl p-4">
                        <h4 class="font-medium text-sm mb-2">课程信息</h4>
                        <p class="text-xs text-dark-2 mb-1">数据结构与算法</p>
                        <p class="text-xs text-dark-2">班级人数: 45人</p>
                        <button class="text-primary text-xs mt-2 hover:underline flex items-center">
                            <i class="fa fa-pencil mr-1"></i> 编辑课程
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6">
            <div class="max-w-7xl mx-auto space-y-6">
                <section id="dashboard" class="page-section active">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold">仪表盘</h2>
                            <p class="text-dark-2 mt-1">教学数据概览与作业状态</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button class="btn btn-outline hover:bg-light-1 transition-colors">
                                <i class="fa fa-download"></i>
                                <span>导出报告</span>
                            </button>
                            <button class="btn btn-primary" onclick="navigateTo('assignment')">
                                <i class="fa fa-plus"></i>
                                <span>布置新作业</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="stat-card">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-dark-2 text-sm">总作业数</p>
                                    <h3 class="text-2xl font-semibold mt-1">12</h3>
                                    <p class="text-success text-xs mt-2 flex items-center">
                                        <i class="fa fa-arrow-up mr-1"></i> 较上周 +2
                                    </p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <i class="fa fa-file-text-o"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-dark-2 text-sm">待批改</p>
                                    <h3 class="text-2xl font-semibold mt-1">28</h3>
                                    <p class="text-danger text-xs mt-2 flex items-center">
                                        <i class="fa fa-arrow-up mr-1"></i> 较昨日 +5
                                    </p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-dark-2 text-sm">已完成率</p>
                                    <h3 class="text-2xl font-semibold mt-1">78%</h3>
                                    <p class="text-success text-xs mt-2 flex items-center">
                                        <i class="fa fa-arrow-up mr-1"></i> 较上次 +3%
                                    </p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success">
                                    <i class="fa fa-check-circle-o"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-dark-2 text-sm">平均成绩</p>
                                    <h3 class="text-2xl font-semibold mt-1">82.5</h3>
                                    <p class="text-danger text-xs mt-2 flex items-center">
                                        <i class="fa fa-arrow-down mr-1"></i> 较上次 -1.2
                                    </p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                                    <i class="fa fa-star-o"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图表和数据统计 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-light-2 p-5">
                            <div class="flex items-center justify-between mb-5">
                                <h3 class="font-semibold">作业完成情况趋势</h3>
                                <div class="flex gap-2">
                                    <button class="text-sm px-3 py-1 bg-light-1 rounded-full hover:bg-primary/10 hover:text-primary transition-colors">周</button>
                                    <button class="text-sm px-3 py-1 bg-primary/10 text-primary rounded-full">月</button>
                                    <button class="text-sm px-3 py-1 bg-light-1 rounded-full hover:bg-primary/10 hover:text-primary transition-colors">学期</button>
                                </div>
                            </div>
                            <div>
                                <canvas id="completion-chart" height="250"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-light-2 p-5">
                            <h3 class="font-semibold mb-5">成绩分布</h3>
                            <div>
                                <canvas id="grades-chart" height="250"></canvas>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-primary"></span>
                                    <span>90-100分</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-secondary"></span>
                                    <span>80-89分</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-success"></span>
                                    <span>70-79分</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-warning"></span>
                                    <span>60-69分</span>
                                </div>
                                <div class="flex items-center gap-2 col-span-2">
                                    <span class="w-3 h-3 rounded-full bg-danger"></span>
                                    <span>60分以下</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                
                <!-- 2. 作业管理模块 -->
                <section id="assignment" class="page-section">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold">作业管理</h2>
                            <p class="text-dark-2 mt-1">布置、编辑和管理学生作业</p>
                        </div>
                        
                        <button class="btn btn-primary" onclick="openCreateAssignmentModal()">
                            <i class="fa fa-plus"></i>
                            <span>布置新作业</span>
                        </button>
                    </div>
                    
                    <!-- 最近作业列表 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 overflow-hidden">
                        <div class="border-b border-light-2 px-6 py-4 flex flex-wrap items-center justify-between gap-3">
                            <h3 class="font-semibold">作业列表</h3>
                            <div class="flex flex-wrap gap-3">
                                <div class="relative">
                                    <input type="text" placeholder="搜索作业..." class="pl-8 pr-3 py-1.5 rounded-lg border border-light-2 focus:outline-none focus:border-primary w-48 text-sm transition-all">
                                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3 text-sm"></i>
                                </div>
                                <select class="border border-light-2 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-primary transition-all">
                                    <option>全部状态</option>
                                    <option>进行中</option>
                                    <option>已截止</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full" id="assignment-table">
                                <thead>
                                    <tr class="bg-light-1">
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">作业名称</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">分配班级</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">发布日期</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">截止日期</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">题目数量</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">已提交</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">完成率</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-light-2" id="assignment-table-body">
                                    <!-- 作业数据将通过JavaScript动态加载 -->
                                    <tr>
                                        <td colspan="7" class="px-6 py-8 text-center text-dark-2">
                                            <div class="flex flex-col items-center">
                                                <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                                <p class="text-sm">正在加载作业数据...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页 -->
                        <div class="px-6 py-4 border-t border-light-2 flex items-center justify-between">
                            <p class="text-sm text-dark-2">显示 1-3 条，共 12 条</p>
                            <div class="flex gap-1">
                                <button class="w-8 h-8 flex items-center justify-center rounded border border-light-2 text-dark-2 hover:border-primary hover:text-primary disabled:opacity-50 disabled:hover:border-light-2 disabled:hover:text-dark-2" disabled>
                                    <i class="fa fa-angle-left"></i>
                                </button>
                                <button class="w-8 h-8 flex items-center justify-center rounded bg-primary text-white">1</button>
                                <button class="w-8 h-8 flex items-center justify-center rounded border border-light-2 hover:border-primary hover:text-primary">2</button>
                                <button class="w-8 h-8 flex items-center justify-center rounded border border-light-2 hover:border-primary hover:text-primary">3</button>
                                <button class="w-8 h-8 flex items-center justify-center rounded border border-light-2 text-dark-2 hover:border-primary hover:text-primary">
                                    <i class="fa fa-angle-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- 3. 批改作业模块 -->
                <section id="grading" class="page-section">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold">批改作业</h2>
                            <p class="text-dark-2 mt-1">查看并批改学生提交的作业</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <select class="border border-light-2 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary transition-all">
                                <option>所有作业</option>
                                <option>数组与字符串练习</option>
                                <option>链表操作</option>
                                <option>栈与队列应用</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 待批改作业列表 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 overflow-hidden">
                        <!-- 搜索筛选区域 -->
                        <div class="border-b border-light-2 px-6 py-4 bg-light-1">
                            <div class="flex flex-col lg:flex-row gap-4 items-end">
                                <!-- 学生姓名搜索 -->
                                <div class="w-full lg:w-auto">
                                    <label class="form-label">学生姓名</label>
                                    <div class="relative">
                                        <input type="text" id="grading-student-search" placeholder="搜索学生姓名..." class="form-input pl-10 w-full lg:w-48" onkeypress="handleGradingSearchKeyPress(event)">
                                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                                    </div>
                                </div>

                                <!-- 作业名称搜索 -->
                                <div class="w-full lg:w-auto">
                                    <label class="form-label">作业名称</label>
                                    <div class="relative">
                                        <input type="text" id="grading-assignment-search" placeholder="搜索作业名称..." class="form-input pl-10 w-full lg:w-48" onkeypress="handleGradingSearchKeyPress(event)">
                                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                                    </div>
                                </div>

                                <!-- 搜索按钮 -->
                                <button class="btn btn-primary w-full lg:w-auto" onclick="applyGradingFilters()">
                                    <i class="fa fa-search"></i>
                                    <span>搜索</span>
                                </button>

                                <!-- 清空筛选按钮 -->
                                <button class="btn btn-outline w-full lg:w-auto" onclick="clearGradingFilters()">
                                    <i class="fa fa-eraser"></i>
                                    <span>清空</span>
                                </button>
                            </div>
                        </div>

                        <!-- 表格头部 -->
                        <div class="border-b border-light-2 px-6 py-4">
                            <h3 class="font-semibold">提交记录</h3>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full" id="grading-table">
                                <thead>
                                    <tr class="bg-light-1">
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">学生</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">作业名称</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">最新提交</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">完成情况</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">状态</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-light-2" id="grading-table-body">
                                    <!-- 待批改数据将通过JavaScript动态加载 -->
                                    <tr>
                                        <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                                            <div class="flex flex-col items-center">
                                                <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                                <p class="text-sm">正在加载待批改作业数据...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- 4. 课程管理模块 -->
                <section id="course-management" class="page-section">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold">课程管理</h2>
                            <p class="text-dark-2 mt-1">管理和查看您的课程与班级</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button class="btn btn-primary" onclick="openAddClassModal()">
                                <i class="fa fa-plus"></i>
                                <span>添加班级</span>
                            </button>
                            <button class="btn btn-success" onclick="openRegisterStudentModal()">
                                <i class="fa fa-user-plus"></i>
                                <span>注册学生</span>
                            </button>
                            <button class="btn btn-info" onclick="openBatchRegisterModal()">
                                <i class="fa fa-upload"></i>
                                <span>批量注册学生</span>
                            </button>
                            <button class="btn btn-warning" onclick="openBatchImportStudentsModal()">
                                <i class="fa fa-download"></i>
                                <span>批量导入学生到班级</span>
                            </button>
                            <!-- 新增删除学生按钮 -->
                            <button class="btn btn-danger" onclick="openDeleteStudentModal()">
                                <i class="fa fa-user-times"></i>
                                <span>删除学生</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 课程选择区域 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-center">
                            <div class="w-full lg:w-auto">
                                <label class="form-label">选择课程</label>
                                <select id="course-select" class="form-select w-full lg:w-64" onchange="loadCourseClasses(this.value)">
                                    <option value="">请选择课程...</option>
                                    <!-- 课程选项将通过JavaScript动态生成 -->
                                </select>
                            </div>
                            
                            <div id="course-info" class="flex-1 min-w-0 hidden">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                        <i class="fa fa-book text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 id="selected-course-name" class="font-semibold text-dark"></h3>
                                        <p id="selected-course-language" class="text-sm text-dark-2"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 班级列表 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 overflow-hidden">
                        <div class="border-b border-light-2 px-6 py-4 flex items-center justify-between">
                            <h3 class="font-semibold">班级列表</h3>
                            <p class="text-sm text-dark-2" id="class-count">共 0 个班级</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-light-1">
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">班级名称</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">描述</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">学生人数</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">创建时间</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="classes-table-body" class="divide-y divide-light-2">
                                    <tr>
                                        <td colspan="5" class="px-6 py-8 text-center text-dark-2">
                                            <div class="flex flex-col items-center">
                                                <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                                                <p class="text-sm">请先选择课程查看班级</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                
                <!-- 6. 题库管理模块 -->
                 <section id="problems" class="page-section">
                     <div class="flex items-center justify-between mb-6">
                         <div>
                             <h2 class="text-2xl font-semibold">题库管理</h2>
                             <p class="text-dark-2 mt-1">管理和维护编程题目库</p>
                         </div>
                         <button class="btn btn-primary" onclick="openAddProblemModal()">
                             <i class="fa fa-plus"></i>
                             <span>增加题目</span>
                         </button>
                     </div>

                     <!-- 题库统计卡片 -->
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="question-bank-stats">
                         <div class="stat-card">
                             <div class="flex items-start justify-between">
                                 <div>
                                     <p class="text-dark-2 text-sm">总题目数</p>
                                     <h3 class="text-2xl font-semibold mt-1" id="total-problems-stat">0</h3>
                                 </div>
                                 <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                     <i class="fa fa-file-text-o"></i>
                                 </div>
                             </div>
                         </div>

                         <div class="stat-card">
                             <div class="flex items-start justify-between">
                                 <div>
                                     <p class="text-dark-2 text-sm">编程题</p>
                                     <h3 class="text-2xl font-semibold mt-1" id="progressing-count">0</h3>
                                 </div>
                                 <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                                     <i class="fa fa-code"></i>
                                 </div>
                             </div>
                         </div>

                         <div class="stat-card">
                             <div class="flex items-start justify-between">
                                 <div>
                                     <p class="text-dark-2 text-sm">选择题</p>
                                     <h3 class="text-2xl font-semibold mt-1" id="choice-count">0</h3>
                                 </div>
                                 <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success">
                                     <i class="fa fa-list-ul"></i>
                                 </div>
                             </div>
                         </div>

                         <div class="stat-card">
                             <div class="flex items-start justify-between">
                                 <div>
                                     <p class="text-dark-2 text-sm">判断题</p>
                                     <h3 class="text-2xl font-semibold mt-1" id="judgment-count">0</h3>
                                 </div>
                                 <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                                     <i class="fa fa-check-circle-o"></i>
                                 </div>
                             </div>
                         </div>
                     </div>
                    
                    <!-- 搜索筛选区域 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-end">
                            <!-- 语言选择 -->
                            <div class="w-full lg:w-auto">
                                <label class="form-label">语言</label>
                                <select id="language-filter" class="form-select w-full lg:w-32">
                                    <option value="">全部语言</option>
                                    <option value="Python">Python</option>
                                    <option value="C++">C++</option>
                                    <option value="Java">Java</option>
                                </select>
                            </div>
    
                            <!-- 题型选择 -->
                            <div class="w-full lg:w-auto">
                                <label class="form-label">题型</label>
                                <select id="problem-type-filter" class="form-select w-full lg:w-32">
                                    <option value="">全部题型</option>
                                    <option value="progressing">编程题</option>
                                    <option value="choice">选择题</option>
                                    <option value="judgment">判断题</option>
                                </select>
                            </div>
    
                            <!-- 难度选择 -->
                            <div class="w-full lg:w-auto">
                                <label class="form-label">难度</label>
                                <select id="difficulty-filter" class="form-select w-full lg:w-32">
                                    <option value="">全部难度</option>
                                    <option value="简单">简单</option>
                                    <option value="中等">中等</option>
                                    <option value="困难">困难</option>
                                </select>
                            </div>
    
                            <!-- 知识点选择 -->
                            <div class="w-full lg:w-auto">
                                <label class="form-label">知识点</label>
                                <select id="knowledge-points-filter" class="form-select w-full lg:w-40">
                                    <option value="">全部知识点</option>
                                    <option value="数组">数组</option>
                                    <option value="字符串">字符串</option>
                                    <option value="哈希表">哈希表</option>
                                    <option value="动态规划">动态规划</option>
                                    <option value="排序算法">排序算法</option>
                                    <option value="贪心算法">贪心算法</option>
                                    <option value="深度优先搜索">深度优先搜索</option>
                                    <option value="广度优先搜索">广度优先搜索</option>
                                    <option value="二分查找">二分查找</option>
                                    <option value="树">树</option>
                                    <option value="二叉树">二叉树</option>
                                    <option value="图">图</option>
                                    <option value="堆">堆</option>
                                    <option value="栈">栈</option>
                                    <option value="队列">队列</option>
                                    <option value="链表">链表</option>
                                    <option value="位运算">位运算</option>
                                    <option value="双指针">双指针</option>
                                    <option value="滑动窗口">滑动窗口</option>
                                    <option value="递归">递归</option>
                                    <option value="分治">分治</option>
                                    <option value="数学">数学</option>
                                </select>
                            </div>
    
                            <!-- 搜索框 -->
                            <div class="flex-1 min-w-0">
                                <label class="form-label">搜索</label>
                                <div class="relative">
                                    <input type="text" id="search-filter" placeholder="搜索题目..." class="form-input pl-10 w-full" onkeypress="handleSearchKeyPress(event)">
                                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                                </div>
                            </div>
                            
                            <!-- 搜索按钮 -->
                            <button class="btn btn-primary w-full lg:w-auto" onclick="applyFilters()">
                                <i class="fa fa-search"></i>
                                <span>搜索</span>
                            </button>

                            <!-- 清空筛选按钮 -->
                            <button class="btn btn-outline w-full lg:w-auto" onclick="clearFilters()">
                                <i class="fa fa-eraser"></i>
                                <span>清空</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 题目列表 -->
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 overflow-hidden">
                        <div class="border-b border-light-2 px-6 py-4">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold">题目列表</h3>
                                <div class="text-sm text-dark-2">
                                    <span>共 <span id="total-problems">0</span> 道题目</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-light-1">
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">题目名称</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">语言</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">题型</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">难度</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">知识点</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">创建时间</th>
                                        <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="problems-table-body" class="divide-y divide-light-2">
                                    <!-- 题目数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <div class="px-6 py-4 border-t border-light-2 flex items-center justify-between" id="pagination-container" style="display: none;">
                            <p class="text-sm text-dark-2">
                                显示 <span id="current-range">0-0</span> 条，共 <span id="total-count">0</span> 条
                            </p>
                            <div class="flex gap-1">
                                <button id="prev-page" class="w-8 h-8 flex items-center justify-center rounded border border-light-2 text-dark-2 hover:border-primary hover:text-primary disabled:opacity-50 disabled:hover:border-light-2 disabled:hover:text-dark-2" disabled>
                                    <i class="fa fa-angle-left"></i>
                                </button>
                                <div id="page-numbers" class="flex gap-1">
                                    <!-- 页码按钮将动态生成 -->
                                </div>
                                <button id="next-page" class="w-8 h-8 flex items-center justify-center rounded border border-light-2 text-dark-2 hover:border-primary hover:text-primary disabled:opacity-50 disabled:hover:border-light-2 disabled:hover:text-dark-2">
                                    <i class="fa fa-angle-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
               <!-- 7. 智能出题模块 -->
                <section id="ai-problem" class="page-section">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold">智能出题</h2>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <form id="apiForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label for="knowledgePoint" class="block text-sm font-medium text-dark-2 mb-1">知识点</label>
                                    <select id="knowledgePoint" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors">
                                        <option value="数组">数组</option>
                                        <option value="字符串">字符串</option>
                                        <option value="哈希表">哈希表</option>
                                        <option value="动态规划" selected>动态规划</option>
                                        <option value="排序算法">排序算法</option>
                                        <option value="贪心算法">贪心算法</option>
                                        <option value="深度优先搜索">深度优先搜索</option>
                                        <option value="广度优先搜索">广度优先搜索</option>
                                        <option value="二分查找">二分查找</option>
                                        <option value="树">树</option>
                                        <option value="二叉树">二叉树</option>
                                        <option value="图">图</option>
                                        <option value="堆">堆</option>
                                        <option value="栈">栈</option>
                                        <option value="队列">队列</option>
                                        <option value="链表">链表</option>
                                        <option value="位运算">位运算</option>
                                        <option value="双指针">双指针</option>
                                        <option value="滑动窗口">滑动窗口</option>
                                        <option value="递归">递归</option>
                                        <option value="分治">分治</option>
                                        <option value="数学">数学</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="difficulty" class="block text-sm font-medium text-dark-2 mb-1">难度级别</label>
                                    <select id="difficulty" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors">
                                        <option value="easy">简单</option>
                                        <option value="medium" selected>中等</option>
                                        <option value="hard">困难</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="language" class="block text-sm font-medium text-dark-2 mb-1">编程语言</label>
                                    <select id="language" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors">
                                        <option value="Python" selected>Python</option>
                                        <option value="C++">C++</option>
                                        <option value="Java">Java</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="problemType" class="block text-sm font-medium text-dark-2 mb-1">题目类型</label>
                                    <select id="problemType" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors" onchange="onProblemTypeChange()">
                                        <option value="programming" selected>编程题</option>
                                        <option value="choice">选择题</option>
                                        <option value="judgment">判断题</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group mt-6">
                                <label for="title" class="block text-sm font-medium text-dark-2 mb-1">题目标题</label>
                                <input type="text" id="title" placeholder="例如：两数之和" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors">
                            </div>
                            
                            <div class="form-group mt-4">
                                <label for="customRequirements" class="block text-sm font-medium text-dark-2 mb-1">自定义要求（每行一个要求）</label>
                                <textarea id="customRequirements" placeholder="例如：
- 要求代码简洁
- 包含详细注释
- 考虑边界情况
- 使用特定算法
- 限制时间复杂度" class="w-full px-4 py-2 border border-light-2 rounded-lg focus:outline-none focus:border-primary transition-colors" rows="4"></textarea>
                            </div>
                        </form>
                        
                        <div class="flex flex-wrap gap-3 mt-6">
                            <button id="testBtn" class="btn btn-primary">生成题目</button>
                            <button id="clearBtn" class="btn btn-outline">清空结果</button>
                            <button id="selfTestBtn" class="btn btn-warning">AI自测</button>
                            <button id="importDbBtn" class="btn btn-success">导入数据库</button>
                        </div>
                        
                        <div class="loading mt-6" id="loadingIndicator" style="display: none;">
                            <svg width="40" height="40" viewBox="0 0 40 40" class="mx-auto">
                                <circle cx="20" cy="20" r="18" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="84.78" stroke-dashoffset="42.39">
                                    <animate attributeName="stroke-dashoffset" from="84.78" to="0" dur="1s" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-dasharray" from="84.78" to="84.78" dur="1s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <p class="text-center mt-3 text-dark-2">正在生成题目，请稍候...</p>
                        </div>
                        
                        <div class="result mt-6" id="resultArea" style="background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 20px;">
                            <p class="text-dark-2">请填写表单并点击上方按钮开始智能生成题目</p>
                        </div>
                    </div>
                </section>
                
                <!-- 8. 个人资料页面 -->
                <section id="profile" class="page-section">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold">个人资料</h2>
                            <p class="text-gray-500 mt-1">查看和编辑您的个人信息</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 p-6">
                        <div class="max-w-2xl mx-auto">
                            <div class="text-center mb-8">
                                <img src="https://picsum.photos/id/1005/100/100" alt="教师头像" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-light-2">
                                <h3 class="text-xl font-semibold">{{ user.username }}</h3>
                                <p class="text-dark-2">教师</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-semibold text-dark mb-4 pb-2 border-b border-light-2">基本信息</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">用户名</p>
                                            <p class="font-medium">{{ user.username }}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">手机号</p>
                                            <p class="font-medium">{{ user.telenum if user.telenum else '未设置' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">邮箱</p>
                                            <p class="font-medium">{{ user.email if user.email else '未设置' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">身份</p>
                                            <p class="font-medium">教师</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-dark mb-4 pb-2 border-b border-light-2">教学信息</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">用户ID</p>
                                            <p class="font-medium">{{ user.id }}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">课程分配</p>
                                            <p class="font-medium">{{ user.course_assignment if user.course_assignment else '未分配' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-dark-2 mb-1">状态</p>
                                            <span class="px-2 py-1 text-xs rounded-full bg-success/10 text-success">正常</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-light-2">
                                <h4 class="font-semibold text-dark mb-4">操作</h4>
                                <div class="flex gap-3">
                                    <button class="btn btn-outline" onclick="openEditProfileModal()">
                                        <i class="fa fa-edit"></i>
                                        <span>编辑信息</span>
                                    </button>
                                    <button class="btn btn-outline" onclick="navigateTo('password-reset-self')">
                                        <i class="fa fa-key"></i>
                                        <span>修改密码</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                
                <!-- 10. 修改密码页面 -->
                <section id="password-reset-self" class="page-section">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold">修改密码</h2>
                            <p class="text-gray-500 mt-1">更新您的账户密码</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-light-2 p-6 max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa fa-key text-primary text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-dark">修改密码</h3>
                            <p class="text-dark-2 mt-1">为了账户安全，请定期更新密码</p>
                        </div>

                        <form id="change-password-form" class="space-y-6">
                            <div>
                                <label class="form-label">原密码 <span class="text-danger">*</span></label>
                                <input type="password" id="old-password" class="form-input" placeholder="请输入原密码" required>
                            </div>

                            <div>
                                <label class="form-label">新密码 <span class="text-danger">*</span></label>
                                <input type="password" id="new-password" class="form-input" placeholder="请输入新密码" required>
                                <div class="mt-2 text-xs text-dark-2">
                                    <p>密码要求：</p>
                                    <ul class="list-disc list-inside mt-1 space-y-1">
                                        <li id="password-length" class="text-danger">至少6位字符</li>
                                    </ul>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">确认新密码 <span class="text-danger">*</span></label>
                                <input type="password" id="confirm-password" class="form-input" placeholder="请再次输入新密码" required>
                                <div class="mt-1 text-xs text-danger hidden" id="password-match-error">两次输入的密码不一致</div>
                            </div>

                            <button type="submit" class="btn btn-primary w-full" id="submit-password-btn">
                                <i class="fa fa-save"></i>
                                <span>修改密码</span>
                            </button>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // API基础URL
        const API_BASE = '/api';
        
        // 页面跳转核心函数
        function navigateTo(pageId, param = '') {
            // 隐藏所有页面
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // 如果有参数，这里可以处理参数逻辑
                if (param) {
                    console.log(`页面 ${pageId} 接收参数: ${param}`);
                    // 可以根据需要在这里添加处理参数的代码
                }
                
                // 页面切换时加载对应数据
                loadPageData(pageId);
            }
            
            // 更新导航项选中状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === `#${pageId}`) {
                    item.classList.add('active');
                }
            });
            
            // 更新URL哈希
            history.pushState(null, null, `#${pageId}`);
            
            // 阻止默认行为
            return false;
        }
        
        // 加载页面数据
        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'assignment':
                    loadAssignmentData();
                    break;
                case 'grading':
                    loadGradingData();
                    break;
                // 其他页面可以根据需要添加数据加载逻辑
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/teacher/dashboard/stats`);
                const result = await response.json();
                
                if (result.success) {
                    updateStatCards({
                        totalAssignments: result.data.total_assignments,
                        pendingGrading: result.data.pending_grading,
                        completionRate: result.data.completion_rate,
                        averageScore: result.data.average_score
                    });
                    
                    // 更新侧边栏课程信息
                    updateCourseInfo(result.data.course_assignment, result.data.student_count);
                } else {
                    console.error('获取仪表盘数据失败:', result.message);
                    // 使用模拟数据作为后备
                    updateStatCards({
                        totalAssignments: 12,
                        pendingGrading: 28,
                        completionRate: 78,
                        averageScore: 82.5
                    });
                }
                
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
                // 使用模拟数据作为后备
                updateStatCards({
                    totalAssignments: 12,
                    pendingGrading: 28,
                    completionRate: 78,
                    averageScore: 82.5
                });
            }
        }
        
        // 更新课程信息
        function updateCourseInfo(course, studentCount) {
            const courseInfo = document.querySelector('.bg-secondary\\/5');
            if (courseInfo) {
                const courseName = courseInfo.querySelector('p:first-child');
                const studentCountEl = courseInfo.querySelector('p:nth-child(2)');
                
                if (courseName) courseName.textContent = course || '未分配课程';
                if (studentCountEl) studentCountEl.textContent = `班级人数: ${studentCount || 0}人`;
            }
        }
        
        // 更新统计卡片
        function updateStatCards(stats) {
            const statCards = document.querySelectorAll('.stat-card');
            if (statCards.length >= 4) {
                statCards[0].querySelector('h3').textContent = stats.totalAssignments || 0;
                statCards[1].querySelector('h3').textContent = stats.pendingGrading || 0;
                statCards[2].querySelector('h3').textContent = `${stats.completionRate || 0}%`;
                statCards[3].querySelector('h3').textContent = stats.averageScore || 0;
            }
        }
        
        // 加载作业数据
        async function loadAssignmentData() {
            try {
                const response = await fetch(`${API_BASE}/teacher/assignments`);
                const result = await response.json();
                
                if (result.success) {
                    updateAssignmentTable(result.data);
                } else {
                    console.error('获取作业列表失败:', result.message);
                    // 使用模拟数据作为后备
                    updateAssignmentTable([
                        {
                            id: 1,
                            name: '数组与字符串练习',
                            publish_date: '2023-06-01',
                            deadline: '2023-06-07',
                            problem_count: 5,
                            submitted: '36/45',
                            completion_rate: 80
                        },
                        {
                            id: 2,
                            name: '链表操作',
                            publish_date: '2023-05-25',
                            deadline: '2023-05-31',
                            problem_count: 4,
                            submitted: '41/45',
                            completion_rate: 91
                        },
                        {
                            id: 3,
                            name: '栈与队列应用',
                            publish_date: '2023-05-18',
                            deadline: '2023-05-24',
                            problem_count: 6,
                            submitted: '32/45',
                            completion_rate: 71
                        }
                    ]);
                }
                
            } catch (error) {
                console.error('加载作业数据失败:', error);
                // 使用模拟数据作为后备
                updateAssignmentTable([
                    {
                        id: 1,
                        name: '数组与字符串练习',
                        publish_date: '2023-06-01',
                        deadline: '2023-06-07',
                        problem_count: 5,
                        submitted: '36/45',
                        completion_rate: 80
                    },
                    {
                        id: 2,
                        name: '链表操作',
                        publish_date: '2023-05-25',
                        deadline: '2023-05-31',
                        problem_count: 4,
                        submitted: '41/45',
                        completion_rate: 91
                    },
                    {
                        id: 3,
                        name: '栈与队列应用',
                        publish_date: '2023-05-18',
                        deadline: '2023-05-24',
                        problem_count: 6,
                        submitted: '32/45',
                        completion_rate: 71
                    }
                ]);
            }
        }
        
        // 更新作业表格
        function updateAssignmentTable(assignments) {
            const tbody = document.getElementById('assignment-table-body');
            if (!tbody) return;

            if (assignments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-book text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">暂无作业数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = assignments.map(assignment => `
                <tr class="hover:bg-light-1/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${assignment.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${assignment.classes && assignment.classes !== '未分配班级' ? `
                            <div class="flex flex-wrap gap-1">
                                ${assignment.classes.split(',').slice(0, 3).map(cls => `<span class="badge bg-primary/10 text-primary">${cls.trim()}</span>`).join('')}
                                ${assignment.classes.split(',').length > 3 ? `<span class="badge bg-light-2 text-dark-2">+${assignment.classes.split(',').length - 3}</span>` : ''}
                            </div>
                        ` : '<span class="text-sm text-dark-2">未分配班级</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${assignment.publish_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${assignment.deadline}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${assignment.problem_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${assignment.submitted}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <div class="w-24 bg-light-2 rounded-full h-2">
                                <div class="bg-success h-2 rounded-full" style="width: ${assignment.completion_rate}%"></div>
                            </div>
                            <span class="text-sm">${assignment.completion_rate}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            <button class="text-primary hover:underline" onclick="viewAssignment(${assignment.id})">查看</button>
                            <button class="text-dark-2 hover:text-primary" onclick="editAssignment(${assignment.id})">编辑</button>
                            <button class="text-dark-2 hover:text-primary" onclick="viewAssignmentStats(${assignment.id})">统计</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // 加载批改数据
        async function loadGradingData() {
            try {
                const response = await fetch(`${API_BASE}/teacher/submissions/pending`);
                const result = await response.json();

                if (result.success) {
                    // 重置原始数据
                    originalGradingData = [...result.data];
                    updateGradingTable(result.data);
                } else {
                    console.error('获取待批改作业列表失败:', result.message);
                    // 显示错误信息，不使用mock数据
                    showGradingError('获取待批改作业列表失败: ' + (result.message || '未知错误'));
                }

            } catch (error) {
                console.error('加载批改数据失败:', error);
                // 显示错误信息，不使用mock数据
                showGradingError('网络错误，请检查连接后重试');
            }
        }

        // 显示批改页面错误信息
        function showGradingError(message) {
            const tbody = document.getElementById('grading-table-body');
            if (!tbody) return;

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                        <div class="flex flex-col items-center">
                            <i class="fa fa-exclamation-triangle text-4xl text-danger mb-3"></i>
                            <p class="text-sm text-danger mb-2">${message}</p>
                            <button class="btn btn-primary" onclick="loadGradingData()">
                                <i class="fa fa-refresh"></i>
                                <span>重新加载</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            // 清空原始数据
            originalGradingData = [];
        }

        // 加载教师教授的课程
        async function loadTeacherCourses() {
            try {
                const response = await fetch(`${API_BASE}/teachers/current/courses`);
                const result = await response.json();

                if (result.success) {
                    populateCourseSelect(result.data);
                } else {
                    console.error('获取教师课程失败:', result.message);
                    showNotification('获取课程列表失败', 'error');
                }

            } catch (error) {
                console.error('加载教师课程失败:', error);
                showNotification('加载课程列表失败', 'error');
            }
        }

        // 填充课程选择下拉框
        function populateCourseSelect(courses) {
            const courseSelect = document.getElementById('course-select');
            if (!courseSelect) return;
            
            // 清空现有选项（保留第一个"请选择课程..."选项）
            while (courseSelect.options.length > 1) {
                courseSelect.remove(1);
            }
            
            if (courses.length === 0) {
                // 如果没有课程，禁用选择框
                courseSelect.disabled = true;
                showNotification('您目前没有教授任何课程', 'info');
                return;
            }
            
            // 添加课程选项
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelect.appendChild(option);
            });
            
            // 如果只有一个课程，自动选择它
            if (courses.length === 1) {
                courseSelect.value = courses[0].id;
                loadCourseClasses(courses[0].id);
            }
        }

        // 加载课程的班级列表
        async function loadCourseClasses(courseId) {
            if (!courseId) {
                resetClassTable();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/classes/current?course_id=${courseId}`);
                const result = await response.json();

                if (result.success) {
                    updateClassTable(result.data);
                    updateCourseInfo(courseId);
                } else {
                    console.error('获取班级列表失败:', result.message);
                    resetClassTable();
                    showNotification('获取班级列表失败', 'error');
                }

            } catch (error) {
                console.error('加载班级列表失败:', error);
                resetClassTable();
                showNotification('加载班级列表失败', 'error');
            }
        }

        // 更新课程信息显示
        async function updateCourseInfo(courseId) {
            try {
                const response = await fetch(`${API_BASE}/teachers/current/courses`);
                const result = await response.json();

                if (result.success) {
                    const course = result.data.find(c => c.id == courseId);
                    if (course) {
                        const courseInfo = document.getElementById('course-info');
                        const courseName = document.getElementById('selected-course-name');
                        const courseLanguage = document.getElementById('selected-course-language');

                        courseInfo.classList.remove('hidden');
                        courseName.textContent = course.name;
                        courseLanguage.textContent = course.language || '编程语言';
                    }
                }

            } catch (error) {
                console.error('获取课程详情失败:', error);
            }
        }

        // 更新班级表格
        function updateClassTable(classes) {
            const tbody = document.getElementById('classes-table-body');
            const classCount = document.getElementById('class-count');
            
            if (!tbody || !classCount) return;
            
            if (classes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">该课程下暂无班级</p>
                            </div>
                        </td>
                    </tr>
                `;
                classCount.textContent = '共 0 个班级';
                return;
            }
            
            tbody.innerHTML = classes.map(cls => `
                <tr class="hover:bg-light-1/50 transition-colors" data-class-id="${cls.id}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${cls.class_name}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-dark-2 max-w-xs truncate">${cls.description || '无描述'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm student-count">
                        <div class="flex items-center">
                            <i class="fa fa-spinner fa-spin text-light-3 mr-2"></i>
                            <span>加载中...</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${formatDate(cls.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            <button class="text-primary hover:underline" onclick="viewClassStudents(${cls.id}, '${cls.class_name}')">详情</button>
                            <button class="text-dark-2 hover:text-primary" onclick="editClass(${cls.id})">编辑</button>
                            <button class="text-danger hover:underline" onclick="deleteClass(${cls.id})">删除</button>
                            <button class="text-success hover:underline" onclick="openAddStudentsModal(${cls.id}, '${cls.course_id}')">添加学生</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            classCount.textContent = `共 ${classes.length} 个班级`;
            
            // 为每个班级加载学生人数
            classes.forEach(cls => {
                loadClassStudentCount(cls.id).then(studentCount => {
                    const studentCountCell = document.querySelector(`tr[data-class-id="${cls.id}"] .student-count`);
                    if (studentCountCell) {
                        studentCountCell.innerHTML = `
                            <a href="javascript:void(0)" onclick="viewClassStudents(${cls.id}, '${cls.class_name}')" 
                               class="text-primary hover:underline font-medium">
                                ${studentCount} 人
                            </a>
                        `;
                    }
                }).catch(error => {
                    console.error('加载班级学生人数失败:', error);
                    const studentCountCell = document.querySelector(`tr[data-class-id="${cls.id}"] .student-count`);
                    if (studentCountCell) {
                        studentCountCell.innerHTML = `
                            <span class="text-dark-2">0 人</span>
                        `;
                    }
                });
            });
        }

        // 加载班级学生人数
        async function loadClassStudentCount(classId) {
            try {
                const response = await fetch(`${API_BASE}/classes/${classId}/student-count`);
                const result = await response.json();
                
                if (result.success) {
                    return result.data.student_count;
                } else {
                    console.error('获取班级学生人数失败:', result.message);
                    return 0;
                }
            } catch (error) {
                console.error('加载班级学生人数失败:', error);
                return 0;
            }
        }

        // 实时更新班级学生人数显示
        function updateClassStudentCountDisplay(classId, studentCount) {
            const studentCountCell = document.querySelector(`tr[data-class-id="${classId}"] .student-count`);
            if (studentCountCell) {
                const className = document.querySelector(`tr[data-class-id="${classId}"] .font-medium`).textContent;
                studentCountCell.innerHTML = `
                    <a href="javascript:void(0)" onclick="viewClassStudents(${classId}, '${className}')" 
                       class="text-primary hover:underline font-medium">
                        ${studentCount} 人
                    </a>
                `;
            }
        }

        // 查看班级学生详情
        async function viewClassStudents(classId, className) {
            try {
                const response = await fetch(`${API_BASE}/classes/${classId}/students`);
                const result = await response.json();
                
                if (result.success) {
                    showClassStudentsModal(className, result.data);
                } else {
                    showNotification('获取班级学生列表失败', 'error');
                }
            } catch (error) {
                console.error('加载班级学生详情失败:', error);
                showNotification('加载班级学生详情失败', 'error');
            }
        }

        // 显示班级学生模态框
        function showClassStudentsModal(className, students) {
            const modal = document.getElementById('class-students-modal');
            const modalTitle = document.getElementById('class-students-title');
            const modalBody = document.getElementById('class-students-body');
            
            if (!modal || !modalTitle || !modalBody) return;
            
            modalTitle.textContent = `${className} - 学生列表 (${students.length}人)`;
            
            if (students.length === 0) {
                modalBody.innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                        <p class="text-sm">该班级暂无学生</p>
                    </div>
                `;
            } else {
                modalBody.innerHTML = `
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-light-1">
                                    <th class="text-left px-4 py-2 text-xs font-medium text-dark-2 uppercase tracking-wider">学生姓名</th>
                                    <th class="text-left px-4 py-2 text-xs font-medium text-dark-2 uppercase tracking-wider">学号</th>
                                    <th class="text-left px-4 py-2 text-xs font-medium text-dark-2 uppercase tracking-wider">邮箱</th>
                                    <th class="text-left px-4 py-2 text-xs font-medium text-dark-2 uppercase tracking-wider">手机号</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-light-2">
                                ${students.map(student => `
                                    <tr class="hover:bg-light-1/50 transition-colors">
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="font-medium">${student.username}</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-dark-2">${student.student_id || '未设置'}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-dark-2">${student.email || '未设置'}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-dark-2">${student.telenum}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        // 关闭班级学生模态框
        function closeClassStudentsModal() {
            const modal = document.getElementById('class-students-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // 重置班级表格
        function resetClassTable() {
            const tbody = document.getElementById('classes-table-body');
            const classCount = document.getElementById('class-count');
            const courseInfo = document.getElementById('course-info');
            
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">请先选择课程查看班级</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            if (classCount) {
                classCount.textContent = '共 0 个班级';
            }
            
            if (courseInfo) {
                courseInfo.classList.add('hidden');
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 打开添加班级模态框
        function openAddClassModal() {
            const courseSelect = document.getElementById('course-select');
            const selectedCourseId = courseSelect.value;
            
            if (!selectedCourseId) {
                showNotification('请先选择课程', 'warning');
                return;
            }
            
            // 获取选中的课程名称
            const selectedCourseName = courseSelect.options[courseSelect.selectedIndex].text;
            
            // 填充模态框
            document.getElementById('add-class-course-name').textContent = selectedCourseName;
            document.getElementById('add-class-course-id').value = selectedCourseId;
            document.getElementById('add-class-name').value = '';
            document.getElementById('add-class-description').value = '';
            
            // 显示模态框
            document.getElementById('add-class-modal').classList.remove('hidden');
        }

        // 关闭添加班级模态框
        function closeAddClassModal() {
            document.getElementById('add-class-modal').classList.add('hidden');
        }

        // 提交添加班级表单
        async function submitAddClass() {
            const formData = {
                class_name: document.getElementById('add-class-name').value.trim(),
                description: document.getElementById('add-class-description').value.trim(),
                course_id: document.getElementById('add-class-course-id').value
            };
            
            if (!formData.class_name) {
                showNotification('班级名称不能为空', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('班级创建成功', 'success');
                    closeAddClassModal();
                    // 重新加载班级列表
                    loadCourseClasses(formData.course_id);
                } else {
                    showNotification(result.message || '班级创建失败', 'error');
                }
                
            } catch (error) {
                console.error('创建班级失败:', error);
                showNotification('创建班级失败，请重试', 'error');
            }
        }

        
        // 批改作业搜索筛选相关变量
        let originalGradingData = [];
        let currentGradingFilters = {
            student_name: '',
            assignment_name: ''
        };

        // 处理批改作业搜索按键事件
        function handleGradingSearchKeyPress(event) {
            if (event.key === 'Enter') {
                applyGradingFilters();
            }
        }

        // 应用批改作业搜索筛选
        function applyGradingFilters() {
            const studentSearch = document.getElementById('grading-student-search').value.trim();
            const assignmentSearch = document.getElementById('grading-assignment-search').value.trim();

            currentGradingFilters = {
                student_name: studentSearch,
                assignment_name: assignmentSearch
            };

            // 如果有搜索条件，进行前端筛选
            if (studentSearch || assignmentSearch) {
                const filteredData = originalGradingData.filter(submission => {
                    const matchStudent = !studentSearch ||
                        submission.student_name.toLowerCase().includes(studentSearch.toLowerCase()) ||
                        submission.student_id.toString().toLowerCase().includes(studentSearch.toLowerCase());
                    const matchAssignment = !assignmentSearch ||
                        submission.assignment_name.toLowerCase().includes(assignmentSearch.toLowerCase());

                    return matchStudent && matchAssignment;
                });
                updateGradingTable(filteredData);
            } else {
                // 没有搜索条件时，重新加载数据
                loadGradingData();
            }
        }

        // 清空批改作业搜索筛选
        function clearGradingFilters() {
            document.getElementById('grading-student-search').value = '';
            document.getElementById('grading-assignment-search').value = '';

            currentGradingFilters = {
                student_name: '',
                assignment_name: ''
            };

            // 重新加载数据
            loadGradingData();
        }

        // 更新批改表格 - 按作业聚合显示
        function updateGradingTable(submissions) {
            const tbody = document.getElementById('grading-table-body');
            if (!tbody) return;

            // 保存原始数据用于筛选
            if (submissions.length > 0 && originalGradingData.length === 0) {
                originalGradingData = [...submissions];
            }

            if (submissions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-check-circle text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">暂无待批改作业</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = submissions.map(submission => `
                <tr class="hover:bg-light-1/50 transition-colors">
<td class="px-6 py-4 whitespace-nowrap">
    <div class="flex items-center gap-3">
        <img src="https://picsum.photos/id/64/40/40" alt="学生头像" class="w-8 h-8 rounded-full">
        <div>
            <div class="font-medium">${submission.student_name}</div>
            <div class="text-xs text-dark-2">学号: ${submission.student_id}</div>
        </div>
    </div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm">${submission.assignment_name}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${submission.latest_submit_time || submission.submit_time}</td>
<td class="px-6 py-4 whitespace-nowrap">
    <div class="flex flex-col gap-1">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium">${submission.completed_problems}/${submission.total_questions}</span>
            <span class="text-xs text-dark-2">(${submission.completion_rate}%)</span>
        </div>
        <div class="w-20 bg-light-2 rounded-full h-1.5">
            <div class="h-1.5 rounded-full transition-all duration-300"
                 style="width: ${submission.completion_rate}%;
                        background-color: ${submission.completion_status === 'completed' ? '#10B981' :
                                           submission.completion_status === 'partial' ? '#F59E0B' : '#EF4444'}">
            </div>
        </div>
        <div class="text-xs text-dark-2">
            待批改: ${submission.pending_count} 题
        </div>
    </div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
    <span class="px-2 py-1 text-xs rounded-full ${
        submission.completion_status === 'completed' ? 'bg-success/10 text-success' :
        submission.completion_status === 'partial' ? 'bg-warning/10 text-warning' :
        'bg-danger/10 text-danger'
    }">${submission.completion_status === 'completed' ? '已完成' :
         submission.completion_status === 'partial' ? '部分完成' : '未完成'}</span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm">
    <button class="text-primary hover:underline" onclick="gradeSubmission('${submission.student_id}_${submission.homework_id}')">批改</button>
</td>
</tr>
            `).join('');
        }

        // 批改作业功能 - 按作业批改所有题目
        function gradeSubmission(submissionId) {
            // 解析submissionId，格式为：student_id_homework_id
            const parts = submissionId.split('_');
            if (parts.length !== 2) {
                showNotification('作业ID格式错误', 'error');
                return;
            }

            const [studentId, homeworkId] = parts;

            // 显示批改模态框
            document.getElementById('grade-submission-modal').classList.remove('hidden');

            // 显示加载状态
            const content = document.getElementById('grade-submission-content');
            content.innerHTML = `
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载作业答题详情...</p>
                </div>
            `;

            // 加载学生作业的所有答题详情
            loadStudentAssignmentDetail(studentId, homeworkId);
        }

        // 加载学生作业的所有答题详情
        async function loadStudentAssignmentDetail(studentId, homeworkId) {
            try {
                const response = await fetch(`${API_BASE}/teacher/assignment/${studentId}/${homeworkId}/submissions`);
                const result = await response.json();

                if (result.success) {
                    displayAssignmentGradingDetail(result.data);
                } else {
                    showNotification(result.message || '获取作业答题详情失败', 'error');
                    closeGradeSubmissionModal();
                }
            } catch (error) {
                console.error('加载作业答题详情失败:', error);
                showNotification('加载作业答题详情失败', 'error');
                closeGradeSubmissionModal();
            }
        }

        // 显示作业批改详情 - 显示整个作业的所有题目
        function displayAssignmentGradingDetail(assignmentData) {
            const content = document.getElementById('grade-submission-content');

            // 设置模态框标题
            const title = document.getElementById('grade-submission-title');
            title.textContent = `${assignmentData.student_name} - ${assignmentData.assignment_name}`;

            // 构建作业概览信息
            let html = `
                <div class="space-y-6">
                    <!-- 作业概览信息 -->
                    <div class="bg-light-1 p-4 rounded-lg">
                        <h4 class="font-semibold text-dark mb-3">作业概览</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><span class="text-dark-2">学生姓名：</span><span class="font-medium">${assignmentData.student_name}</span></div>
                            <div><span class="text-dark-2">学号：</span><span class="font-medium">${assignmentData.student_id}</span></div>
                            <div><span class="text-dark-2">作业名称：</span><span class="font-medium">${assignmentData.assignment_name}</span></div>
                            <div><span class="text-dark-2">完成进度：</span><span class="font-medium">${assignmentData.completed_problems}/${assignmentData.total_questions} (${assignmentData.completion_rate}%)</span></div>
                            <div><span class="text-dark-2">待批改题目：</span><span class="font-medium text-warning">${assignmentData.pending_count} 题</span></div>
                            <div><span class="text-dark-2">最新提交：</span><span class="font-medium">${assignmentData.latest_submit_time || '无'}</span></div>
                        </div>
                    </div>
            `;

            // 显示每个题目的详情
            if (assignmentData.submissions && assignmentData.submissions.length > 0) {
                assignmentData.submissions.forEach((submission, index) => {
                    html += `
                        <!-- 题目 ${index + 1} -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-dark">题目 ${index + 1}: ${submission.question_title || '无标题'}</h4>
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    submission.is_graded ? 'bg-success/10 text-success' : 'bg-warning/10 text-warning'
                                }">${submission.is_graded ? '已批改' : '待批改'}</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                                <div><span class="text-dark-2">题目类型：</span><span class="font-medium">${getQuestionTypeText(submission.question_type)}</span></div>
                                <div><span class="text-dark-2">提交时间：</span><span class="font-medium">${submission.submit_time || '无'}</span></div>
                                <div><span class="text-dark-2">答题状态：</span><span class="font-medium">${getStatusText(submission.status)}</span></div>
                                <div><span class="text-dark-2">得分：</span><span class="font-medium">${submission.score !== null ? submission.score + '分' : '未评分'}</span></div>
                            </div>
                    `;

                    // 题目描述
                    if (submission.question_description) {
                        html += `
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">题目描述</h5>
                                <p class="text-dark-2 text-sm whitespace-pre-line">${submission.question_description}</p>
                            </div>
                        `;
                    }

                    // 根据题目类型显示不同内容
                    if (submission.question_type === 'progressing') {
                        // 编程题
                        html += `
                            <!-- 学生代码 -->
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">学生代码</h5>
                                <pre class="bg-dark text-white p-3 rounded text-sm overflow-x-auto"><code class="language-${submission.code_language ? submission.code_language.toLowerCase() : 'text'}">${submission.code || '无代码'}</code></pre>
                            </div>

                            <!-- 运行结果 -->
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">运行结果</h5>
                                <p class="text-dark-2 text-sm whitespace-pre-line">${submission.execution_result || '无运行结果'}</p>
                            </div>
                        `;

                        // 解题思路
                        if (submission.solution_idea) {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-dark mb-2">解题思路</h5>
                                    <p class="text-dark-2 text-sm whitespace-pre-line">${submission.solution_idea}</p>
                                </div>
                            `;
                        }

                        // 参考代码
                        if (submission.correct_answer) {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-dark mb-2">参考代码</h5>
                                    <pre class="bg-dark text-white p-3 rounded text-sm overflow-x-auto"><code class="language-${submission.code_language ? submission.code_language.toLowerCase() : 'text'}">${submission.correct_answer}</code></pre>
                                </div>
                            `;
                        }

                    } else if (submission.question_type === 'choice') {
                        // 选择题
                        html += `
                            <!-- 学生答案 -->
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">学生答案</h5>
                                <p class="text-lg font-bold ${submission.is_correct ? 'text-success' : 'text-danger'}">
                                    ${submission.student_answer || '未作答'}
                                </p>
                            </div>
                        `;

                        // 选项信息
                        if (submission.options) {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-dark mb-2">选项</h5>
                                    <div class="space-y-2">
                            `;

                            const options = typeof submission.options === 'string' ? JSON.parse(submission.options) : submission.options;

                            // 调试日志
                            console.log('批改作业页 - 原始options:', submission.options);
                            console.log('批改作业页 - 解析后options:', options);
                            console.log('批改作业页 - options类型:', typeof options);
                            console.log('批改作业页 - Array.isArray(options):', Array.isArray(options));
                            console.log('批改作业页 - student_answer:', submission.student_answer);
                            console.log('批改作业页 - correct_answer:', submission.correct_answer);

                            // 映射函数：将数字索引转换为字母标签
                            function getOptionLabel(index) {
                                return String.fromCharCode(65 + parseInt(index)); // 0->A, 1->B, 2->C, 3->D
                            }

                            if (Array.isArray(options)) {
                                console.log('批改作业页 - 使用数组格式处理');
                                // 新格式：数组
                                options.forEach((value, index) => {
                                    const key = index.toString();
                                    const optionLabel = getOptionLabel(index);
                                    const isStudentAnswer = submission.student_answer === key;
                                    const isCorrectAnswer = submission.correct_answer === key;
                                    console.log(`批改作业页 - 选项${index}: key=${key}, value="${value}", isStudentAnswer=${isStudentAnswer}, isCorrectAnswer=${isCorrectAnswer}`);
                                    let className = 'bg-light-1';

                                    if (isCorrectAnswer) {
                                        className = 'bg-success/10 border border-success/20';
                                    } else if (isStudentAnswer && !isCorrectAnswer) {
                                        className = 'bg-danger/10 border border-danger/20';
                                    }

                                    html += `
                                        <div class="flex items-start gap-2 p-2 rounded ${className}">
                                            <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                            <span class="text-sm">${value}</span>
                                            ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                            ${isStudentAnswer && !isCorrectAnswer ? '<span class="text-danger text-xs ml-2">✗ 学生选择</span>' : ''}
                                        </div>
                                    `;
                                });
                                console.log('批改作业页 - 生成的HTML长度:', html.length);
                            } else {
                                // 旧格式：对象（兼容性保留）
                                Object.entries(options).forEach(([key, value], index) => {
                                    const optionLabel = getOptionLabel(index);
                                    const isStudentAnswer = submission.student_answer === key;
                                    const isCorrectAnswer = submission.correct_answer === key;
                                    let className = 'bg-light-1';

                                    if (isCorrectAnswer) {
                                        className = 'bg-success/10 border border-success/20';
                                    } else if (isStudentAnswer && !isCorrectAnswer) {
                                        className = 'bg-danger/10 border border-danger/20';
                                    }

                                    html += `
                                        <div class="flex items-start gap-2 p-2 rounded ${className}">
                                            <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                            <span class="text-sm">${value}</span>
                                            ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                            ${isStudentAnswer && !isCorrectAnswer ? '<span class="text-danger text-xs ml-2">✗ 学生选择</span>' : ''}
                                        </div>
                                    `;
                                });
                            }

                            html += `
                                    </div>
                                </div>
                            `;
                        }

                    } else if (submission.question_type === 'judgment') {
                        // 判断题
                        html += `
                            <!-- 学生答案 -->
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">学生答案</h5>
                                <p class="text-lg font-bold ${submission.is_correct ? 'text-success' : 'text-danger'}">
                                    ${submission.student_answer === 'true' ? '✓ 对' : submission.student_answer === 'false' ? '✗ 错' : '未作答'}
                                </p>
                            </div>

                            <!-- 正确答案 -->
                            <div class="mb-4">
                                <h5 class="font-medium text-dark mb-2">正确答案</h5>
                                <p class="text-lg font-bold text-success">
                                    ${submission.correct_answer === true ? '✓ 对' : '✗ 错'}
                                </p>
                            </div>
                        `;
                    }

                    // 评分区域（如果未批改）
                    if (!submission.is_graded) {
                        html += `
                            <!-- 评分区域 -->
                            <div class="bg-primary/5 p-4 rounded-lg border border-primary/20">
                                <h5 class="font-semibold text-dark mb-3">评分与评价</h5>
                                <form id="grading-form-${submission.question_id}" class="space-y-3">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="form-label text-xs">分数 <span class="text-danger">*</span></label>
                                            <input type="number" id="grade-score-${submission.question_id}" class="form-input text-sm" placeholder="请输入分数" min="0" max="100" required>
                                            <p class="text-xs text-dark-2 mt-1">分数范围：0-100</p>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="form-label text-xs">教师评价</label>
                                        <textarea id="grade-comment-${submission.question_id}" class="form-input text-sm" rows="3" placeholder="请输入对学生作业的评价和建议..."></textarea>
                                    </div>

                                    <div class="flex gap-2 pt-3">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="submitGrade(${assignmentData.student_id}, ${assignmentData.homework_id}, ${submission.question_id})">
                                            <i class="fa fa-save"></i>
                                            <span>提交评分</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        `;
                    } else {
                        // 显示已批改信息
                        html += `
                            <div class="bg-success/5 p-4 rounded-lg border border-success/20">
                                <h5 class="font-semibold text-success mb-2">已批改</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-dark-2">得分：</span><span class="font-medium text-success">${submission.score}分</span></div>
                                    <div><span class="text-dark-2">批改时间：</span><span class="font-medium">${submission.grade_time || '无'}</span></div>
                                </div>
                                ${submission.comment ? `<div class="mt-2"><span class="text-dark-2">教师评价：</span><span class="font-medium">${submission.comment}</span></div>` : ''}
                            </div>
                        `;
                    }

                    html += `
                        </div>
                    `;
                });
            } else {
                html += `
                    <!-- 无题目提示 -->
                    <div class="bg-white border border-light-2 rounded-lg p-8 text-center">
                        <i class="fa fa-question-circle text-4xl text-light-3 mb-3"></i>
                        <p class="text-dark-2">该作业暂无题目提交记录</p>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            content.innerHTML = html;

            // 初始化代码高亮
            if (typeof hljs !== 'undefined') {
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            }
        }

        // 获取题目类型文本
        function getQuestionTypeText(type) {
            switch(type) {
                case 'progressing': return '编程题';
                case 'choice': return '选择题';
                case 'judgment': return '判断题';
                default: return type;
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'submitted': return '已提交';
                case 'graded': return '已批改';
                case 'draft': return '草稿';
                default: return status;
            }
        }

        // 提交评分
        async function submitGrade(studentId, homeworkId, questionId) {
            const score = document.getElementById('grade-score').value;
            const comment = document.getElementById('grade-comment').value.trim();

            // 验证分数
            if (!score || score < 0 || score > 100) {
                showNotification('请输入有效的分数（0-100）', 'warning');
                return;
            }

            // 禁用提交按钮
            const submitBtn = document.querySelector('#grading-form .btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 提交中...';

            try {
                const response = await fetch(`${API_BASE}/teacher/submission/grade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        homework_id: homeworkId,
                        question_id: questionId,
                        score: parseInt(score),
                        comment: comment
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('评分成功！', 'success');
                    closeGradeSubmissionModal();
                    // 重新加载待批改作业列表
                    loadGradingData();
                } else {
                    showNotification(result.message || '评分失败', 'error');
                }
            } catch (error) {
                console.error('提交评分失败:', error);
                showNotification('评分失败，请重试', 'error');
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-save"></i> <span>提交评分</span>';
            }
        }

        // 关闭批改模态框
        function closeGradeSubmissionModal() {
            document.getElementById('grade-submission-modal').classList.add('hidden');
        }
        

        // 退出登录功能已经通过直接链接实现，不再需要JavaScript函数

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', async function() {
            // 加载教师课程
            const teacherCourses = await loadTeacherCourses();
            
            // 更新课程选择下拉框
            const courseSelect = document.getElementById('course-select');
            if (courseSelect) {
                courseSelect.innerHTML = ''; // 清空现有选项
                
                // 如果没有课程，禁用选择框
                if (teacherCourses.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '您目前没有分配课程';
                    courseSelect.appendChild(option);
                    courseSelect.disabled = true;
                } else {
                    // 添加"请选择课程"选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '请选择课程...';
                    courseSelect.appendChild(defaultOption);
                    
                    // 添加教师教授的课程
                    teacherCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            }
            
            // 侧边栏切换功能
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('hidden');
                    sidebar.classList.toggle('absolute');
                    sidebar.classList.toggle('inset-y-0');
                    sidebar.classList.toggle('left-0');
                    sidebar.classList.toggle('z-50');
                });
            }
            
            // 处理初始哈希值
            const initialHash = window.location.hash.substring(1);
            if (initialHash && document.getElementById(initialHash)) {
                navigateTo(initialHash);
            } else {
                // 默认显示首页
                navigateTo('dashboard');
            }
            
            // 监听哈希变化事件，支持浏览器前进后退导航
            window.addEventListener('hashchange', function() {
                const sectionId = window.location.hash.substring(1);
                const currentActive = document.querySelector('.nav-item.active').getAttribute('href').substring(1);
                if (sectionId && sectionId !== currentActive && document.getElementById(sectionId)) {
                    navigateTo(sectionId);
                }
            });

            // 初始化学生搜索功能
            setupStudentSearch();
            
            
            
            // 如果当前页面是课程管理页面，加载教师课程
            if (window.location.hash === '#course-management' || document.getElementById('course-management').classList.contains('active')) {
                loadTeacherCourses();
            }
            
            // 如果当前页面是课程管理页面，加载教师课程
            if (window.location.hash === '#dashboard' || document.getElementById('dashboard').classList.contains('active')) {
                loadTeacherCourses();
            }
            
            // 如果当前页面是个人资料页面，个人资料已经通过Jinja2模板直接显示
            // 无需额外加载数据

            // 启动实时刷新功能
            startRealTimeUpdates();

            // 页面卸载时停止实时刷新
            window.addEventListener('beforeunload', function() {
                stopRealTimeUpdates();
            });
        });


        // 显示通知
        function showNotification(message, type = 'info') {
            // 这里可以添加一个通知组件的实现
            // 暂时使用alert作为简单实现
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // 题库管理相关变量
        let currentPage = 1;
        let currentFilters = {
            language: '',
            problem_type: '',
            difficulty: '',
            knowledge_points: '',
            search: ''
        };
        // 实时刷新功能变量
        let assignmentRefreshInterval = null;
        let gradingRefreshInterval = null;
        let dashboardRefreshInterval = null;

        // 启动实时刷新
        function startRealTimeUpdates() {
            // 停止现有的定时器
            stopRealTimeUpdates();

            // 每30秒刷新作业列表
            assignmentRefreshInterval = setInterval(() => {
                if (document.getElementById('assignment').classList.contains('active')) {
                    loadAssignmentData();
                }
            }, 30000);

            // 每20秒刷新待批改作业
            gradingRefreshInterval = setInterval(() => {
                if (document.getElementById('grading').classList.contains('active')) {
                    loadGradingData();
                }
            }, 20000);

            // 每60秒刷新仪表盘统计数据
            dashboardRefreshInterval = setInterval(() => {
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadDashboardData();
                }
            }, 60000);

            console.log('实时刷新功能已启动');
        }

        // 停止实时刷新
        function stopRealTimeUpdates() {
            if (assignmentRefreshInterval) {
                clearInterval(assignmentRefreshInterval);
                assignmentRefreshInterval = null;
            }
            if (gradingRefreshInterval) {
                clearInterval(gradingRefreshInterval);
                gradingRefreshInterval = null;
            }
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
            console.log('实时刷新功能已停止');
        }

        // 页面切换时加载对应数据
        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'assignment':
                    loadAssignmentData();
                    break;
                case 'grading':
                    loadGradingData();
                    break;
                case 'course-management':
                    loadTeacherCourses();
                    break;
                case 'problems':
                    loadQuestionBankStats();
                    loadQuestionBankData();
                    break;
                // 其他页面可以根据需要添加数据加载逻辑
            }
        }

        // 加载题库统计数据
        async function loadQuestionBankStats() {
            try {
                const response = await fetch(`${API_BASE}/question-bank/stats`);
                const result = await response.json();

                if (result.success) {
                    updateQuestionBankStats(result.data);
                } else {
                    console.error('获取题库统计失败:', result.message);
                }
            } catch (error) {
                console.error('加载题库统计失败:', error);
            }
        }

        // 更新题库统计显示
        function updateQuestionBankStats(stats) {
            document.getElementById('total-problems-stat').textContent = stats.total_problems || 0;
            document.getElementById('progressing-count').textContent = stats.progressing_count || 0;
            document.getElementById('choice-count').textContent = stats.choice_count || 0;
            document.getElementById('judgment-count').textContent = stats.judgment_count || 0;
        }

        // 加载题库数据
        async function loadQuestionBankData(page = 1) {
            try {
                // 构建查询参数 - 移除每页数量限制，获取所有题目
                const params = new URLSearchParams({
                    page: page,
                    per_page: 2000, // 增加到2000获取更多题目
                    ...currentFilters
                });

                console.log('调试: 请求参数:', params.toString());
                const response = await fetch(`${API_BASE}/question-bank/problems?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayQuestionBankProblems(result.data);
                    updatePagination(result.pagination);
                } else {
                    console.error('获取题库数据失败:', result.message);
                    showNotification('获取题库数据失败', 'error');
                }
            } catch (error) {
                console.error('加载题库数据失败:', error);
                showNotification('加载题库数据失败', 'error');
            }
        }

        // 显示题库题目
        function displayQuestionBankProblems(problems) {
            const tbody = document.getElementById('problems-table-body');
            const totalCount = document.getElementById('total-problems');

            if (!tbody || !totalCount) return;

            if (problems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-search text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">没有找到符合条件的题目</p>
                            </div>
                        </td>
                    </tr>
                `;
                totalCount.textContent = '0';
                return;
            }

            tbody.innerHTML = problems.map(problem => `
                <tr class="hover:bg-light-1/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-medium text-dark">${problem.title}</div>
                        <div class="text-sm text-dark-2 mt-1">${problem.description ? problem.description.substring(0, 50) + '...' : '暂无描述'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${problem.language || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${getProblemTypeColor(problem.question_type)}">
                            ${getProblemTypeText(problem.question_type)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${problem.difficulty || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${problem.knowledge_points || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${formatDate(problem.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            <button class="text-primary hover:underline" onclick="viewProblem(${problem.id}, '${problem.question_type}')">查看</button>
                            <button class="text-dark-2 hover:text-primary" onclick="editProblem(${problem.id}, '${problem.question_type}')">编辑</button>
                            <button class="text-danger hover:underline" onclick="deleteProblem(${problem.id}, '${problem.question_type}', '${problem.title}')">删除</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // 更新总数显示
            if (problems.length > 0 && problems[0].total_problems) {
                totalCount.textContent = problems[0].total_problems;
            }
        }

        // 获取题目类型颜色
        function getProblemTypeColor(type) {
            switch(type) {
                case 'progressing': return 'bg-primary/10 text-primary';
                case 'choice': return 'bg-success/10 text-success';
                case 'judgment': return 'bg-warning/10 text-warning';
                default: return 'bg-light-2 text-dark-2';
            }
        }

        // 获取题目类型文本
        function getProblemTypeText(type) {
            switch(type) {
                case 'progressing': return '编程题';
                case 'choice': return '选择题';
                case 'judgment': return '判断题';
                default: return type;
            }
        }

        // 更新分页
        function updatePagination(pagination) {
            const container = document.getElementById('pagination-container');
            const pageNumbers = document.getElementById('page-numbers');
            const currentRange = document.getElementById('current-range');
            const totalCount = document.getElementById('total-count');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            if (!container || !pageNumbers) return;

            // 更新统计信息
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            currentRange.textContent = `${start}-${end}`;
            totalCount.textContent = pagination.total;

            // 更新按钮状态
            prevBtn.disabled = pagination.page <= 1;
            nextBtn.disabled = pagination.page >= pagination.pages;

            // 生成页码按钮
            let pageButtons = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, pagination.page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pagination.pages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === pagination.page) {
                    pageButtons += `<button class="w-8 h-8 flex items-center justify-center rounded bg-primary text-white">${i}</button>`;
                } else {
                    pageButtons += `<button class="w-8 h-8 flex items-center justify-center rounded border border-light-2 hover:border-primary hover:text-primary" onclick="changePage(${i})">${i}</button>`;
                }
            }

            pageNumbers.innerHTML = pageButtons;

            // 显示分页容器
            container.style.display = pagination.total > 0 ? 'flex' : 'none';
        }

        // 切换页面
        function changePage(page) {
            currentPage = page;
            loadQuestionBankData(page);
        }

        // 应用筛选
        function applyFilters() {
            // 获取筛选条件
            currentFilters = {
                language: document.getElementById('language-filter').value,
                problem_type: document.getElementById('problem-type-filter').value,
                difficulty: document.getElementById('difficulty-filter').value,
                knowledge_points: document.getElementById('knowledge-points-filter').value,
                search: document.getElementById('search-filter').value.trim()
            };

            console.log('应用筛选条件:', currentFilters);

            // 重置到第一页
            currentPage = 1;
            loadQuestionBankData(1);
        }

        // 清空筛选
        function clearFilters() {
            // 清空所有筛选条件
            document.getElementById('language-filter').value = '';
            document.getElementById('problem-type-filter').value = '';
            document.getElementById('difficulty-filter').value = '';
            document.getElementById('knowledge-points-filter').value = '';
            document.getElementById('search-filter').value = '';

            currentFilters = {
                language: '',
                problem_type: '',
                difficulty: '',
                knowledge_points: '',
                search: ''
            };

            console.log('清空筛选条件:', currentFilters);

            currentPage = 1;
            loadQuestionBankData(1);
        }

        // 查看题目详情
        function viewProblem(problemId, problemType) {
            // 显示模态框
            document.getElementById('problem-detail-modal').classList.remove('hidden');

            // 显示加载状态
            const content = document.getElementById('problem-detail-content');
            content.innerHTML = `
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载题目详情...</p>
                </div>
            `;

            // 加载题目详情
            loadProblemDetail(problemId, problemType);
        }

        // 加载题目详情
        async function loadProblemDetail(problemId, problemType) {
            try {
                const response = await fetch(`${API_BASE}/question-bank/problem/${problemId}?type=${problemType}`);
                const result = await response.json();

                if (result.success) {
                    displayProblemDetail(result.data);
                } else {
                    showNotification(result.message || '获取题目详情失败', 'error');
                    closeProblemDetailModal();
                }
            } catch (error) {
                console.error('加载题目详情失败:', error);
                showNotification('加载题目详情失败', 'error');
                closeProblemDetailModal();
            }
        }

        // 显示题目详情
        function displayProblemDetail(problem) {
            const content = document.getElementById('problem-detail-content');

            let detailHtml = '';

            if (problem.question_type === 'progressing') {
                // 编程题详情
                detailHtml = `
                    <div class="space-y-6">
                        <!-- 基本信息 -->
                        <div class="bg-light-1 p-4 rounded-lg">
                            <h4 class="font-semibold text-dark mb-3">基本信息</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="text-dark-2">题目标题：</span><span class="font-medium">${problem.title || '无'}</span></div>
                                <div><span class="text-dark-2">编程语言：</span><span class="font-medium">${problem.language || '无'}</span></div>
                                <div><span class="text-dark-2">难度等级：</span><span class="font-medium">${problem.difficulty || '无'}</span></div>
                                <div><span class="text-dark-2">知识点：</span><span class="font-medium">${problem.knowledge_points || '无'}</span></div>
                            </div>
                        </div>

                        <!-- 题目描述 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">题目描述</h4>
                            <p class="text-dark whitespace-pre-line">${problem.description || '暂无描述'}</p>
                        </div>

                        <!-- 输入输出说明 -->
                        ${problem.input_description || problem.output_description ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${problem.input_description ? `
                            <div class="bg-white p-4 rounded-lg border border-light-2">
                                <h4 class="font-semibold text-dark mb-3">输入说明</h4>
                                <p class="text-dark whitespace-pre-line">${problem.input_description}</p>
                            </div>
                            ` : ''}
                            ${problem.output_description ? `
                            <div class="bg-white p-4 rounded-lg border border-light-2">
                                <h4 class="font-semibold text-dark mb-3">输出说明</h4>
                                <p class="text-dark whitespace-pre-line">${problem.output_description}</p>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}

                        <!-- 测试用例 -->
                        ${problem.test_cases && problem.test_cases.length > 0 ? `
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">测试用例</h4>
                            <div class="space-y-3">
                                ${problem.test_cases.map((testCase, index) => `
                                <div class="border border-light-2 rounded-lg p-3">
                                    <div class="font-medium text-sm text-primary mb-2">测试用例 ${index + 1} ${testCase.is_example ? '(样例)' : ''}</div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <div class="text-xs text-dark-2 mb-1">输入：</div>
                                            <pre class="bg-light-1 p-2 rounded text-xs overflow-x-auto">${escapeHtml(testCase.input)}</pre>
                                        </div>
                                        <div>
                                            <div class="text-xs text-dark-2 mb-1">输出：</div>
                                            <pre class="bg-light-1 p-2 rounded text-xs overflow-x-auto">${escapeHtml(testCase.output)}</pre>
                                        </div>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- 解题思路 -->
                        ${problem.solution_idea ? `
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">解题思路</h4>
                            <p class="text-dark whitespace-pre-line">${problem.solution_idea}</p>
                        </div>
                        ` : ''}

                        <!-- 参考代码 -->
                        ${problem.reference_code ? `
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">参考代码</h4>
                            <pre class="bg-dark text-white p-3 rounded text-sm overflow-x-auto"><code class="language-${problem.language ? problem.language.toLowerCase() : 'text'}">${escapeHtml(problem.reference_code)}</code></pre>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (problem.question_type === 'choice') {
                // 选择题详情
                let optionsHtml = '';
                if (problem.options) {
                    try {
                        const options = typeof problem.options === 'string' ? JSON.parse(problem.options) : problem.options;

                        // 调试日志
                        console.log('选择题详情页 - 原始options:', problem.options);
                        console.log('选择题详情页 - 解析后options:', options);
                        console.log('选择题详情页 - options类型:', typeof options);
                        console.log('选择题详情页 - Array.isArray(options):', Array.isArray(options));
                        console.log('选择题详情页 - correct_answer:', problem.correct_answer);

                    // 映射函数：将数字索引转换为字母标签
                    function getOptionLabel(index) {
                        return String.fromCharCode(65 + parseInt(index)); // 0->A, 1->B, 2->C, 3->D
                    }

                    if (Array.isArray(options)) {
                        console.log('选择题详情页 - 使用数组格式处理');
                        // 新格式：数组
                        optionsHtml = options.map((value, index) => {
                            const key = index.toString();
                            const optionLabel = getOptionLabel(index);
                            const isCorrectAnswer = problem.correct_answer === key;
                            console.log(`选择题详情页 - 选项${index}: key=${key}, value="${value}", isCorrect=${isCorrectAnswer}`);
                            const className = isCorrectAnswer ? 'bg-success/10 border border-success/20' : 'bg-light-1';
                            return `
                                <div class="flex items-start gap-2 p-2 rounded ${className}">
                                    <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                    <span class="text-sm">${value}</span>
                                    ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                </div>
                            `;
                        }).join('');
                        console.log('选择题详情页 - 生成的HTML长度:', optionsHtml.length);
                    } else {
                            // 旧格式：对象（兼容性保留）
                            optionsHtml = Object.entries(options).map(([key, value], index) => {
                                const optionLabel = getOptionLabel(index);
                                const isCorrectAnswer = problem.correct_answer === key;
                                const className = isCorrectAnswer ? 'bg-success/10 border border-success/20' : 'bg-light-1';
                                return `
                                    <div class="flex items-start gap-2 p-2 rounded ${className}">
                                        <span class="font-medium text-sm min-w-[24px]">${optionLabel}:</span>
                                        <span class="text-sm">${value}</span>
                                        ${isCorrectAnswer ? '<span class="text-success text-xs ml-2">✓ 正确答案</span>' : ''}
                                    </div>
                                `;
                            }).join('');
                        }
                    } catch (e) {
                        optionsHtml = '<div class="text-dark-2 text-sm">选项数据格式错误</div>';
                    }
                }

                detailHtml = `
                    <div class="space-y-6">
                        <!-- 基本信息 -->
                        <div class="bg-light-1 p-4 rounded-lg">
                            <h4 class="font-semibold text-dark mb-3">基本信息</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="text-dark-2">题目标题：</span><span class="font-medium">${problem.title || '无'}</span></div>
                                <div><span class="text-dark-2">题型：</span><span class="font-medium">选择题</span></div>
                                <div><span class="text-dark-2">难度等级：</span><span class="font-medium">${problem.difficulty || '无'}</span></div>
                                <div><span class="text-dark-2">知识点：</span><span class="font-medium">${problem.knowledge_points || '无'}</span></div>
                            </div>
                        </div>

                        <!-- 题目描述 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">题目描述</h4>
                            <p class="text-dark whitespace-pre-line">${problem.description || '暂无描述'}</p>
                        </div>

                        <!-- 选项 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">选项</h4>
                            <div class="space-y-2">
                                ${optionsHtml}
                            </div>
                        </div>

                        <!-- 解题思路 -->
                        ${problem.solution_idea ? `
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">解题思路</h4>
                            <p class="text-dark whitespace-pre-line">${problem.solution_idea}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (problem.question_type === 'judgment') {
                // 判断题详情
                detailHtml = `
                    <div class="space-y-6">
                        <!-- 基本信息 -->
                        <div class="bg-light-1 p-4 rounded-lg">
                            <h4 class="font-semibold text-dark mb-3">基本信息</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="text-dark-2">题目标题：</span><span class="font-medium">${problem.title || '无'}</span></div>
                                <div><span class="text-dark-2">题型：</span><span class="font-medium">判断题</span></div>
                                <div><span class="text-dark-2">难度等级：</span><span class="font-medium">${problem.difficulty || '无'}</span></div>
                                <div><span class="text-dark-2">知识点：</span><span class="font-medium">${problem.knowledge_points || '无'}</span></div>
                            </div>
                        </div>

                        <!-- 题目描述 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">题目描述</h4>
                            <p class="text-dark whitespace-pre-line">${problem.description || '暂无描述'}</p>
                        </div>

                        <!-- 正确答案 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">正确答案</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${problem.correct_answer ? '✓' : '✗'}</span>
                                <span class="font-medium text-lg ${problem.correct_answer ? 'text-success' : 'text-danger'}">
                                    ${problem.correct_answer ? '正确' : '错误'}
                                </span>
                            </div>
                        </div>

                        <!-- 解题思路 -->
                        ${problem.solution_idea ? `
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-semibold text-dark mb-3">解题思路</h4>
                            <p class="text-dark whitespace-pre-line">${problem.solution_idea}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            content.innerHTML = detailHtml;

            // 重新初始化代码高亮
            if (typeof hljs !== 'undefined') {
                setTimeout(() => {
                    hljs.highlightAll();
                }, 100);
            }
        }

        // 关闭题目详情模态框
        function closeProblemDetailModal() {
            document.getElementById('problem-detail-modal').classList.add('hidden');
        }

        // 编辑题目
        function editProblem(problemId, problemType) {
            // 显示编辑模态框
            document.getElementById('edit-problem-modal').classList.remove('hidden');

            // 设置模态框标题
            const titleElement = document.getElementById('edit-problem-title');
            titleElement.textContent = `编辑题目 - ${getProblemTypeText(problemType)}`;

            // 显示加载状态
            const form = document.getElementById('edit-problem-form');
            const loading = form.querySelector('.loading-state');
            const content = form.querySelector('.form-content');

            loading.style.display = 'block';
            content.style.display = 'none';

            // 加载题目详情并填充表单
            loadProblemForEdit(problemId, problemType);
        }

        // 加载题目数据用于编辑
        async function loadProblemForEdit(problemId, problemType) {
            try {
                const response = await fetch(`${API_BASE}/question-bank/problem/${problemId}?type=${problemType}`);
                const result = await response.json();

                if (result.success) {
                    fillEditProblemForm(result.data, problemType);
                } else {
                    showNotification(result.message || '获取题目详情失败', 'error');
                    closeEditProblemModal();
                }
            } catch (error) {
                console.error('加载题目详情失败:', error);
                showNotification('加载题目详情失败', 'error');
                closeEditProblemModal();
            }
        }

        // 填充编辑表单
        function fillEditProblemForm(problem, problemType) {
            // 隐藏加载状态，显示表单内容
            const form = document.getElementById('edit-problem-form');
            const loading = form.querySelector('.loading-state');
            const content = form.querySelector('.form-content');

            loading.style.display = 'none';
            content.style.display = 'block';

            // 存储题目信息用于提交
            window.currentEditProblem = {
                id: problem.id,
                type: problemType.replace('progressing', 'programming'), // 转换题型格式
                problemType: problemType
            };

            // 基本信息
            document.getElementById('edit-problem-title-input').value = problem.title || '';
            document.getElementById('edit-problem-description').value = problem.description || '';
            document.getElementById('edit-problem-language').value = problem.language || '';
            document.getElementById('edit-problem-difficulty').value = problem.difficulty || '';
            document.getElementById('edit-problem-knowledge-point').value = problem.knowledge_points || '';
            document.getElementById('edit-problem-solution-idea').value = problem.solution_idea || '';

            // 根据题型处理特定字段
            if (problemType === 'progressing') {
                // 编程题字段
                document.getElementById('edit-problem-input-desc').value = problem.input_description || '';
                document.getElementById('edit-problem-output-desc').value = problem.output_description || '';
                document.getElementById('edit-problem-reference-code').value = problem.reference_code || '';

                // 清空并重新填充测试用例
                const caseContainer = document.getElementById('edit-test-cases-container');
                if (caseContainer) caseContainer.innerHTML = '';

                if (problem.test_cases && problem.test_cases.length > 0) {
                    problem.test_cases.forEach((testCase, index) => {
                        addEditTestCase(testCase.input, testCase.output, index + 1);
                    });
                } else {
                    // 至少添加一个空的测试用例
                    addEditTestCase('', '', 1);
                }

                // 显示编程题字段
                document.getElementById('edit-programming-fields').style.display = 'block';
                document.getElementById('edit-choice-fields').style.display = 'none';
                document.getElementById('edit-judgment-fields').style.display = 'none';

            } else if (problemType === 'choice') {
                // 选择题字段
                try {
                    const options = typeof problem.options === 'string' ? JSON.parse(problem.options) : problem.options;

                    document.getElementById('edit-option-a').value = options.A || '';
                    document.getElementById('edit-option-b').value = options.B || '';
                    document.getElementById('edit-option-c').value = options.C || '';
                    document.getElementById('edit-option-d').value = options.D || '';
                    document.getElementById('edit-correct-answer-choice').value = problem.correct_answer || '';
                } catch (e) {
                    console.error('解析选择题选项失败:', e);
                }

                // 显示选择题字段
                document.getElementById('edit-programming-fields').style.display = 'none';
                document.getElementById('edit-choice-fields').style.display = 'block';
                document.getElementById('edit-judgment-fields').style.display = 'none';

            } else if (problemType === 'judgment') {
                // 判断题字段
                const correctAnswer = problem.correct_answer === true || problem.correct_answer === 'true' ? 'true' : 'false';
                document.getElementById('edit-correct-answer-judgment').value = correctAnswer;

                // 显示判断题字段
                document.getElementById('edit-programming-fields').style.display = 'none';
                document.getElementById('edit-choice-fields').style.display = 'none';
                document.getElementById('edit-judgment-fields').style.display = 'block';
            }
        }

        // 添加编辑测试用例
        function addEditTestCase(input = '', output = '', number = null) {
            const container = document.getElementById('edit-test-cases-container');
            const testCaseNumber = number || (container.querySelectorAll('.edit-test-case-item').length + 1);

            const testCaseHtml = `
                <div class="edit-test-case-item bg-light-1 p-4 rounded-lg mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-medium text-sm">测试用例 ${testCaseNumber}</h5>
                        <button type="button" class="text-danger hover:underline text-sm" onclick="removeEditTestCase(this)">删除</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="form-label text-xs">输入</label>
                            <textarea class="form-input text-xs" rows="3" placeholder="测试输入">${input || ''}</textarea>
                        </div>
                        <div>
                            <label class="form-label text-xs">输出</label>
                            <textarea class="form-input text-xs" rows="3" placeholder="预期输出">${output || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', testCaseHtml);
        }

        // 删除编辑测试用例
        function removeEditTestCase(button) {
            const testCaseItem = button.closest('.edit-test-case-item');
            if (testCaseItem) {
                testCaseItem.remove();
                updateEditTestCaseNumbers();
            }
        }

        // 更新编辑测试用例编号
        function updateEditTestCaseNumbers() {
            const testCaseItems = document.querySelectorAll('.edit-test-case-item');
            testCaseItems.forEach((item, index) => {
                const title = item.querySelector('h5');
                if (title) {
                    title.textContent = `测试用例 ${index + 1}`;
                }
            });
        }

        // 提交编辑题目表单
        async function submitEditProblem() {
            if (!window.currentEditProblem) {
                showNotification('题目信息丢失，请重新打开编辑窗口', 'error');
                return;
            }

            const problemId = window.currentEditProblem.id;
            const problemType = window.currentEditProblem.problemType;

            console.log('[EDIT DEBUG] 开始编辑题目 - ID:', problemId, '类型:', problemType);

            // 收集基础字段
            const formData = {
                question_type: window.currentEditProblem.type,
                title: document.getElementById('edit-problem-title-input').value.trim(),
                description: document.getElementById('edit-problem-description').value.trim(),
                language: document.getElementById('edit-problem-language').value,
                difficulty: document.getElementById('edit-problem-difficulty').value,
                knowledge_points: document.getElementById('edit-problem-knowledge-point').value,
                solution_idea: document.getElementById('edit-problem-solution-idea').value.trim()
            };

            console.log('[EDIT DEBUG] 基础字段收集完成:', formData);

            // 验证必填字段
            if (!formData.title || !formData.description || !formData.language ||
                !formData.difficulty || !formData.knowledge_points) {
                showNotification('请填写所有必填字段', 'warning');
                return;
            }

            // 根据题型收集特定字段
            if (problemType === 'progressing') {
                formData.input_description = document.getElementById('edit-problem-input-desc').value.trim();
                formData.output_description = document.getElementById('edit-problem-output-desc').value.trim();
                formData.reference_code = document.getElementById('edit-problem-reference-code').value.trim();

                // 收集测试用例
                const testCases = [];
                const testCaseItems = document.querySelectorAll('.edit-test-case-item');
                testCaseItems.forEach(item => {
                    const inputs = item.querySelectorAll('textarea');
                    if (inputs.length >= 2) {
                        const input = inputs[0].value.trim();
                        const output = inputs[1].value.trim();
                        if (input || output) {
                            testCases.push({ input, output, is_example: false });
                        }
                    }
                });
                formData.test_cases = testCases;

            } else if (problemType === 'choice') {
                const options = {
                    A: document.getElementById('edit-option-a').value.trim(),
                    B: document.getElementById('edit-option-b').value.trim(),
                    C: document.getElementById('edit-option-c').value.trim(),
                    D: document.getElementById('edit-option-d').value.trim()
                };

                // 验证选项不为空
                if (!options.A || !options.B || !options.C || !options.D) {
                    showNotification('请填写所有选项内容', 'warning');
                    return;
                }

                formData.options = options;
                formData.correct_answer = document.getElementById('edit-correct-answer-choice').value;

                if (!formData.correct_answer) {
                    showNotification('请选择正确答案', 'warning');
                    return;
                }

            } else if (problemType === 'judgment') {
                const correctAnswer = document.getElementById('edit-correct-answer-judgment').value;
                if (!correctAnswer) {
                    showNotification('请选择正确答案', 'warning');
                    return;
                }
                formData.correct_answer = correctAnswer === 'true';
            }

            // 禁用提交按钮
            const submitBtn = document.querySelector('#edit-problem-modal .btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 保存中...';

            try {
                const response = await fetch(`${API_BASE}/question-bank/problem/${problemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('题目更新成功！', 'success');
                    closeEditProblemModal();
                    // 重新加载题库数据
                    loadQuestionBankData();
                    loadQuestionBankStats();
                } else {
                    showNotification(result.message || '题目更新失败', 'error');
                }
            } catch (error) {
                console.error('更新题目失败:', error);
                showNotification('网络错误，请重试', 'error');
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-save"></i> <span>保存更改</span>';
            }
        }

        // 关闭编辑题目模态框
        function closeEditProblemModal() {
            document.getElementById('edit-problem-modal').classList.add('hidden');
            // 手动清空表单数据
            const form = document.getElementById('edit-problem-form');
            if (form) {
                // 清空基本信息字段
                const inputs = form.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.type !== 'checkbox') {
                        input.value = '';
                    }
                });

                // 清空下拉框
                const selects = form.querySelectorAll('select');
                selects.forEach(select => select.selectedIndex = 0);
            }

            // 隐藏所有题型特定字段
            document.getElementById('edit-programming-fields').style.display = 'none';
            document.getElementById('edit-choice-fields').style.display = 'none';
            document.getElementById('edit-judgment-fields').style.display = 'none';
            delete window.currentEditProblem;
        }

        // 删除题目
        function deleteProblem(problemId, problemType, problemTitle) {
            if (!confirm(`确定要删除题目 "${problemTitle}" 吗？\n\n删除后该题目将从题库中永久删除，无法恢复。`)) {
                return;
            }

            // 显示删除确认提示
            if (!confirm(`再次确认：您确定要删除题目 "${problemTitle}" 吗？`)) {
                return;
            }

            deleteProblemConfirmed(problemId, problemType, problemTitle);
        }

        // 确认删除题目
        async function deleteProblemConfirmed(problemId, problemType, problemTitle) {
            try {
                const response = await fetch(`${API_BASE}/question-bank/problem/${problemId}?type=${problemType}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`题目 "${problemTitle}" 删除成功`, 'success');
                    // 重新加载题库数据
                    loadQuestionBankData();
                    loadQuestionBankStats();
                } else {
                    showNotification(result.message || '删除题目失败', 'error');
                }
            } catch (error) {
                console.error('删除题目失败:', error);
                showNotification('删除题目失败，请重试', 'error');
            }
        }

        // 打开增加题目模态框
        function openAddProblemModal() {
            // 重置表单
            document.getElementById('add-problem-form').reset();

            // 隐藏所有题型特定字段和语言选择器
            document.getElementById('programming-fields').style.display = 'none';
            document.getElementById('choice-fields').style.display = 'none';
            document.getElementById('judgment-fields').style.display = 'none';
            document.getElementById('language-field').style.display = 'none';

            // 初始化测试用例按钮状态
            setTimeout(() => {
                updateTestCaseButtons();
            }, 100);

            // 显示模态框
            document.getElementById('add-problem-modal').classList.remove('hidden');
        }

        // 关闭增加题目模态框
        function closeAddProblemModal() {
            document.getElementById('add-problem-modal').classList.add('hidden');
        }

        // 题目类型选择变化处理
        function onProblemTypeChange() {
            const problemType = document.getElementById('problem-type').value;

            // 隐藏所有题型特定字段
            document.getElementById('programming-fields').style.display = 'none';
            document.getElementById('choice-fields').style.display = 'none';
            document.getElementById('judgment-fields').style.display = 'none';

            // 显示对应题型的字段
            if (problemType === 'programming') {
                document.getElementById('programming-fields').style.display = 'block';
                document.getElementById('language-field').style.display = 'block';
            } else if (problemType === 'choice') {
                document.getElementById('choice-fields').style.display = 'block';
                document.getElementById('language-field').style.display = 'block';
            } else if (problemType === 'judgment') {
                document.getElementById('judgment-fields').style.display = 'block';
                document.getElementById('language-field').style.display = 'block';
            } else {
                // 没有选择题型时，隐藏所有字段
                document.getElementById('language-field').style.display = 'none';
            }
        }

        // 添加测试用例
        function addTestCase() {
            const container = document.getElementById('test-cases-container');
            if (!container) return;

            const testCaseItems = container.querySelectorAll('.test-case-item');
            const testCaseNumber = testCaseItems.length + 1;

            const testCaseHtml = `
                <div class="test-case-item bg-light-1 p-4 rounded-lg mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-medium text-sm">测试用例 ${testCaseNumber}</h5>
                        <button type="button" class="text-danger hover:underline text-sm" onclick="removeTestCase(this)">删除</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="form-label text-xs">输入</label>
                            <textarea class="form-input text-xs" rows="3" placeholder="测试输入" required></textarea>
                        </div>
                        <div>
                            <label class="form-label text-xs">输出</label>
                            <textarea class="form-input text-xs" rows="3" placeholder="预期输出" required></textarea>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', testCaseHtml);

            // 检查是否达到最大数量，禁用添加按钮
            updateTestCaseButtons();
        }

        // 删除测试用例
        function removeTestCase(button) {
            const testCaseItem = button.closest('.test-case-item');
            if (testCaseItem) {
                testCaseItem.remove();
                // 重新编号剩余的测试用例
                updateTestCaseNumbers();
                // 更新按钮状态
                updateTestCaseButtons();
            }
        }

        // 更新测试用例编号
        function updateTestCaseNumbers() {
            const testCaseItems = document.querySelectorAll('#test-cases-container .test-case-item');
            testCaseItems.forEach((item, index) => {
                const title = item.querySelector('h5');
                if (title) {
                    title.textContent = `测试用例 ${index + 1}`;
                }
            });
        }

        // 更新测试用例按钮状态
        function updateTestCaseButtons() {
            const container = document.getElementById('test-cases-container');
            const addButton = container.parentElement.querySelector('button[onclick="addTestCase()"]');
            const testCaseItems = container.querySelectorAll('.test-case-item');

            if (addButton) {
                // 如果已经有10个测试用例或更多，禁用添加按钮
                if (testCaseItems.length >= 10) {
                    addButton.disabled = true;
                    addButton.textContent = '已达最大数量';
                    addButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    addButton.disabled = false;
                    addButton.textContent = '添加更多的测试用例';
                    addButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // 更新测试用例编号
        function updateTestCaseNumbers() {
            const testCaseItems = document.querySelectorAll('.test-case-item');
            testCaseItems.forEach((item, index) => {
                const title = item.querySelector('h5');
                if (title) {
                    title.textContent = `测试用例 ${index + 1}`;
                }
            });
        }

        // 提交增加题目表单
        async function submitAddProblem() {
            // 获取基本信息
            const problemData = {
                question_type: document.getElementById('problem-type').value,
                language: document.getElementById('problem-language').value,
                knowledge_points: document.getElementById('problem-knowledge-point').value,
                difficulty: document.getElementById('problem-difficulty').value,
                title: document.getElementById('problem-title').value.trim(),
                description: document.getElementById('problem-description').value.trim(),
                solution_idea: document.getElementById('problem-solution-idea').value.trim()
            };

            // 表单验证
            if (!problemData.question_type) {
                showNotification('请选择题型', 'warning');
                return;
            }

            if (!problemData.language) {
                showNotification('请选择编程语言', 'warning');
                return;
            }

            if (!problemData.knowledge_points) {
                showNotification('请选择知识点', 'warning');
                return;
            }

            if (!problemData.difficulty) {
                showNotification('请选择难度', 'warning');
                return;
            }

            if (!problemData.title) {
                showNotification('请输入题目标题', 'warning');
                return;
            }

            if (!problemData.description) {
                showNotification('请输入题目描述', 'warning');
                return;
            }

            // 根据题型添加特定字段和验证
            if (problemData.question_type === 'programming') {
                // 编程题验证
                problemData.input_description = document.getElementById('problem-input-desc').value.trim();
                problemData.output_description = document.getElementById('problem-output-desc').value.trim();
                problemData.reference_code = document.getElementById('problem-reference-code').value.trim();

                // 收集测试用例
                const testCases = [];
                const testCaseItems = document.querySelectorAll('#test-cases-container .test-case-item');
                testCaseItems.forEach((item, index) => {
                    const inputs = item.querySelectorAll('textarea');
                    if (inputs.length >= 2) {
                        const input = inputs[0].value.trim();
                        const output = inputs[1].value.trim();
                        if (input && output) {
                            testCases.push({ input, output, is_example: index < 3 });
                        } else if (input || output) {
                            showNotification(`测试用例 ${index + 1} 的输入和输出都必须填写`, 'warning');
                            return;
                        }
                    }
                });

                if (testCases.length === 0) {
                    showNotification('请至少添加一个完整的测试用例', 'warning');
                    return;
                }

                problemData.test_cases = testCases;
                problemData.input_description = document.getElementById('problem-input-desc').value.trim();
                problemData.output_description = document.getElementById('problem-output-desc').value.trim();
                problemData.reference_code = document.getElementById('problem-reference-code').value.trim();

            } else if (problemData.question_type === 'choice') {
                // 选择题验证
                const options = {
                    A: document.getElementById('option-a').value.trim(),
                    B: document.getElementById('option-b').value.trim(),
                    C: document.getElementById('option-c').value.trim(),
                    D: document.getElementById('option-d').value.trim()
                };

                // 验证选项不为空
                if (!options.A || !options.B || !options.C || !options.D) {
                    showNotification('请填写所有选项内容', 'warning');
                    return;
                }

                problemData.options = options;
                problemData.correct_answer = document.getElementById('correct-answer-choice').value;

                if (!problemData.correct_answer) {
                    showNotification('请选择正确答案', 'warning');
                    return;
                }

            } else if (problemData.question_type === 'judgment') {
                // 判断题验证
                const correctAnswer = document.getElementById('correct-answer-judgment').value;
                if (!correctAnswer) {
                    showNotification('请选择正确答案', 'warning');
                    return;
                }
                problemData.correct_answer = correctAnswer === 'true';
            }

            // 禁用提交按钮
            const submitBtn = document.querySelector('#add-problem-modal .btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 保存中...';

            try {
                console.log('发送题目数据:', problemData);

                const response = await fetch(`${API_BASE}/question-bank/problems`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(problemData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('题目创建成功！', 'success');
                    closeAddProblemModal();
                    // 重新加载题库数据
                    loadQuestionBankData();
                    loadQuestionBankStats();
                } else {
                    showNotification(result.message || '题目创建失败', 'error');
                }
            } catch (error) {
                console.error('创建题目失败:', error);
                showNotification('网络错误，请重试', 'error');
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-save"></i> 保存题目';
            }
        }

        // 处理搜索框回车键
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                applyFilters();
            }
        }

        // 页面切换时加载对应数据
        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'assignment':
                    loadAssignmentData();
                    break;
                case 'grading':
                    loadGradingData();
                    break;
                case 'course-management':
                    loadTeacherCourses();
                    break;
                case 'problems':
                    loadQuestionBankStats();
                    loadQuestionBankData();
                    break;
                // 其他页面可以根据需要添加数据加载逻辑
            }
        }


        // 打开编辑个人资料模态框
        function openEditProfileModal() {
            // 获取当前用户数据
            const userData = {
                email: '{{ user.email if user.email else "" }}',
                telenum: '{{ user.telenum if user.telenum else "" }}',
                course_assignment: '{{ user.course_assignment if user.course_assignment else "" }}'
            };
            
            // 填充表单
            document.getElementById('edit-email').value = userData.email;
            document.getElementById('edit-telenum').value = userData.telenum;
            document.getElementById('edit-course-assignment').value = userData.course_assignment;
            
            // 显示模态框
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        }

        // 关闭编辑个人资料模态框
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }


        // 获取CSRF Token
        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            return csrfToken ? csrfToken.getAttribute('content') : '';
        }

        // 提交个人资料编辑表单
        async function submitProfileEdit() {
            const formData = {
                email: document.getElementById('edit-email').value.trim(),
                telenum: document.getElementById('edit-telenum').value.trim(),
                course_assignment: document.getElementById('edit-course-assignment').value.trim()
            };
            
            // 验证必填字段
            if (!formData.telenum) {
                showNotification('手机号不能为空', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/teacher/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('个人资料更新成功', 'success');
                    closeEditProfileModal();
                    // 重新加载页面以更新显示的数据
                    location.reload();
                } else {
                    showNotification(result.message || '个人资料更新失败', 'error');
                }
                
            } catch (error) {
                console.error('更新个人资料失败:', error);
                showNotification('更新个人资料失败，请重试', 'error');
            }
        }

        // 添加学生相关功能
        let selectedStudentsForClass = new Set();
        let currentClassId = null;
        let currentCourseId = null;

        // 打开添加学生模态框
        function openAddStudentsModal(classId, courseId) {
            currentClassId = classId;
            currentCourseId = courseId;
            selectedStudentsForClass.clear();

            // 调试信息
            console.log('Opening add students modal:');
            console.log('classId:', classId);
            console.log('courseId:', courseId);

            // 更新模态框标题
            document.getElementById('add-students-class-info').textContent = '选择要添加到班级的学生';

            // 重置选中计数
            document.getElementById('selected-students-count').textContent = '已选择 0 名学生';

            // 显示模态框
            document.getElementById('add-students-modal').classList.remove('hidden');

            // 加载未选择该课程的学生列表
            if (courseId && courseId !== 'undefined') {
                loadUnenrolledStudents(courseId);
            } else {
                console.error('Course ID is undefined, cannot load unenrolled students');
                showNotification('课程ID无效，无法加载学生列表', 'error');
            }
        }

        // 关闭添加学生模态框
        function closeAddStudentsModal() {
            document.getElementById('add-students-modal').classList.add('hidden');
            currentClassId = null;
            currentCourseId = null;
            selectedStudentsForClass.clear();
        }

        // 加载未选择该课程的学生列表
        async function loadUnenrolledStudents(courseId, searchTerm = '') {
            try {
                const url = searchTerm ? 
                    `${API_BASE}/courses/${courseId}/unenrolled-students?search=${encodeURIComponent(searchTerm)}` :
                    `${API_BASE}/courses/${courseId}/unenrolled-students`;
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    updateAddStudentsTable(result.data);
                } else {
                    console.error('获取未选课学生列表失败:', result.message);
                    showNotification('获取未选课学生列表失败', 'error');
                    document.getElementById('add-students-table-body').innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                                <div class="flex flex-col items-center">
                                    <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                                    <p class="text-sm">获取未选课学生列表失败</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }

            } catch (error) {
                console.error('加载未选课学生列表失败:', error);
                showNotification('加载未选课学生列表失败', 'error');
                document.getElementById('add-students-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                                <p class="text-sm">加载未选课学生列表失败</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // 更新添加学生表格
        function updateAddStudentsTable(students) {
            const tbody = document.getElementById('add-students-table-body');
            
            if (!tbody) return;
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">该课程下没有可添加的学生</p>
                                <p class="text-xs text-dark-2 mt-1">所有学生都已分配到班级</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr class="hover:bg-light-1/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="student-class-checkbox rounded border-light-2 text-primary focus:ring-primary"
                               data-id="${student.id}" ${selectedStudentsForClass.has(student.id) ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${student.username}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${student.student_id || '未设置'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${student.email || '未设置'}</td>
                </tr>
            `).join('');
            
            // 更新全选复选框状态
            updateAddStudentsSelectAllCheckbox();
            
            // 添加复选框事件监听
            addClassCheckboxEventListeners();
        }

        // 添加班级复选框事件监听
        function addClassCheckboxEventListeners() {
            const checkboxes = document.querySelectorAll('.student-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const studentId = parseInt(this.dataset.id);
                    if (this.checked) {
                        selectedStudentsForClass.add(studentId);
                    } else {
                        selectedStudentsForClass.delete(studentId);
                    }
                    updateAddStudentsSelectAllCheckbox();
                    updateSelectedStudentsCount();
                });
            });
        }

        // 更新添加学生全选复选框状态
        function updateAddStudentsSelectAllCheckbox() {
            const selectAll = document.getElementById('add-students-select-all');
            if (!selectAll) return;
            
            const checkboxes = document.querySelectorAll('.student-class-checkbox');
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        // 更新选中学生计数
        function updateSelectedStudentsCount() {
            const selectedCount = document.getElementById('selected-students-count');
            if (selectedCount) {
                selectedCount.textContent = `已选择 ${selectedStudentsForClass.size} 名学生`;
            }
        }

        // 全选学生
        function selectAllStudentsForClass() {
            const checkboxes = document.querySelectorAll('.student-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const studentId = parseInt(checkbox.dataset.id);
                selectedStudentsForClass.add(studentId);
            });
            updateAddStudentsSelectAllCheckbox();
            updateSelectedStudentsCount();
        }

        // 取消全选
        function deselectAllStudentsForClass() {
            const checkboxes = document.querySelectorAll('.student-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const studentId = parseInt(checkbox.dataset.id);
                selectedStudentsForClass.delete(studentId);
            });
            updateAddStudentsSelectAllCheckbox();
            updateSelectedStudentsCount();
        }

        // 提交添加学生到班级
        async function submitAddStudents() {
            if (selectedStudentsForClass.size === 0) {
                showNotification('请至少选择一名学生', 'warning');
                return;
            }

            if (!currentClassId) {
                showNotification('班级信息错误', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/classes/${currentClassId}/enroll-students`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_ids: Array.from(selectedStudentsForClass)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`成功添加 ${result.data.added_count} 名学生到班级`, 'success');
                    closeAddStudentsModal();
                    // 重新加载班级列表
                    loadCourseClasses(currentCourseId);
                } else {
                    showNotification(result.message || '添加学生失败', 'error');
                }

            } catch (error) {
                console.error('添加学生失败:', error);
                showNotification('添加学生失败，请重试', 'error');
            }
        }

        // 全选复选框事件
        document.addEventListener('DOMContentLoaded', function() {
            const selectAll = document.getElementById('add-students-select-all');
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.student-class-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const studentId = parseInt(checkbox.dataset.id);
                        if (this.checked) {
                            selectedStudentsForClass.add(studentId);
                        } else {
                            selectedStudentsForClass.delete(studentId);
                        }
                    });
                    updateSelectedStudentsCount();
                });
            }

            // 添加学生搜索功能
            const addStudentsSearch = document.getElementById('add-students-search');
            let addStudentsSearchTimeout;
            
            if (addStudentsSearch) {
                addStudentsSearch.addEventListener('input', function(e) {
                    clearTimeout(addStudentsSearchTimeout);
                    const searchTerm = e.target.value.trim();
                    
                    addStudentsSearchTimeout = setTimeout(() => {
                        loadUnenrolledStudents(currentCourseId, searchTerm);
                    }, 300);
                });
                
                addStudentsSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(addStudentsSearchTimeout);
                        const searchTerm = e.target.value.trim();
                        loadUnenrolledStudents(currentCourseId, searchTerm);
                    }
                });
            }
        });

        // 筛选学生
        function filterStudentsForClass(searchTerm) {
            const rows = document.querySelectorAll('#add-students-table-body tr');
            rows.forEach(row => {
                const studentName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const studentId = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                
                if (searchTerm === '' || 
                    studentName.includes(searchTerm.toLowerCase()) ||
                    studentId.includes(searchTerm.toLowerCase()) ||
                    email.includes(searchTerm.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 打开注册学生模态框
        function openRegisterStudentModal() {
            // 清空表单
            document.getElementById('register-username').value = '';
            document.getElementById('register-student-id').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-telenum').value = '';

            // 显示模态框
            document.getElementById('register-student-modal').classList.remove('hidden');
        }

        // 关闭注册学生模态框
        function closeRegisterStudentModal() {
            document.getElementById('register-student-modal').classList.add('hidden');
        }

        // 打开批量注册学生模态框
        function openBatchRegisterModal() {
            // 重置表单和界面
            document.getElementById('batch-register-file').value = '';
            document.getElementById('batch-register-results').style.display = 'none';
            document.getElementById('batch-register-result-content').style.display = 'none';
            document.getElementById('batch-register-loading').style.display = 'none';
            document.getElementById('batch-register-success-section').style.display = 'none';
            document.getElementById('batch-register-error-section').style.display = 'none';

            // 显示模态框
            document.getElementById('batch-register-modal').classList.remove('hidden');
        }

        // 关闭批量注册学生模态框
        function closeBatchRegisterModal() {
            document.getElementById('batch-register-modal').classList.add('hidden');
        }

        // 导入学生功能 - 直接上传文件到批量注册接口
        function openImportStudentsModal() {
            const fileInput = document.getElementById('batch-register-file');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('请先选择CSV文件', 'warning');
                return;
            }

            // 直接上传文件到后端批量接口
            processImportStudentsCSV(file);
        }

        // 处理导入学生CSV - 直接上传文件到批量注册接口
        async function processImportStudentsCSV(file) {
            try {
                // 显示加载状态
                document.getElementById('batch-register-results').style.display = 'block';
                document.getElementById('batch-register-loading').style.display = 'block';
                document.getElementById('batch-register-result-content').style.display = 'none';

                // 禁用所有按钮
                const buttons = ['batch-register-btn', 'import-students-btn', 'download-template-btn'];
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';
                    }
                });

                // 创建FormData并上传文件
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/students/batch-register`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                });

                const result = await response.json();

                // 显示结果
                displayImportResults({
                    success_count: result.data?.success_count || 0,
                    error_count: result.data?.error_count || 0,
                    success_students: result.data?.processed_students || [],
                    error_messages: result.data?.error_messages || []
                });

            } catch (error) {
                console.error('批量注册失败:', error);
                showNotification('批量注册失败，请重试', 'error');
                
                // 隐藏加载状态
                document.getElementById('batch-register-loading').style.display = 'none';
                document.getElementById('batch-register-result-content').style.display = 'block';

                // 恢复按钮状态
                restoreButtons();
            }
        }

        // 显示导入结果
        function displayImportResults(results) {
            // 隐藏加载状态
            document.getElementById('batch-register-loading').style.display = 'none';
            document.getElementById('batch-register-result-content').style.display = 'block';

            // 显示处理结果摘要
            const summary = document.getElementById('batch-register-summary');
            summary.textContent = `成功: ${results.success_count} 个，失败: ${results.error_count} 个`;

            // 显示成功注册的学生
            if (results.success_count > 0) {
                document.getElementById('batch-register-success-section').style.display = 'block';
                const successList = document.getElementById('batch-register-success-list');

                successList.innerHTML = results.success_students.map(student => `
                    <tr class="border-b border-light-2">
                        <td class="px-3 py-2">${student.username}</td>
                        <td class="px-3 py-2">${student.student_id}</td>
                        <td class="px-3 py-2">${student.email}</td>
                        <td class="px-3 py-2 text-primary font-medium">${student.default_password}</td>
                    </tr>
                `).join('');
            }

            // 显示错误信息
            if (results.error_count > 0) {
                document.getElementById('batch-register-error-section').style.display = 'block';
                const errorList = document.getElementById('batch-register-error-list');

                errorList.innerHTML = results.error_messages.map(error => `
                    <div class="p-3 bg-danger/5 rounded border border-danger/20 text-danger">
                        ${error}
                    </div>
                `).join('');
            }

            // 恢复按钮状态
            restoreButtons();

            // 显示总结果通知
            if (results.success_count > 0 && results.error_count === 0) {
                showNotification(`成功导入 ${results.success_count} 名学生`, 'success');
            } else if (results.success_count > 0 && results.error_count > 0) {
                showNotification(`部分导入成功：${results.success_count} 成功，${results.error_count} 失败`, 'warning');
            } else {
                showNotification(`导入失败：${results.error_count} 个学生数据有误`, 'error');
            }
        }

        // 恢复按钮状态
        function restoreButtons() {
            const buttons = [
                { id: 'batch-register-btn', text: '<i class="fa fa-upload"></i> 开始批量注册' },
                { id: 'import-students-btn', text: '<i class="fa fa-download"></i> 导入学生' },
                { id: 'download-template-btn', text: '<i class="fa fa-download"></i> 下载模板' }
            ];

            buttons.forEach(btn => {
                const button = document.getElementById(btn.id);
                if (button) {
                    button.disabled = false;
                    button.innerHTML = btn.text;
                }
            });
        }

        // 下载批量注册模板
        function downloadBatchRegisterTemplate() {
            // 创建CSV模板内容，使用UTF-8 BOM确保中文正确显示
            const csvContent = `\uFEFF用户名,学号,邮箱,手机号
张三,20240001,zhangsan@example.com,13800138001
李四,20240002,lisi@example.com,13800138002
王五,20240003,wangwu@example.com,13800138003`;

            // 创建下载链接，使用UTF-8编码
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            // 创建临时下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = '学生批量注册模板.csv';

            // 隐藏链接并触发下载
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // 清理资源
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification('模板下载成功，请使用UTF-8编码打开和编辑', 'success');
        }

        // 上传并处理CSV文件
        async function uploadBatchRegisterFile() {
            const fileInput = document.getElementById('batch-register-file');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('请先选择CSV文件', 'warning');
                return;
            }

            // 显示处理结果区域
            document.getElementById('batch-register-results').style.display = 'block';
            document.getElementById('batch-register-loading').style.display = 'block';
            document.getElementById('batch-register-result-content').style.display = 'none';

            // 禁用上传按钮
            const uploadBtn = document.getElementById('batch-register-btn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';

            try {
                // 创建FormData对象
                const formData = new FormData();
                formData.append('file', file);

                // 发送请求
                const response = await fetch(`${API_BASE}/students/batch-register`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                });

                const result = await response.json();

                // 隐藏加载状态
                document.getElementById('batch-register-loading').style.display = 'none';
                document.getElementById('batch-register-result-content').style.display = 'block';

                if (result.success) {
                    // 显示处理结果摘要
                    const summary = document.getElementById('batch-register-summary');
                    summary.textContent = `成功: ${result.data.success_count} 个，失败: ${result.data.error_count} 个`;

                    // 显示成功注册的学生
                    if (result.data.success_count > 0) {
                        document.getElementById('batch-register-success-section').style.display = 'block';
                        const successList = document.getElementById('batch-register-success-list');

                        successList.innerHTML = result.data.processed_students.map(student => `
                            <tr class="border-b border-light-2">
                                <td class="px-3 py-2">${student.username}</td>
                                <td class="px-3 py-2">${student.student_id}</td>
                                <td class="px-3 py-2">${student.email}</td>
                                <td class="px-3 py-2 text-primary font-medium">${student.default_password}</td>
                            </tr>
                        `).join('');
                    }

                    // 显示错误信息
                    if (result.data.error_count > 0) {
                        document.getElementById('batch-register-error-section').style.display = 'block';
                        const errorList = document.getElementById('batch-register-error-list');

                        errorList.innerHTML = result.data.error_messages.map(error => `
                            <div class="p-3 bg-danger/5 rounded border border-danger/20 text-danger">
                                ${error}
                            </div>
                        `).join('');
                    }

                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message || '批量注册失败', 'error');
                }

            } catch (error) {
                console.error('批量注册失败:', error);
                showNotification('网络错误，请重试', 'error');

                // 隐藏加载状态
                document.getElementById('batch-register-loading').style.display = 'none';
                document.getElementById('batch-register-result-content').style.display = 'block';
            } finally {
                // 恢复上传按钮
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fa fa-upload"></i> 开始批量注册';
            }
        }

        // 提交注册学生表单
        async function submitRegisterStudent() {
            const formData = {
                username: document.getElementById('register-username').value.trim(),
                student_id: document.getElementById('register-student-id').value.trim(),
                email: document.getElementById('register-email').value.trim(),
                telenum: document.getElementById('register-telenum').value.trim(),
                password: document.getElementById('register-student-id').value.trim() // 初始密码为学号
            };

            // 验证必填字段
            if (!formData.username || !formData.student_id || !formData.email || !formData.telenum) {
                showNotification('请填写所有必填字段', 'warning');
                return;
            }

            // 验证邮箱格式
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                showNotification('请输入有效的邮箱地址', 'warning');
                return;
            }

            // 验证手机号格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(formData.telenum)) {
                showNotification('请输入有效的手机号', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/students/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('学生账号创建成功！初始密码为学号', 'success');
                    closeRegisterStudentModal();
                    // 可选：重新加载学生列表
                } else {
                    showNotification(result.message || '学生账号创建失败', 'error');
                }

            } catch (error) {
                console.error('注册学生失败:', error);
                showNotification('学生账号创建失败，请重试', 'error');
            }
        }

        // 模态框点击外部关闭
        document.addEventListener('DOMContentLoaded', function() {
            // 编辑个人资料模态框
            const editModal = document.getElementById('edit-profile-modal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === editModal) {
                        closeEditProfileModal();
                    }
                });
            }

            // 注册学生模态框
            const registerModal = document.getElementById('register-student-modal');
            if (registerModal) {
                registerModal.addEventListener('click', function(e) {
                    if (e.target === registerModal) {
                        closeRegisterStudentModal();
                    }
                });
            }

            // 题目详情模态框
            const problemDetailModal = document.getElementById('problem-detail-modal');
            if (problemDetailModal) {
                problemDetailModal.addEventListener('click', function(e) {
                    if (e.target === problemDetailModal) {
                        closeProblemDetailModal();
                    }
                });
            }
        });

        // 修改密码功能
        document.addEventListener('DOMContentLoaded', function() {
            const changePasswordForm = document.getElementById('change-password-form');
            const oldPasswordInput = document.getElementById('old-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const passwordMatchError = document.getElementById('password-match-error');
            const passwordLengthRequirement = document.getElementById('password-length');
            const submitBtn = document.getElementById('submit-password-btn');

            // 密码长度验证
            function validatePasswordLength() {
                if (newPasswordInput.value.length >= 6) {
                    passwordLengthRequirement.classList.remove('text-danger');
                    passwordLengthRequirement.classList.add('text-success');
                    return true;
                } else {
                    passwordLengthRequirement.classList.remove('text-success');
                    passwordLengthRequirement.classList.add('text-danger');
                    return false;
                }
            }

            // 密码匹配验证
            function validatePasswordMatch() {
                if (newPasswordInput.value === confirmPasswordInput.value) {
                    passwordMatchError.classList.add('hidden');
                    return true;
                } else {
                    passwordMatchError.classList.remove('hidden');
                    return false;
                }
            }

            // 实时验证密码长度
            newPasswordInput.addEventListener('input', validatePasswordLength);

            // 实时验证密码匹配
            confirmPasswordInput.addEventListener('input', validatePasswordMatch);

            // 表单提交
            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = {
                    old_password: oldPasswordInput.value,
                    new_password: newPasswordInput.value,
                    confirm_password: confirmPasswordInput.value
                };

                // 表单验证
                if (!formData.old_password || !formData.new_password || !formData.confirm_password) {
                    showNotification('请填写所有必填字段', 'warning');
                    return;
                }

                if (!validatePasswordLength()) {
                    showNotification('新密码长度不能少于6位', 'warning');
                    return;
                }

                if (!validatePasswordMatch()) {
                    showNotification('两次输入的密码不一致', 'warning');
                    return;
                }

                // 禁用提交按钮
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 修改中...';
                }

                try {
                    const response = await fetch(`${API_BASE}/teachers/change-password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification('密码修改成功，请重新登录', 'success');
                        // 清空表单
                        changePasswordForm.reset();
                        // 重置验证状态
                        validatePasswordLength();
                        passwordMatchError.classList.add('hidden');
                        // 跳转到登录页面或要求重新登录
                        setTimeout(() => {
                            window.location.href = '/logout';
                        }, 2000);
                    } else {
                        showNotification(result.message || '密码修改失败', 'error');
                    }
                } catch (error) {
                    console.error('修改密码失败:', error);
                    showNotification('网络错误，请重试', 'error');
                } finally {
                    // 恢复提交按钮
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-save"></i> 修改密码';
                    }
                }
            });
        });

        // 删除学生相关变量
        let selectedStudentsToDelete = new Set();

        // 打开批量导入学生到班级模态框
        function openBatchImportStudentsModal() {
            // 重置表单
            document.getElementById('import-course-select').value = '';
            document.getElementById('import-class-select').value = '';
            document.getElementById('import-students-file').value = '';
            document.getElementById('import-results').style.display = 'none';
            document.getElementById('import-loading').style.display = 'none';
            document.getElementById('import-result-content').style.display = 'none';

            // 加载教师课程列表
            loadImportCourses();

            // 显示模态框
            document.getElementById('batch-import-students-modal').classList.remove('hidden');
        }

        // 关闭批量导入学生到班级模态框
        function closeBatchImportModal() {
            document.getElementById('batch-import-students-modal').classList.add('hidden');
        }

        // 加载导入课程列表
        async function loadImportCourses() {
            try {
                const response = await fetch(`${API_BASE}/teachers/current/courses`);
                const result = await response.json();

                if (result.success) {
                    populateImportCourseSelect(result.data);
                } else {
                    showNotification('获取课程列表失败: ' + (result.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载课程列表失败:', error);
                showNotification('加载课程列表失败: ' + error.message, 'error');
            }
        }

        // 填充导入课程选择下拉框
        function populateImportCourseSelect(courses) {
            const courseSelect = document.getElementById('import-course-select');

            // 清空现有选项
            courseSelect.innerHTML = '<option value="">请选择课程...</option>';

            if (courses.length === 0) {
                showNotification('您目前没有教授任何课程', 'warning');
                return;
            }

            // 添加课程选项
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelect.appendChild(option);
            });
        }

        // 加载导入班级列表
        async function loadImportClasses(courseId) {
            if (!courseId) {
                const classSelect = document.getElementById('import-class-select');
                classSelect.innerHTML = '<option value="">请先选择课程...</option>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/teacher/classes?course_id=${courseId}`);
                const result = await response.json();

                if (result.success) {
                    populateImportClassSelect(result.data);
                } else {
                    showNotification('获取班级列表失败: ' + (result.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载班级列表失败:', error);
                showNotification('加载班级列表失败: ' + error.message, 'error');
            }
        }

        // 填充导入班级选择下拉框
        function populateImportClassSelect(classes) {
            const classSelect = document.getElementById('import-class-select');

            // 清空现有选项
            classSelect.innerHTML = '<option value="">请选择班级...</option>';

            if (classes.length === 0) {
                showNotification('该课程下没有班级', 'warning');
                return;
            }

            // 添加班级选项
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });
        }

        // 处理批量导入
        async function processBatchImport() {
            const courseSelect = document.getElementById('import-course-select');
            const classSelect = document.getElementById('import-class-select');
            const fileInput = document.getElementById('import-students-file');

            // 表单验证
            if (!courseSelect.value) {
                showNotification('请先选择课程', 'warning');
                return;
            }

            if (!classSelect.value) {
                showNotification('请先选择班级', 'warning');
                return;
            }

            if (!fileInput.files[0]) {
                showNotification('请先选择CSV文件', 'warning');
                return;
            }

            const file = fileInput.files[0];

            // 显示处理结果区域
            document.getElementById('import-results').style.display = 'block';
            document.getElementById('import-loading').style.display = 'block';
            document.getElementById('import-result-content').style.display = 'none';

            // 禁用按钮
            const importBtn = document.getElementById('batch-import-btn');
            importBtn.disabled = true;
            importBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';

            try {
                // 创建FormData对象
                const formData = new FormData();
                formData.append('file', file);
                formData.append('class_id', classSelect.value);

                // 发送请求
                const response = await fetch(`${API_BASE}/classes/batch-import-students`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                });

                const result = await response.json();

                // 隐藏加载状态
                document.getElementById('import-loading').style.display = 'none';
                document.getElementById('import-result-content').style.display = 'block';

                if (result.success) {
                    // 显示处理结果摘要
                    const summary = document.getElementById('import-summary');
                    summary.textContent = `成功: ${result.data.success_count} 个，失败: ${result.data.error_count} 个`;

                    // 显示成功导入的学生
                    if (result.data.success_count > 0) {
                        document.getElementById('import-success-section').style.display = 'block';
                        const successList = document.getElementById('import-success-list');

                        successList.innerHTML = result.data.success_students.map(student => `
                            <tr class="border-b border-light-2">
                                <td class="px-3 py-2">${student.username}</td>
                                <td class="px-3 py-2">${student.student_id || '未设置'}</td>
                                <td class="px-3 py-2">${student.email || '未设置'}</td>
                                <td class="px-3 py-2 text-success font-medium">导入成功</td>
                            </tr>
                        `).join('');
                    }

                    // 显示错误信息
                    if (result.data.error_count > 0) {
                        document.getElementById('import-error-section').style.display = 'block';
                        const errorList = document.getElementById('import-error-list');

                        errorList.innerHTML = result.data.error_messages.map(error => `
                            <div class="p-3 bg-danger/5 rounded border border-danger/20 text-danger">
                                ${error}
                            </div>
                        `).join('');
                    }

                    showNotification(result.message, 'success');

                    // 重新加载班级列表
                    loadCourseClasses(courseSelect.value);
                } else {
                    showNotification(result.message || '批量导入失败', 'error');
                }
            } catch (error) {
                console.error('批量导入失败:', error);
                showNotification('网络错误，请重试', 'error');

                // 隐藏加载状态
                document.getElementById('import-loading').style.display = 'none';
                document.getElementById('import-result-content').style.display = 'block';
            } finally {
                // 恢复按钮状态
                importBtn.disabled = false;
                importBtn.innerHTML = '<i class="fa fa-upload"></i> 开始批量导入';
            }
        }

        // 下载导入模板
        function downloadImportTemplate() {
            // 创建CSV模板内容，使用UTF-8 BOM确保中文正确显示
            const csvContent = `\uFEFF用户名,学号,邮箱,手机号
张三,20240001,zhangsan@example.com,13800138001
李四,20240002,lisi@example.com,13800138002
王五,20240003,wangwu@example.com,13800138003`;

            // 创建下载链接，使用UTF-8编码
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            // 创建临时下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = '学生批量导入模板.csv';

            // 隐藏链接并触发下载
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // 清理资源
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification('模板下载成功，请使用UTF-8编码打开和编辑', 'success');
        }

        // 打开删除学生模态框
        function openDeleteStudentModal() {
            selectedStudentsToDelete.clear();
            document.getElementById('delete-student-modal').classList.remove('hidden');
            loadAllStudents();
        }

        // 关闭删除学生模态框
        function closeDeleteStudentModal() {
            document.getElementById('delete-student-modal').classList.add('hidden');
            selectedStudentsToDelete.clear();
        }

        // 加载所有学生列表
        async function loadAllStudents(searchTerm = '') {
            try {
                const url = searchTerm ?
                    `${API_BASE}/students?search=${encodeURIComponent(searchTerm)}` :
                    `${API_BASE}/students`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    updateDeleteStudentsTable(result.data);
                } else {
                    showNotification('获取学生列表失败', 'error');
                }
            } catch (error) {
                console.error('加载学生列表失败:', error);
                showNotification('加载学生列表失败', 'error');
            }
        }

        // 更新删除学生表格
        function updateDeleteStudentsTable(students) {
            const tbody = document.getElementById('delete-students-table-body');
            const totalCount = document.getElementById('total-students-count');

            if (!tbody || !totalCount) return;

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-dark-2">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                                <p class="text-sm">没有找到学生数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                totalCount.textContent = '0';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr class="hover:bg-light-1/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="delete-student-checkbox rounded border-light-2 text-primary focus:ring-primary"
                               data-id="${student.student_id}" ${selectedStudentsToDelete.has(student.student_id) ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${student.username}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${student.student_number || '未设置'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${student.email || '未设置'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${student.telenum || '未设置'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${formatDate(student.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button class="text-danger hover:underline" onclick="deleteSingleStudent(${student.student_id}, '${student.username}')">
                            删除
                        </button>
                    </td>
                </tr>
            `).join('');

            totalCount.textContent = students.length;

            // 添加复选框事件监听
            addDeleteStudentCheckboxListeners();
        }

        // 添加删除学生复选框事件监听
        function addDeleteStudentCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.delete-student-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const studentId = parseInt(this.dataset.id);
                    if (this.checked) {
                        selectedStudentsToDelete.add(studentId);
                    } else {
                        selectedStudentsToDelete.delete(studentId);
                    }
                    updateDeleteStudentsSelectAllCheckbox();
                    updateSelectedDeleteCount();
                });
            });
        }

        // 更新全选复选框状态
        function updateDeleteStudentsSelectAllCheckbox() {
            const selectAll = document.getElementById('delete-students-select-all');
            if (!selectAll) return;

            const checkboxes = document.querySelectorAll('.delete-student-checkbox');
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);

            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        // 更新选中计数
        function updateSelectedDeleteCount() {
            const selectedCount = document.getElementById('selected-delete-count');
            const deleteBtn = document.getElementById('delete-selected-btn');

            if (selectedCount) {
                selectedCount.textContent = selectedStudentsToDelete.size;
            }

            if (deleteBtn) {
                deleteBtn.disabled = selectedStudentsToDelete.size === 0;
            }
        }

        // 删除单个学生
        async function deleteSingleStudent(studentId, studentName) {
            if (!confirm(`确定要删除学生 "${studentName}" 吗？\n\n删除后该学生的账号将被注销，无法恢复。`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/students/${studentId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    loadAllStudents(); // 重新加载学生列表
                } else {
                    showNotification(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除学生失败:', error);
                showNotification('删除学生失败，请重试', 'error');
            }
        }

        // 确认删除多个学生
        function confirmDeleteStudents() {
            if (selectedStudentsToDelete.size === 0) {
                showNotification('请先选择要删除的学生', 'warning');
                return;
            }

            const count = selectedStudentsToDelete.size;
            if (!confirm(`确定要删除选中的 ${count} 名学生吗？\n\n删除后这些学生的账号将被注销，无法恢复。`)) {
                return;
            }

            deleteSelectedStudents();
        }

        // 删除选中的学生
        async function deleteSelectedStudents() {
            const deleteBtn = document.getElementById('delete-selected-btn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 删除中...';

            let successCount = 0;
            let failCount = 0;

            for (const studentId of selectedStudentsToDelete) {
                try {
                    const response = await fetch(`${API_BASE}/students/${studentId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error(`删除学生 ${studentId} 失败:`, error);
                    failCount++;
                }
            }

            // 显示结果
            if (successCount > 0 && failCount === 0) {
                showNotification(`成功删除 ${successCount} 名学生`, 'success');
            } else if (successCount > 0 && failCount > 0) {
                showNotification(`部分删除成功：${successCount} 成功，${failCount} 失败`, 'warning');
            } else {
                showNotification(`删除失败：${failCount} 个学生删除失败`, 'error');
            }

            // 恢复按钮状态
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="fa fa-trash"></i> 删除选中学生';

            // 清空选择并重新加载列表
            selectedStudentsToDelete.clear();
            updateSelectedDeleteCount();
            loadAllStudents();
        }

        // 作业管理相关功能
        function viewAssignment(assignmentId) {
            // 显示模态框
            document.getElementById('assignment-detail-modal').classList.remove('hidden');

            // 显示加载状态
            const content = document.getElementById('assignment-detail-content');
            content.innerHTML = `
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载作业详情...</p>
                </div>
            `;

            // 加载作业详情
            loadAssignmentDetail(assignmentId);
        }

        // 加载作业详情
        async function loadAssignmentDetail(assignmentId) {
            try {
                const response = await fetch(`${API_BASE}/teacher/assignments/${assignmentId}`);
                const result = await response.json();

                if (result.success) {
                    displayAssignmentDetail(result.data);
                } else {
                    showNotification(result.message || '获取作业详情失败', 'error');
                    closeAssignmentDetailModal();
                }
            } catch (error) {
                console.error('加载作业详情失败:', error);
                showNotification('加载作业详情失败', 'error');
                closeAssignmentDetailModal();
            }
        }

        // 显示作业详情
        function displayAssignmentDetail(assignment) {
            const content = document.getElementById('assignment-detail-content');

            // 构建作业基本信息
            let html = `
                <div class="space-y-6">
                    <!-- 作业基本信息 -->
                    <div class="bg-light-1 p-4 rounded-lg">
                        <h4 class="font-semibold text-dark mb-3">作业基本信息</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><span class="text-dark-2">作业标题：</span><span class="font-medium">${assignment.title || '无'}</span></div>
                            <div><span class="text-dark-2">所属班级：</span><span class="font-medium">${assignment.class_name || '无'}</span></div>
                            <div><span class="text-dark-2">所属课程：</span><span class="font-medium">${assignment.course_name || '无'}</span></div>
                            <div><span class="text-dark-2">编程语言：</span><span class="font-medium">${assignment.course_language || '无'}</span></div>
                            <div><span class="text-dark-2">发布时间：</span><span class="font-medium">${assignment.publish_date || '无'}</span></div>
                            <div><span class="text-dark-2">截止时间：</span><span class="font-medium">${assignment.deadline || '无'}</span></div>
                            <div><span class="text-dark-2">题目数量：</span><span class="font-medium">${assignment.question_count || 0} 道</span></div>
                            <div><span class="text-dark-2">创建时间：</span><span class="font-medium">${assignment.created_at || '无'}</span></div>
                        </div>
                        ${assignment.description ? `
                            <div class="mt-4">
                                <span class="text-dark-2">作业描述：</span>
                                <p class="text-dark mt-1 whitespace-pre-line">${assignment.description}</p>
                            </div>
                        ` : ''}
                    </div>
            `;

            // 构建题目列表
            if (assignment.questions && assignment.questions.length > 0) {
                html += `
                    <!-- 题目列表 -->
                    <div class="bg-white border border-light-2 rounded-lg overflow-hidden">
                        <div class="bg-light-1 px-4 py-3 border-b border-light-2">
                            <h4 class="font-semibold text-dark">包含的题目</h4>
                        </div>
                        <div class="divide-y divide-light-2">
                `;

                assignment.questions.forEach((question, index) => {
                    const questionTypeText = getProblemTypeText(question.question_type);
                    const difficultyColor = getDifficultyColor(question.difficulty);

                    html += `
                        <div class="p-4 hover:bg-light-1/50 transition-colors">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded">${index + 1}</span>
                                        <span class="badge ${getProblemTypeColor(question.question_type)}">${questionTypeText}</span>
                                        <span class="badge ${difficultyColor}">${question.difficulty || '未知难度'}</span>
                                        <span class="badge bg-light-2 text-dark-2">${question.language || '未知语言'}</span>
                                    </div>
                                    <h5 class="font-medium text-dark mb-2">${question.title || '无标题'}</h5>
                                    <p class="text-sm text-dark-2 mb-2">${question.description || '暂无描述'}</p>
                                    ${question.knowledge_points ? `
                                        <p class="text-sm text-dark-2"><strong>知识点：</strong>${question.knowledge_points}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <!-- 无题目提示 -->
                    <div class="bg-white border border-light-2 rounded-lg p-8 text-center">
                        <i class="fa fa-question-circle text-4xl text-light-3 mb-3"></i>
                        <p class="text-dark-2">该作业暂无题目</p>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            content.innerHTML = html;
        }

        // 获取难度颜色
        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case '简单': return 'bg-success/10 text-success';
                case '中等': return 'bg-warning/10 text-warning';
                case '困难': return 'bg-danger/10 text-danger';
                default: return 'bg-light-2 text-dark-2';
            }
        }

        // 关闭作业详情模态框
        function closeAssignmentDetailModal() {
            document.getElementById('assignment-detail-modal').classList.add('hidden');
        }

        function editAssignment(assignmentId) {
            // 这里可以实现编辑作业的逻辑
            showNotification(`编辑作业 ID: ${assignmentId}`, 'info');
        }

        function viewAssignmentStats(assignmentId) {
            // 这里可以实现查看作业统计的逻辑
            showNotification(`查看作业统计 ID: ${assignmentId}`, 'info');
        }

        // 创建作业相关变量
        let selectedClassesForAssignment = new Set();
        let selectedProblemsForAssignment = new Map(); // 改为Map以存储ID和类型信息
        let selectedCourseForAssignment = null;
        let teacherCourses = [];
        let currentProblemList = []; // 存储当前显示的所有题目数据

        // 打开创建作业模态框
        function openCreateAssignmentModal() {
            console.log('打开创建作业模态框');

            // 检查登录状态
            if (!checkTeacherLoginStatus()) {
                showNotification('请先登录教师账号', 'warning');
                return;
            }

            // 重置表单
            document.getElementById('assignment-name').value = '';
            document.getElementById('publish-date').value = '';
            document.getElementById('deadline').value = '';

            // 清空选择
            selectedClassesForAssignment.clear();
            selectedProblemsForAssignment.clear();
            selectedCourseForAssignment = null;

            // 重置计数显示
            updateSelectedClassesCount();
            updateSelectedProblemsCount();

            // 显示模态框
            document.getElementById('create-assignment-modal').classList.remove('hidden');

            // 显示加载状态
            document.getElementById('classes-selection-area').innerHTML = `
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-info-circle text-2xl text-light-3 mb-3"></i>
                    <p class="text-sm">请先选择课程</p>
                </div>
            `;
            document.getElementById('problems-selection-area').innerHTML = `
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-info-circle text-2xl text-light-3 mb-3"></i>
                    <p class="text-sm">请先选择课程</p>
                </div>
            `;

            // 加载教师课程列表
            loadTeacherCoursesForAssignment();
        }

        // 检查教师登录状态
        function checkTeacherLoginStatus() {
            // 这里可以检查是否有有效的会话信息
            // 简单检查是否可以访问教师专用的API
            return true; // 暂时返回true，实际应该检查会话状态
        }

        // 关闭创建作业模态框
        function closeCreateAssignmentModal() {
            document.getElementById('create-assignment-modal').classList.add('hidden');
            selectedClassesForAssignment.clear();
            selectedProblemsForAssignment.clear();
            selectedCourseForAssignment = null;
        }

        // 加载教师课程列表用于作业创建
        async function loadTeacherCoursesForAssignment() {
            console.log('开始加载教师课程列表...');
            try {
                const response = await fetch(`${API_BASE}/teachers/current/courses`);
                console.log('课程API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('课程API响应数据:', result);

                if (result.success) {
                    teacherCourses = result.data;
                    populateCourseSelectForAssignment(result.data);
                } else {
                    console.error('获取课程列表失败:', result.message);
                    showNotification('获取课程列表失败: ' + (result.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载课程列表失败:', error);
                showNotification('加载课程列表失败: ' + error.message, 'error');
            }
        }

        // 填充课程选择下拉框用于作业创建
        function populateCourseSelectForAssignment(courses) {
            const courseSelect = document.getElementById('assignment-course-select');

            // 清空现有选项
            courseSelect.innerHTML = '<option value="">请选择课程...</option>';

            if (courses.length === 0) {
                showNotification('您目前没有教授任何课程', 'warning');
                return;
            }

            // 添加课程选项
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelect.appendChild(option);
            });
        }

        // 课程选择变化处理函数
        function onCourseSelectionChange() {
            const courseSelect = document.getElementById('assignment-course-select');
            const selectedCourseId = courseSelect.value;

            if (!selectedCourseId) {
                // 没有选择课程，清空班级和题目选择
                selectedCourseForAssignment = null;
                selectedClassesForAssignment.clear();
                selectedProblemsForAssignment.clear();
                updateSelectedClassesCount();
                updateSelectedProblemsCount();

                document.getElementById('classes-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-info-circle text-2xl text-light-3 mb-3"></i>
                        <p class="text-sm">请先选择课程</p>
                    </div>
                `;
                document.getElementById('problems-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-info-circle text-2xl text-light-3 mb-3"></i>
                        <p class="text-sm">请先选择课程</p>
                    </div>
                `;
                return;
            }

            // 设置选中的课程
            selectedCourseForAssignment = teacherCourses.find(c => c.id == selectedCourseId);

            // 清空之前的选择
            selectedClassesForAssignment.clear();
            selectedProblemsForAssignment.clear();
            updateSelectedClassesCount();
            updateSelectedProblemsCount();

            // 加载该课程的班级
            loadClassesForSelectedCourse(selectedCourseId);

            // 加载该课程的题目（根据课程的编程语言过滤）
            loadProblemsForSelectedCourse(selectedCourseId).catch(error => {
                console.error('加载题目失败:', error);
            });
        }

        // 加载指定课程的班级
        async function loadClassesForSelectedCourse(courseId) {
            console.log('开始加载课程班级列表...', courseId);
            try {
                // 显示加载状态
                document.getElementById('classes-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                        <p class="text-sm">正在加载班级列表...</p>
                    </div>
                `;

                const response = await fetch(`${API_BASE}/teacher/classes?course_id=${courseId}`);
                console.log('班级API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('班级API响应数据:', result);

                if (result.success) {
                    console.log('成功获取班级列表:', result.data);
                    displayClassesForAssignment(result.data);
                } else {
                    console.error('获取班级列表失败:', result.message);
                    showNotification('获取班级列表失败: ' + (result.message || '未知错误'), 'error');
                    document.getElementById('classes-selection-area').innerHTML = `
                        <div class="text-center py-8 text-dark-2">
                            <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                            <p class="text-sm">获取班级列表失败</p>
                            <p class="text-xs text-dark-2 mt-1">${result.message || '请稍后重试'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载班级列表失败:', error);
                showNotification('加载班级列表失败: ' + error.message, 'error');
                document.getElementById('classes-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                        <p class="text-sm">加载班级列表失败</p>
                        <p class="text-xs text-dark-2 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // 加载指定课程的题目
        async function loadProblemsForSelectedCourse(courseId) {
            console.log('开始加载课程题目列表...', courseId);
            try {
                // 显示加载状态
                document.getElementById('problems-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                        <p class="text-sm">正在加载题目列表...</p>
                    </div>
                `;

                // 第一步：获取课程的语言信息
                const courseResponse = await fetch(`${API_BASE}/teachers/current/courses`);
                if (!courseResponse.ok) {
                    throw new Error('获取课程信息失败');
                }

                const courseResult = await courseResponse.json();
                if (!courseResult.success) {
                    throw new Error(courseResult.message || '获取课程信息失败');
                }

                // 查找选中课程的语言信息
                const selectedCourse = courseResult.data.find(c => c.id == courseId);
                if (!selectedCourse) {
                    throw new Error('未找到课程信息');
                }

                const courseLanguage = selectedCourse.language;
                console.log('课程语言:', courseLanguage);

                // 第二步：根据课程语言过滤题目
                let url = `${API_BASE}/question-bank/problems`;
                const params = new URLSearchParams();
                // 设置较大的每页数量以获取所有题目
                params.append('per_page', '1000');
                params.append('page', '1');

                // 如果课程有语言设置，则添加语言过滤
                if (courseLanguage) {
                    params.append('language', courseLanguage);
                    console.log('应用语言过滤:', courseLanguage);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                console.log('题目API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('题目API响应数据:', result);

                if (result.success) {
                    console.log(`成功获取题目列表: ${result.data.length}道题目 (语言: ${courseLanguage || '全部'})`);
                    displayProblemsForAssignment(result.data, courseLanguage);
                } else {
                    console.error('获取题目列表失败:', result.message);
                    showNotification('获取题目列表失败: ' + (result.message || '未知错误'), 'error');
                    document.getElementById('problems-selection-area').innerHTML = `
                        <div class="text-center py-8 text-dark-2">
                            <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                            <p class="text-sm">获取题目列表失败</p>
                            <p class="text-xs text-dark-2 mt-1">${result.message || '请稍后重试'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载题目列表失败:', error);
                showNotification('加载题目列表失败: ' + error.message, 'error');
                document.getElementById('problems-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                        <p class="text-sm">加载题目列表失败</p>
                        <p class="text-xs text-dark-2 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // 加载教师班级列表用于作业创建
        async function loadTeacherClassesForAssignment() {
            console.log('开始加载教师班级列表...');
            try {
                const response = await fetch(`${API_BASE}/teacher/classes`);
                console.log('班级API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('班级API响应数据:', result);

                if (result.success) {
                    console.log('成功获取班级列表:', result.data);
                    displayClassesForAssignment(result.data);
                } else {
                    console.error('获取班级列表失败:', result.message);
                    showNotification('获取班级列表失败: ' + (result.message || '未知错误'), 'error');
                    document.getElementById('classes-selection-area').innerHTML = `
                        <div class="text-center py-8 text-dark-2">
                            <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                            <p class="text-sm">获取班级列表失败</p>
                            <p class="text-xs text-dark-2 mt-1">${result.message || '请稍后重试'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载班级列表失败:', error);
                showNotification('加载班级列表失败: ' + error.message, 'error');
                document.getElementById('classes-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                        <p class="text-sm">加载班级列表失败</p>
                        <p class="text-xs text-dark-2 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // 显示班级列表用于选择
        function displayClassesForAssignment(classes) {
            const container = document.getElementById('classes-selection-area');

            if (classes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-users text-4xl text-light-3 mb-3"></i>
                        <p class="text-sm">您目前没有教授任何班级</p>
                    </div>
                `;
                return;
            }

            // 先显示班级列表，然后异步加载学生数量
            container.innerHTML = classes.map(cls => `
                <div class="flex items-center gap-3 p-3 rounded-lg border border-light-2 hover:bg-light-1 transition-colors">
                    <input type="checkbox" class="assignment-class-checkbox rounded border-light-2 text-primary focus:ring-primary"
                           data-class-id="${cls.id}" ${selectedClassesForAssignment.has(cls.id) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="font-medium">${cls.name}</div>
                        <div class="text-sm text-dark-2">${cls.course_name} - <span class="student-count-${cls.id}">加载中...</span></div>
                    </div>
                </div>
            `).join('');

            // 为每个班级异步加载学生数量
            classes.forEach(cls => {
                loadClassStudentCountForAssignment(cls.id);
            });

            // 添加复选框事件监听
            addAssignmentClassCheckboxListeners();
        }

        // 加载班级的学生数量用于作业创建
        async function loadClassStudentCountForAssignment(classId) {
            try {
                const response = await fetch(`${API_BASE}/classes/${classId}/student-count`);
                const result = await response.json();

                if (result.success) {
                    const countElement = document.querySelector(`.student-count-${classId}`);
                    if (countElement) {
                        countElement.textContent = `${result.data.student_count}人`;
                    }
                } else {
                    console.error(`获取班级 ${classId} 学生数量失败:`, result.message);
                    const countElement = document.querySelector(`.student-count-${classId}`);
                    if (countElement) {
                        countElement.textContent = '0人';
                    }
                }
            } catch (error) {
                console.error(`加载班级 ${classId} 学生数量失败:`, error);
                const countElement = document.querySelector(`.student-count-${classId}`);
                if (countElement) {
                    countElement.textContent = '0人';
                }
            }
        }

        // 添加班级复选框事件监听
        function addAssignmentClassCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.assignment-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const classId = parseInt(this.dataset.classId);
                    if (this.checked) {
                        selectedClassesForAssignment.add(classId);
                    } else {
                        selectedClassesForAssignment.delete(classId);
                    }
                    updateSelectedClassesCount();
                });
            });
        }

        // 加载题目列表用于作业创建
        async function loadProblemsForAssignment() {
            console.log('开始加载题目列表...');
            try {
                // 设置较大的每页数量以获取所有题目
                const params = new URLSearchParams({
                    per_page: '1000',
                    page: '1'
                });

                const response = await fetch(`${API_BASE}/question-bank/problems?${params}`);
                console.log('题目API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('题目API响应数据:', result);

                if (result.success) {
                    console.log('成功获取题目列表:', result.data);
                    displayProblemsForAssignment(result.data);
                } else {
                    console.error('获取题目列表失败:', result.message);
                    showNotification('获取题目列表失败: ' + (result.message || '未知错误'), 'error');
                    document.getElementById('problems-selection-area').innerHTML = `
                        <div class="text-center py-8 text-dark-2">
                            <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                            <p class="text-sm">获取题目列表失败</p>
                            <p class="text-xs text-dark-2 mt-1">${result.message || '请稍后重试'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载题目列表失败:', error);
                showNotification('加载题目列表失败: ' + error.message, 'error');
                document.getElementById('problems-selection-area').innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-exclamation-triangle text-2xl text-warning mb-3"></i>
                        <p class="text-sm">加载题目列表失败</p>
                        <p class="text-xs text-dark-2 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // 显示题目列表用于选择（重新设计网格布局版本）
        function displayProblemsForAssignment(problems, language = null) {
            const container = document.getElementById('problems-selection-area');

            // 保存当前题目数据用于筛选功能
            currentProblemList = [...problems];

            // 调试信息
            console.log('displayProblemsForAssignment 被调用（网格版本）');
            console.log('接收到的题目数量:', problems.length);
            console.log('应用语言过滤:', language);
            console.log('题目详情:', problems);

            // 更新语言过滤信息显示
            const languageInfo = document.getElementById('language-filter-info');
            if (languageInfo) {
                if (language) {
                    languageInfo.textContent = `只显示${language}语言的题目`;
                    languageInfo.className = 'text-xs text-primary font-medium mt-1';
                } else {
                    languageInfo.textContent = '显示所有语言的题目';
                    languageInfo.className = 'text-xs text-dark-2 mt-1';
                }
            }

            if (problems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-question-circle text-4xl text-light-3 mb-3"></i>
                        <p class="text-sm">暂无可用题目</p>
                    </div>
                `;
                return;
            }

            // 调试信息
            console.log('开始渲染题目网格，题目数量:', problems.length);

            // 创建新的单列布局，提供更多空间
            container.innerHTML = `
                <div class="space-y-4">
                    ${problems.map((problem, index) => `
                        <div class="problem-card bg-white border border-light-2 rounded-lg p-6 hover:shadow-lg transition-all duration-200 hover:border-primary/30" data-problem-id="${problem.id}">
                            <!-- 题目主体 -->
                            <div class="flex items-start gap-4">
                                <!-- 复选框 -->
                                <input type="checkbox" class="assignment-problem-checkbox w-5 h-5 rounded border-light-2 text-primary focus:ring-primary mt-1"
                                        data-problem-id="${problem.id}" ${selectedProblemsForAssignment.has(problem.id) ? 'checked' : ''}>

                                <!-- 主要内容 -->
                                <div class="flex-1 min-w-0">
                                    <!-- 标题行 -->
                                    <div class="flex items-center gap-3 mb-3">
                                        <h4 class="font-semibold text-dark text-base">${problem.title || problem.name || '无标题'}</h4>
                                        <div class="flex gap-2 flex-shrink-0">
                                            <span class="badge ${getProblemTypeColor(problem.question_type)}">
                                                ${getProblemTypeText(problem.question_type)}
                                            </span>
                                            <span class="badge bg-secondary/10 text-secondary">${problem.difficulty || '未知难度'}</span>
                                        </div>
                                    </div>

                                    <!-- 编程语言和知识点 -->
                                    <div class="flex items-center gap-4 text-sm text-dark-2 mb-3">
                                        <div class="flex items-center gap-1">
                                            <i class="fa fa-code text-light-3"></i>
                                            <span>${problem.language || '未知语言'}</span>
                                        </div>
                                        ${problem.knowledge_points ? `
                                            <div class="flex items-center gap-1">
                                                <i class="fa fa-book text-light-3"></i>
                                                <span>${problem.knowledge_points}</span>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- 描述 -->
                                    <p class="text-dark-2 mb-4 leading-relaxed">${(problem.description || '暂无描述').substring(0, 150)}${(problem.description || '').length > 150 ? '...' : ''}</p>

                                    <!-- 操作按钮 -->
                                    <div class="flex items-center justify-between pt-3 border-t border-light-2">
                                        <div class="flex gap-3">
                                            <button class="preview-btn text-primary hover:text-primary/80 transition-colors font-medium">
                                                <i class="fa fa-eye mr-1"></i> 查看详情
                                            </button>
                                            <button class="text-dark-2 hover:text-primary transition-colors">
                                                <i class="fa fa-info-circle mr-1"></i> 预览
                                            </button>
                                            ${problem.solution_idea ? `<button class="hint-btn text-dark-2 hover:text-primary transition-colors" data-problem-id="${problem.id}" title="查看解题思路">
                                                <i class="fa fa-lightbulb-o mr-1"></i> 线索
                                            </button>` : ''}
                                        </div>
                                        <div class="text-sm text-dark-3 font-mono">
                                            ID: ${problem.id}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // 滚动到顶部，确保用户能看到题目列表
            container.scrollTop = 0;

            // 添加复选框事件监听
            addAssignmentProblemCheckboxListeners();

            // 添加预览按钮事件监听
            addProblemPreviewListeners();

            // 调试信息
            setTimeout(() => {
                const renderedProblems = container.querySelectorAll('.assignment-problem-checkbox');
                console.log('网格版本 - 渲染后的题目数量:', renderedProblems.length);
                console.log('网格版本 - 题目总数:', problems.length);
                console.log('网格版本 - 容器是否可滚动:', container.scrollHeight > container.offsetHeight);

                // 显示题目数量统计
                if (problems.length > 4) {
                    const statsHint = document.createElement('div');
                    statsHint.className = 'text-center py-3 text-xs text-dark-2 bg-light-1 border-t border-light-2';
                    statsHint.innerHTML = `<i class="fa fa-info-circle mr-1"></i> 共显示 ${problems.length} 道题目 <span class="text-primary">•</span> 滚动查看更多`;
                    statsHint.id = 'problems-stats-hint';

                    if (!container.querySelector('#problems-stats-hint')) {
                        container.appendChild(statsHint);
                    }
                }
            }, 100);
        }

        // 添加题目预览事件监听
        function addProblemPreviewListeners() {
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const problemId = this.dataset.problemId;
                    toggleProblemPreview(problemId);
                });
            });

            document.querySelectorAll('.hint-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const problemId = this.dataset.problemId;
                    showProblemHint(problemId);
                });
            });
        }

        // 切换题目预览
        function toggleProblemPreview(problemId) {
            const card = document.querySelector(`[data-problem-id="${problemId}"]`);
            if (!card) return;

            let previewDiv = card.querySelector('.problem-preview');
            const previewBtn = card.querySelector('.preview-btn');

            if (previewDiv) {
                // 已存在，切换显示/隐藏
                if (previewDiv.classList.contains('hidden')) {
                    previewDiv.classList.remove('hidden');
                    previewBtn.innerHTML = '<i class="fa fa-eye-slash"></i> 收起';
                } else {
                    previewDiv.classList.add('hidden');
                    previewBtn.innerHTML = '<i class="fa fa-eye"></i> 预览';
                }
            } else {
                // 不存在，创建预览内容
                showProblemPreview(problemId, card, previewBtn);
            }
        }

        // 显示题目预览
        async function showProblemPreview(problemId, card, previewBtn) {
            try {
                previewBtn.disabled = true;
                previewBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

                // 这里可以调用API获取详细题目信息，或者从已有数据获取
                // 暂时使用占位符
                const previewContent = await getProblemPreviewContent(problemId);

                const previewDiv = document.createElement('div');
                previewDiv.className = 'problem-preview mt-4 p-3 bg-light-1 rounded-lg border-l-4 border-primary';
                previewDiv.innerHTML = `
                    <div class="text-xs font-medium text-primary mb-2">题目预览</div>
                    <div class="space-y-2 text-xs">
                        ${previewContent}
                    </div>
                `;

                card.appendChild(previewDiv);
                previewBtn.disabled = false;
                previewBtn.innerHTML = '<i class="fa fa-eye-slash"></i> 收起';

            } catch (error) {
                console.error('获取题目预览失败:', error);
                previewBtn.disabled = false;
                previewBtn.innerHTML = '<i class="fa fa-eye"></i> 预览';
            }
        }

        // 获取题目预览内容
        async function getProblemPreviewContent(problemId) {
            // 调用API获取题目详情
            try {
                const response = await fetch(`${API_BASE}/question-bank/problem/${problemId}`);
                const result = await response.json();

                if (result.success) {
                    const problem = result.data;
                    let content = '';

                    if (problem.question_type === 'progressing') {
                        // 编程题预览
                        content += problem.input_description ? `<div><strong>输入：</strong>${problem.input_description}</div>` : '';
                        content += problem.output_description ? `<div><strong>输出：</strong>${problem.output_description}</div>` : '';
                        if (problem.test_cases && problem.test_cases.length > 0) {
                            content += `<div><strong>样例：</strong></div>`;
                            problem.test_cases.slice(0, 1).forEach((tc, idx) => {
                                content += `<div class="ml-2 text-xs bg-dark text-white p-1 rounded mt-1">
                                    <div>输入: ${tc.input.substring(0, 50)}${tc.input.length > 50 ? '...' : ''}</div>
                                    <div>输出: ${tc.output.substring(0, 50)}${tc.output.length > 50 ? '...' : ''}</div>
                                </div>`;
                            });
                        }
                    } else if (problem.question_type === 'choice') {
                        // 选择题预览
                        content += `<div><strong>选项：</strong></div>`;
                        if (problem.options) {
                            const options = typeof problem.options === 'string' ? JSON.parse(problem.options) : problem.options;
                            Object.entries(options).slice(0, 4).forEach(([key, value]) => {
                                const isCorrect = problem.correct_answer === key;
                                content += `<div class="ml-2 ${isCorrect ? 'text-success' : ''}">${key}: ${value.substring(0, 30)}${value.length > 30 ? '...' : ''} ${isCorrect ? '✓' : ''}</div>`;
                            });
                        }
                    } else if (problem.question_type === 'judgment') {
                        // 判断题预览
                        content += `<div><strong>答案：</strong>${problem.correct_answer ? '✓ 正确' : '✗ 错误'}</div>`;
                    }

                    if (problem.solution_idea) {
                        content += `<div class="mt-2"><strong>提示：</strong>${problem.solution_idea.substring(0, 100)}${problem.solution_idea.length > 100 ? '...' : ''}</div>`;
                    }

                    content += `<div class="mt-2 text-primary underline cursor-pointer text-xs" onclick="viewFullProblemDetail(${problemId})">查看完整题目详情</div>`;

                    return content;
                } else {
                    return `<div class="text-danger">加载题目详情失败</div>`;
                }
            } catch (error) {
                console.error('获取题目详情失败:', error);
                return `<div class="text-danger">网络错误，请稍后重试</div>`;
            }
        }

        // 查看完整题目详情
        function viewFullProblemDetail(problemId) {
            // 从当前题目数据中获取题目类型
            const problem = currentProblemList.find(p => p.id == problemId);
            if (problem) {
                viewProblem(problemId, problem.question_type);
            } else {
                console.warn('未找到题目数据:', problemId);
                viewProblem(problemId, 'progressing'); // 默认值
            }
        }

        // 显示题目提示（解题思路）
        function showProblemHint(problemId) {
            const card = document.querySelector(`[data-problem-id="${problemId}"]`);
            if (!card) return;

            // 这里可以实现解题思路的显示
            console.log('显示题目解题思路:', problemId);
        }

        // 筛选题目列表
        function filterProblems() {
            if (currentProblemList.length === 0) {
                console.log('没有题目数据可供筛选');
                return;
            }

            // 获取筛选条件
            const searchTerm = document.getElementById('problem-search-input')?.value.trim().toLowerCase() || '';
            const problemTypeFilter = document.getElementById('problem-type-filter-modal')?.value || '';
            const difficultyFilter = document.getElementById('problem-difficulty-filter-modal')?.value || '';

            // 调试信息
            console.log('筛选条件:', {
                searchTerm,
                problemTypeFilter,
                difficultyFilter,
                totalProblems: currentProblemList.length
            });

            // 应用筛选条件
            const filteredProblems = currentProblemList.filter(problem => {
                // 搜索条件（标题、描述、知识点）
                const searchMatch = !searchTerm ||
                    (problem.title || problem.name || '').toLowerCase().includes(searchTerm) ||
                    (problem.description || '').toLowerCase().includes(searchTerm) ||
                    (problem.knowledge_points || '').toLowerCase().includes(searchTerm);

                // 题型筛选
                const typeMatch = !problemTypeFilter || problem.question_type === problemTypeFilter;

                // 难度筛选
                const difficultyMatch = !difficultyFilter || problem.difficulty === difficultyFilter;

                return searchMatch && typeMatch && difficultyMatch;
            });

            // 调试信息
            console.log(`筛选结果: ${filteredProblems.length}/${currentProblemList.length} 道题目`);

            // 重新渲染筛选后的题目列表
            renderFilteredProblems(filteredProblems);

            // 更新筛选后统计信息
            updateFilterResultsStats(filteredProblems.length, currentProblemList.length);
        }

        // 渲染筛选后的题目
        function renderFilteredProblems(filteredProblems) {
            const container = document.getElementById('problems-selection-area');

            if (filteredProblems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-dark-2">
                        <i class="fa fa-search text-4xl text-light-3 mb-3"></i>
                        <p class="text-sm">没有找到符合条件的题目</p>
                        <button class="btn btn-outline btn-sm mt-2" onclick="clearProblemFilters()">
                            <i class="fa fa-times"></i> 清空筛选
                        </button>
                    </div>
                `;
                return;
            }

            // 创建单列布局，提供更多空间
            container.innerHTML = `
                <div class="space-y-4">
                    ${filteredProblems.map((problem, index) => `
                        <div class="problem-card bg-white border border-light-2 rounded-lg p-6 hover:shadow-lg transition-all duration-200 hover:border-primary/30" data-problem-id="${problem.id}">
                            <!-- 题目主体 -->
                            <div class="flex items-start gap-4">
                                <!-- 复选框 -->
                                <input type="checkbox" class="assignment-problem-checkbox w-5 h-5 rounded border-light-2 text-primary focus:ring-primary mt-1"
                                        data-problem-id="${problem.id}" ${selectedProblemsForAssignment.has(problem.id) ? 'checked' : ''}>

                                <!-- 主要内容 -->
                                <div class="flex-1 min-w-0">
                                    <!-- 标题行 -->
                                    <div class="flex items-center gap-3 mb-3">
                                        <h4 class="font-semibold text-dark text-base">${problem.title || problem.name || '无标题'}</h4>
                                        <div class="flex gap-2 flex-shrink-0">
                                            <span class="badge ${getProblemTypeColor(problem.question_type)}">
                                                ${getProblemTypeText(problem.question_type)}
                                            </span>
                                            <span class="badge bg-secondary/10 text-secondary">${problem.difficulty || '未知难度'}</span>
                                        </div>
                                    </div>

                                    <!-- 编程语言和知识点 -->
                                    <div class="flex items-center gap-4 text-sm text-dark-2 mb-3">
                                        <div class="flex items-center gap-1">
                                            <i class="fa fa-code text-light-3"></i>
                                            <span>${problem.language || '未知语言'}</span>
                                        </div>
                                        ${problem.knowledge_points ? `
                                            <div class="flex items-center gap-1">
                                                <i class="fa fa-book text-light-3"></i>
                                                <span>${problem.knowledge_points}</span>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- 描述 -->
                                    <p class="text-dark-2 mb-4 leading-relaxed">${(problem.description || '暂无描述').substring(0, 150)}${(problem.description || '').length > 150 ? '...' : ''}</p>

                                    <!-- 操作按钮 -->
                                    <div class="flex items-center justify-between pt-3 border-t border-light-2">
                                        <div class="flex gap-3">
                                            <button class="preview-btn text-primary hover:text-primary/80 transition-colors font-medium">
                                                <i class="fa fa-eye mr-1"></i> 查看详情
                                            </button>
                                            <button class="text-dark-2 hover:text-primary transition-colors">
                                                <i class="fa fa-info-circle mr-1"></i> 预览
                                            </button>
                                            ${problem.solution_idea ? `<button class="hint-btn text-dark-2 hover:text-primary transition-colors" data-problem-id="${problem.id}" title="查看解题思路">
                                                <i class="fa fa-lightbulb-o mr-1"></i> 线索
                                            </button>` : ''}
                                        </div>
                                        <div class="text-sm text-dark-3 font-mono">
                                            ID: ${problem.id}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // 重新绑定事件监听器
            addAssignmentProblemCheckboxListeners();
            addProblemPreviewListeners();
        }

        // 给预览按钮添加事件委托绑定
        function addProblemPreviewListeners() {
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const problemId = this.dataset.problemId;
                    toggleProblemPreview(problemId);
                });
            });

            document.querySelectorAll('.hint-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const problemId = this.dataset.problemId;
                    showProblemHint(problemId);
                });
            });
        }

        // 更新筛选结果统计
        function updateFilterResultsStats(filteredCount, totalCount) {
            const statsElement = document.getElementById('problems-stats-hint');
            if (statsElement) {
                statsElement.innerHTML = `<i class="fa fa-filter mr-1"></i> 显示 ${filteredCount} / ${totalCount} 道题目 <span class="text-primary">•</span> 滚动查看更多`;
            } else {
                // 创建统计元素
                const container = document.getElementById('problems-selection-area');
                const statsHint = document.createElement('div');
                statsHint.className = 'text-center py-3 text-xs text-dark-2 bg-light-1 border-t border-light-2';
                statsHint.id = 'problems-stats-hint';
                statsHint.innerHTML = `<i class="fa fa-filter mr-1"></i> 显示 ${filteredCount} / ${totalCount} 道题目 <span class="text-primary">•</span> 滚动查看更多`;
                container.appendChild(statsHint);
            }
        }

        // 清空题目筛选
        function clearProblemFilters() {
            // 清空搜索框
            const searchInput = document.getElementById('problem-search-input');
            if (searchInput) searchInput.value = '';

            // 重置筛选器
            const typeFilter = document.getElementById('problem-type-filter-modal');
            if (typeFilter) typeFilter.value = '';

            const difficultyFilter = document.getElementById('problem-difficulty-filter-modal');
            if (difficultyFilter) difficultyFilter.value = '';

            // 重新显示所有题目
            displayProblemsForAssignment(currentProblemList);
        }

        // 添加题目复选框事件监听
        function addAssignmentProblemCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.assignment-problem-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const problemId = parseInt(this.dataset.problemId);
                    console.log('单个复选框变化 - 处理题目 ID:', problemId);

                    // 获取题目类型（从问题卡片中查找）
                    const problemCard = this.closest('.problem-card[data-problem-id]');
                    let problemType = 'unknown';

                    if (problemCard) {
                        console.log('找到问题卡片:', problemCard.getAttribute('data-problem-id'));
                        const typeBadge = problemCard.querySelector('.flex.items-center.gap-2 .badge');
                        console.log('类型徽章元素:', typeBadge);

                        if (typeBadge) {
                            const badgeText = typeBadge.textContent.trim();
                            console.log('徽章文本:', badgeText);

                            if (badgeText.includes('编程题')) problemType = 'progressing';
                            else if (badgeText.includes('选择题')) problemType = 'choice';
                            else if (badgeText.includes('判断题')) problemType = 'judgment';
                            else problemType = 'unknown';

                            console.log('识别题目类型:', problemType);
                        } else {
                            // 回退方法：查找卡片内的其他位置的类型徽章
                            console.log('未找到特定徽章，尝试回退查找...');
                            const fallbackBadge = problemCard.querySelector('.badge');
                            if (fallbackBadge) {
                                const badgeText = fallbackBadge.textContent.trim();
                                console.log('回退徽章文本:', badgeText);

                                if (badgeText.includes('编程题')) problemType = 'progressing';
                                else if (badgeText.includes('选择题')) problemType = 'choice';
                                else if (badgeText.includes('判断题')) problemType = 'judgment';
                                else problemType = 'unknown';

                                console.log('回退识别题目类型:', problemType);
                            }
                        }
                    } else {
                        console.log('未找到问题卡片');
                    }

                    if (this.checked) {
                        console.log('添加题目到Map:', problemId, problemType);
                        selectedProblemsForAssignment.set(problemId, problemType);
                    } else {
                        console.log('从Map中移除题目:', problemId);
                        selectedProblemsForAssignment.delete(problemId);
                    }

                    console.log('当前Map内容:', Array.from(selectedProblemsForAssignment.entries()));
                    updateSelectedProblemsCount();
                });
            });
        }

        // 更新选中的班级数量
        function updateSelectedClassesCount() {
            const countElement = document.getElementById('selected-classes-count');
            if (countElement) {
                countElement.textContent = `已选择 ${selectedClassesForAssignment.size} 个班级`;
            }
        }

        // 更新选中的题目数量
        function updateSelectedProblemsCount() {
            const countElement = document.getElementById('selected-problems-count');
            if (countElement) {
                countElement.textContent = `已选择 ${selectedProblemsForAssignment.size} 道题目`;
            }
        }

        // 全选班级
        function selectAllClasses() {
            const checkboxes = document.querySelectorAll('.assignment-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const classId = parseInt(checkbox.dataset.classId);
                selectedClassesForAssignment.add(classId);
            });
            updateSelectedClassesCount();
        }

        // 取消全选班级
        function deselectAllClasses() {
            const checkboxes = document.querySelectorAll('.assignment-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const classId = parseInt(checkbox.dataset.classId);
                selectedClassesForAssignment.delete(classId);
            });
            updateSelectedClassesCount();
        }

        // 全选题目
        function selectAllProblems() {
            const checkboxes = document.querySelectorAll('.assignment-problem-checkbox');
            console.log('全选开始 - 找到的复选框数量:', checkboxes.length);

            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = true;
                const problemId = parseInt(checkbox.dataset.problemId);
                console.log(`处理复选框 ${index + 1}: ID=${problemId}, DOM结构:`, checkbox.parentElement.tagName);

                // 改进方法：直接从问题卡片获取类型
                const problemCard = checkbox.closest('.problem-card[data-problem-id]');
                let problemType = 'unknown';

                if (problemCard) {
                    const typeBadge = problemCard.querySelector('.flex.items-center.gap-2 .badge');
                    console.log(`问题卡片 ${index + 1}, Badge文本:`, typeBadge?.textContent);

                    if (typeBadge) {
                        const badgeText = typeBadge.textContent.trim();
                        if (badgeText.includes('编程题')) problemType = 'progressing';
                        else if (badgeText.includes('选择题')) problemType = 'choice';
                        else if (badgeText.includes('判断题')) problemType = 'judgment';
                        else problemType = 'unknown';
                    } else {
                        // 回退方法：从卡片内的其他位置查找
                        const fallbackBadge = problemCard.querySelector('.badge');
                        if (fallbackBadge) {
                            const badgeText = fallbackBadge.textContent.trim();
                            console.log(`回退查找Badge ${index + 1}:`, badgeText);

                            if (badgeText.includes('编程题')) problemType = 'progressing';
                            else if (badgeText.includes('选择题')) problemType = 'choice';
                            else if (badgeText.includes('判断题')) problemType = 'judgment';
                            else problemType = 'unknown';
                        }
                    }
                }

                console.log(`设置Map ${index + 1}: ID=${problemId}, Type=${problemType}`);
                selectedProblemsForAssignment.set(problemId, problemType);
            });

            console.log('全选完成 - Map大小:', selectedProblemsForAssignment.size);
            console.log('Map内容:', Array.from(selectedProblemsForAssignment.entries()));

            updateSelectedProblemsCount();
        }

        // 取消全选题目
        function deselectAllProblems() {
            const checkboxes = document.querySelectorAll('.assignment-problem-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const problemId = parseInt(checkbox.dataset.problemId);
                selectedProblemsForAssignment.delete(problemId);
            });
            updateSelectedProblemsCount();
        }

        // 提交创建作业
        async function submitCreateAssignment() {
            const assignmentName = document.getElementById('assignment-name').value.trim();
            const publishDate = document.getElementById('publish-date').value;
            const deadline = document.getElementById('deadline').value;

            // 表单验证
            if (!selectedCourseForAssignment) {
                showNotification('请选择课程', 'warning');
                return;
            }

            if (!assignmentName) {
                showNotification('请输入作业名称', 'warning');
                return;
            }

            if (!publishDate) {
                showNotification('请选择发布日期', 'warning');
                return;
            }

            if (!deadline) {
                showNotification('请选择截止日期', 'warning');
                return;
            }

            if (selectedClassesForAssignment.size === 0) {
                showNotification('请至少选择一个班级', 'warning');
                return;
            }

            if (selectedProblemsForAssignment.size === 0) {
                showNotification('请至少选择一道题目', 'warning');
                return;
            }

            // 验证截止日期是否晚于发布日期
            if (new Date(deadline) <= new Date(publishDate)) {
                showNotification('截止日期必须晚于发布日期', 'warning');
                return;
            }

            // 准备提交数据
            const formData = {
                title: assignmentName,  // 修复字段名，后端期望 'title'
                publish_date: publishDate,
                deadline: deadline,
                course_id: selectedCourseForAssignment.id,
                class_ids: Array.from(selectedClassesForAssignment),
                question_ids: Array.from(selectedProblemsForAssignment.keys()),  // 修复字段名，后端期望 'question_ids'
                question_types: Array.from(selectedProblemsForAssignment.values())  // 添加题目类型信息
            };

            console.log('提交作业数据:', formData);

            // 禁用提交按钮
            const submitBtn = document.getElementById('submit-assignment-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 创建中...';

            try {
                const response = await fetch(`${API_BASE}/teacher/assignments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('作业创建成功！', 'success');
                    closeCreateAssignmentModal();
                    // 重新加载作业列表
                    loadAssignmentData();
                } else {
                    showNotification(result.message || '作业创建失败', 'error');
                }
            } catch (error) {
                console.error('创建作业失败:', error);
                showNotification('网络错误，请重试', 'error');
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-plus"></i> 创建作业';
            }
        }

        // 搜索学生功能
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('delete-student-search');
            let searchTimeout;

            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    const searchTerm = e.target.value.trim();

                    searchTimeout = setTimeout(() => {
                        loadAllStudents(searchTerm);
                    }, 300);
                });

                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchTimeout);
                        const searchTerm = e.target.value.trim();
                        loadAllStudents(searchTerm);
                    }
                });
            }

            // 全选复选框事件
            const selectAll = document.getElementById('delete-students-select-all');
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.delete-student-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const studentId = parseInt(checkbox.dataset.id);
                        if (this.checked) {
                            selectedStudentsToDelete.add(studentId);
                        } else {
                            selectedStudentsToDelete.delete(studentId);
                        }
                    });
                    updateSelectedDeleteCount();
                });
            }
        });
    </script>

    <!-- 批改作业模态框 -->
    <div id="grade-submission-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-dark" id="grade-submission-title">批改作业</h3>
                    <p class="text-sm text-dark-2 mt-1">查看学生答题详情并评分</p>
                </div>
                <button class="p-2 rounded-full hover:bg-light-1 transition-colors" onclick="closeGradeSubmissionModal()">
                    <i class="fa fa-times text-dark-2"></i>
                </button>
            </div>

            <div class="flex-1 overflow-auto p-6" id="grade-submission-content">
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载答题详情...</p>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeGradeSubmissionModal()">取消</button>
                <button class="btn btn-primary" onclick="submitGrade()">
                    <i class="fa fa-save"></i>
                    <span>提交评分</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 编辑个人资料模态框 -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6 border-b border-light-2">
                <h3 class="text-lg font-semibold text-dark">编辑个人资料</h3>
                <p class="text-sm text-dark-2 mt-1">更新您的个人信息</p>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="form-label">邮箱</label>
                    <input type="email" id="edit-email" class="form-input" placeholder="请输入邮箱地址">
                </div>
                
                <div>
                    <label class="form-label">手机号 <span class="text-danger">*</span></label>
                    <input type="tel" id="edit-telenum" class="form-input" placeholder="请输入手机号" required>
                </div>
                
                <div>
                    <label class="form-label">课程分配</label>
                    <input type="text" id="edit-course-assignment" class="form-input" placeholder="请输入课程名称">
                    <p class="text-xs text-dark-2 mt-1">注意：修改课程分配将同步更新您所有学生的课程分配</p>
                </div>
            </div>
            
            <div class="p-6 border-t border-light-2 flex justify-end gap-3">
                <button class="btn btn-outline" onclick="closeEditProfileModal()">取消</button>
                <button class="btn btn-primary" onclick="submitProfileEdit()">保存更改</button>
            </div>
        </div>
    </div>

    <!-- 注册学生账号模态框 -->
    <div id="register-student-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6 border-b border-light-2">
                <h3 class="text-lg font-semibold text-dark">注册学生账号</h3>
                <p class="text-sm text-dark-2 mt-1">创建新的学生账号</p>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="form-label">用户名 <span class="text-danger">*</span></label>
                    <input type="text" id="register-username" class="form-input" placeholder="请输入用户名" required>
                </div>
                
                <div>
                    <label class="form-label">学号 <span class="text-danger">*</span></label>
                    <input type="text" id="register-student-id" class="form-input" placeholder="请输入学号" required>
                    <p class="text-xs text-dark-2 mt-1">初始密码将默认为学号</p>
                </div>
                
                <div>
                    <label class="form-label">邮箱 <span class="text-danger">*</span></label>
                    <input type="email" id="register-email" class="form-input" placeholder="请输入邮箱地址" required>
                </div>
                
                <div>
                    <label class="form-label">手机号 <span class="text-danger">*</span></label>
                    <input type="tel" id="register-telenum" class="form-input" placeholder="请输入手机号" required>
                </div>
            </div>
            
            <div class="p-6 border-t border-light-2 flex justify-end gap-3">
                <button class="btn btn-outline" onclick="closeRegisterStudentModal()">取消</button>
                <button class="btn btn-primary" onclick="submitRegisterStudent()">注册学生</button>
            </div>
        </div>
    </div>

    <!-- 添加班级模态框 -->
    <div id="add-class-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6 border-b border-light-2">
                <h3 class="text-lg font-semibold text-dark">添加新班级</h3>
                <p class="text-sm text-dark-2 mt-1">为选定的课程创建新班级</p>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="form-label">课程名称</label>
                    <p id="add-class-course-name" class="font-medium text-primary"></p>
                    <input type="hidden" id="add-class-course-id">
                </div>
                
                <div>
                    <label class="form-label">班级名称 <span class="text-danger">*</span></label>
                    <input type="text" id="add-class-name" class="form-input" placeholder="请输入班级名称" required>
                </div>
                
                <div>
                    <label class="form-label">班级描述</label>
                    <textarea id="add-class-description" class="form-input" placeholder="请输入班级描述（可选）" rows="3"></textarea>
                </div>
            </div>
            
            <div class="p-6 border-t border-light-2 flex justify-end gap-3">
                <button class="btn btn-outline" onclick="closeAddClassModal()">取消</button>
                <button class="btn btn-primary" onclick="submitAddClass()">创建班级</button>
            </div>
        </div>
    </div>

    <!-- 班级学生详情模态框 -->
    <div id="class-students-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-dark" id="class-students-title">班级学生列表</h3>
                    <p class="text-sm text-dark-2 mt-1">查看班级学生详情</p>
                </div>
                <button class="p-2 rounded-full hover:bg-light-1 transition-colors" onclick="closeClassStudentsModal()">
                    <i class="fa fa-times text-dark-2"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-auto p-6" id="class-students-body">
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">加载学生数据中...</p>
                </div>
            </div>
            
            <div class="p-6 border-t border-light-2 flex justify-end flex-shrink-0">
                <button class="btn btn-outline" onclick="closeClassStudentsModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 添加学生模态框 -->
    <div id="add-students-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark">添加学生到班级</h3>
                <p class="text-sm text-dark-2 mt-1" id="add-students-class-info">选择要添加到班级的学生</p>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- 搜索和筛选区域 -->
                <div class="p-4 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        <div class="flex-1 min-w-0">
                            <div class="relative">
                                <input type="text" id="add-students-search" placeholder="搜索学生..." class="form-input pl-10 w-full">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <span class="text-sm text-dark-2" id="selected-students-count">已选择 0 名学生</span>
                            <button class="text-sm text-primary hover:underline" onclick="selectAllStudentsForClass()">全选</button>
                            <button class="text-sm text-dark-2 hover:text-primary" onclick="deselectAllStudentsForClass()">取消全选</button>
                        </div>
                    </div>
                </div>
                
                <!-- 学生列表 -->
                <div class="flex-1 overflow-auto">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-white z-10">
                            <tr class="bg-light-1">
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">
                                    <input type="checkbox" id="add-students-select-all" class="rounded border-light-2 text-primary focus:ring-primary">
                                </th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">学生姓名</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">学号</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">邮箱</th>
                            </tr>
                        </thead>
                        <tbody id="add-students-table-body" class="divide-y divide-light-2">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-dark-2">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                        <p class="text-sm">加载学生数据中...</p>
                                    </div>
                                    </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeAddStudentsModal()">取消</button>
                <button class="btn btn-primary" onclick="submitAddStudents()" id="submit-add-students-btn">添加选中学生</button>
            </div>
        </div>
    </div>

    <!-- 批量注册学生模态框 -->
    <div id="batch-register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark">批量注册学生</h3>
                <p class="text-sm text-dark-2 mt-1">通过CSV文件批量创建学生账号</p>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- 文件上传区域 -->
                <div class="p-6 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="space-y-4">
                        <div>
                            <label class="form-label">选择CSV文件</label>
                            <input type="file" id="batch-register-file" accept=".csv" class="form-input">
                            <p class="text-xs text-dark-2 mt-1">支持的文件格式：CSV</p>
                        </div>

                        <!-- CSV格式说明 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-medium text-sm mb-2">CSV文件格式要求：</h4>
                            <div class="space-y-2 text-sm text-dark-2">
                                <p>第一行为表头，必须包含以下列：</p>
                                <div class="bg-light-1 p-3 rounded font-mono text-xs">
                                    用户名,学号,邮箱,手机号
                                </div>
                                <p class="mt-2">示例数据：</p>
                                <div class="bg-light-1 p-3 rounded font-mono text-xs">
                                    用户名,学号,邮箱,手机号<br>
                                    张三,20240001,zhangsan@example.com,13800138001<br>
                                    李四,20240002,lisi@example.com,13800138002
                                </div>
                                <div class="mt-3 space-y-1">
                                    <p class="font-medium">注意事项：</p>
                                    <ul class="list-disc list-inside space-y-1 text-xs">
                                        <li>用户名、邮箱、学号必须唯一</li>
                                        <li>邮箱格式必须正确</li>
                                        <li>手机号必须为11位数字</li>
                                        <li>初始密码将自动设置为学号</li>
                                        <li>单次最多支持100个学生</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="batch-register-btn" class="btn btn-primary" onclick="uploadBatchRegisterFile()">
                                <i class="fa fa-upload"></i>
                                <span>开始批量注册</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 处理结果区域 -->
                <div class="flex-1 overflow-auto p-6" id="batch-register-results" style="display: none;">
                    <div id="batch-register-loading" style="display: none;">
                        <div class="text-center py-8">
                            <svg width="40" height="40" viewBox="0 0 40 40" class="mx-auto mb-4">
                                <circle cx="20" cy="20" r="18" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="84.78" stroke-dashoffset="42.39">
                                    <animate attributeName="stroke-dashoffset" from="84.78" to="0" dur="1s" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-dasharray" from="84.78" to="84.78" dur="1s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <p class="text-dark-2">正在处理CSV文件，请稍候...</p>
                        </div>
                    </div>

                    <div id="batch-register-result-content" style="display: none;">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium">处理结果</h4>
                                <span class="text-sm text-dark-2" id="batch-register-summary">处理完成</span>
                            </div>

                            <!-- 成功注册的学生 -->
                            <div id="batch-register-success-section" style="display: none;">
                                <h5 class="font-medium text-success mb-2">✅ 成功注册的学生</h5>
                                <div class="bg-light-1 p-4 rounded-lg max-h-64 overflow-y-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-white">
                                                <th class="text-left px-3 py-2">用户名</th>
                                                <th class="text-left px-3 py-2">学号</th>
                                                <th class="text-left px-3 py-2">邮箱</th>
                                                <th class="text-left px-3 py-2">初始密码</th>
                                            </tr>
                                        </thead>
                                        <tbody id="batch-register-success-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 错误信息 -->
                            <div id="batch-register-error-section" style="display: none;">
                                <h5 class="font-medium text-danger mb-2">❌ 处理失败的学生</h5>
                                <div class="bg-light-1 p-4 rounded-lg max-h-64 overflow-y-auto">
                                    <div id="batch-register-error-list" class="space-y-2 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeBatchRegisterModal()">关闭</button>
                <button class="btn btn-success" onclick="openImportStudentsModal()">
                    <i class="fa fa-download"></i>
                    <span>导入学生</span>
                </button>
                <button class="btn btn-primary" onclick="downloadBatchRegisterTemplate()">
                    <i class="fa fa-download"></i>
                    <span>下载模板</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 删除学生模态框 -->
    <div id="delete-student-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark">删除学生</h3>
                <p class="text-sm text-dark-2 mt-1">选择要删除的学生账号</p>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- 搜索区域 -->
                <div class="p-4 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        <div class="flex-1 min-w-0">
                            <div class="relative">
                                <input type="text" id="delete-student-search" placeholder="搜索学生..." class="form-input pl-10 w-full">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3"></i>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <span class="text-sm text-dark-2" id="total-students-count">共 0 名学生</span>
                        </div>
                    </div>
                </div>

                <!-- 学生列表 -->
                <div class="flex-1 overflow-auto">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-white z-10">
                            <tr class="bg-light-1">
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">
                                    <input type="checkbox" id="delete-students-select-all" class="rounded border-light-2 text-primary focus:ring-primary">
                                </th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">用户名</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">学号</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">邮箱</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">手机号</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">注册时间</th>
                                <th class="text-left px-6 py-3 text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="delete-students-table-body" class="divide-y divide-light-2">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-dark-2">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                        <p class="text-sm">加载学生数据中...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-between items-center flex-shrink-0">
                <div class="text-sm text-dark-2">
                    已选择 <span id="selected-delete-count" class="font-medium text-primary">0</span> 名学生
                </div>
                <div class="flex gap-3">
                    <button class="btn btn-outline" onclick="closeDeleteStudentModal()">取消</button>
                    <button class="btn btn-danger" onclick="confirmDeleteStudents()" id="delete-selected-btn" disabled>
                        <i class="fa fa-trash"></i>
                        <span>删除选中学生</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量导入学生到班级模态框 -->
    <div id="batch-import-students-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark">批量导入学生到班级</h3>
                <p class="text-sm text-dark-2 mt-1">通过CSV文件批量将已注册的学生添加到班级中</p>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- 班级选择区域 -->
                <div class="p-6 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">选择课程 <span class="text-danger">*</span></label>
                            <select id="import-course-select" class="form-select" onchange="loadImportClasses(this.value)" required>
                                <option value="">请选择课程...</option>
                                <!-- 课程选项将通过JavaScript动态生成 -->
                            </select>
                        </div>

                        <div>
                            <label class="form-label">选择班级 <span class="text-danger">*</span></label>
                            <select id="import-class-select" class="form-select" required>
                                <option value="">请先选择课程...</option>
                                <!-- 班级选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 文件上传区域 -->
                <div class="p-6 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="space-y-4">
                        <div>
                            <label class="form-label">选择CSV文件</label>
                            <input type="file" id="import-students-file" accept=".csv" class="form-input">
                            <p class="text-xs text-dark-2 mt-1">支持的文件格式：CSV</p>
                        </div>

                        <!-- CSV格式说明 -->
                        <div class="bg-white p-4 rounded-lg border border-light-2">
                            <h4 class="font-medium text-sm mb-2">CSV文件格式要求：</h4>
                            <div class="space-y-2 text-sm text-dark-2">
                                <p>第一行为表头，必须包含以下列：</p>
                                <div class="bg-light-1 p-3 rounded font-mono text-xs">
                                    用户名,学号,邮箱,手机号
                                </div>
                                <p class="mt-2">示例数据：</p>
                                <div class="bg-light-1 p-3 rounded font-mono text-xs">
                                    用户名,学号,邮箱,手机号<br>
                                    张三,20240001,zhangsan@example.com,13800138001<br>
                                    李四,20240002,lisi@example.com,13800138002
                                </div>
                                <div class="mt-3 space-y-1">
                                    <p class="font-medium">注意事项：</p>
                                    <ul class="list-disc list-inside space-y-1 text-xs">
                                        <li>学生必须已经在系统中注册</li>
                                        <li>用户名、邮箱、学号必须与系统中注册信息匹配</li>
                                        <li>学生不能已经在这个班级中</li>
                                        <li>单次最多支持100个学生</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="text-center text-dark-2">
                            <p class="text-sm">请在下方选择文件后，点击"导入学生"按钮</p>
                        </div>
                    </div>
                </div>

                <!-- 处理结果区域 -->
                <div class="flex-1 overflow-auto p-6" id="import-results" style="display: none;">
                    <div id="import-loading" style="display: none;">
                        <div class="text-center py-8">
                            <svg width="40" height="40" viewBox="0 0 40 40" class="mx-auto mb-4">
                                <circle cx="20" cy="20" r="18" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="84.78" stroke-dashoffset="42.39">
                                    <animate attributeName="stroke-dashoffset" from="84.78" to="0" dur="1s" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-dasharray" from="84.78" to="84.78" dur="1s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <p class="text-dark-2">正在处理CSV文件，请稍候...</p>
                        </div>
                    </div>

                    <div id="import-result-content" style="display: none;">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium">导入结果</h4>
                                <span class="text-sm text-dark-2" id="import-summary">处理完成</span>
                            </div>

                            <!-- 成功导入的学生 -->
                            <div id="import-success-section" style="display: none;">
                                <h5 class="font-medium text-success mb-2">✅ 成功导入的学生</h5>
                                <div class="bg-light-1 p-4 rounded-lg max-h-64 overflow-y-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-white">
                                                <th class="text-left px-3 py-2">用户名</th>
                                                <th class="text-left px-3 py-2">学号</th>
                                                <th class="text-left px-3 py-2">邮箱</th>
                                                <th class="text-left px-3 py-2">状态</th>
                                            </tr>
                                        </thead>
                                        <tbody id="import-success-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 错误信息 -->
                            <div id="import-error-section" style="display: none;">
                                <h5 class="font-medium text-danger mb-2">❌ 导入失败的学生</h5>
                                <div class="bg-light-1 p-4 rounded-lg max-h-64 overflow-y-auto">
                                    <div id="import-error-list" class="space-y-2 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeBatchImportModal()">关闭</button>
                <button class="btn btn-success" onclick="downloadImportTemplate()">
                    <i class="fa fa-download"></i>
                    <span>下载模板</span>
                </button>
                <button class="btn btn-primary" onclick="processBatchImport()" id="batch-import-btn">
                    <i class="fa fa-upload"></i>
                    <span>导入学生</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 创建作业模态框 -->
    <div id="create-assignment-modal" class="hidden fixed inset-0 bg-gradient-to-br from-black/40 via-black/50 to-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[98vh] overflow-hidden flex flex-col border border-white/10">
            <!-- 现代化头部设计 - 减少高度 -->
            <div class="relative bg-gradient-to-r from-primary via-secondary to-primary p-4 flex-shrink-0 overflow-hidden">
                <!-- 装饰性背景元素 -->
                <div class="absolute inset-0 bg-white/5"></div>
                <div class="absolute -top-6 -right-6 w-20 h-20 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-4 -left-4 w-12 h-12 bg-white/5 rounded-full"></div>

                <!-- 头部内容 -->
                <div class="relative flex items-center gap-4">
                    <!-- 图标和标题区域 -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fa fa-plus text-lg text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white mb-1">创建新作业</h3>
                            <p class="text-white/80 text-xs font-medium">布置作业给学生并选择题目</p>
                        </div>
                    </div>

                    <!-- 右上角装饰元素 -->
                    <div class="ml-auto">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-white/30 rounded-full"></div>
                            <div class="w-2 h-2 bg-white/20 rounded-full"></div>
                            <div class="w-2 h-2 bg-white/10 rounded-full"></div>
                        </div>
                    </div>
                </div>

                <!-- 底部阴影渐变 -->
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
            </div>

            <!-- 关闭按钮 -->
            <button class="absolute top-6 right-6 w-10 h-10 bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all duration-200 z-10 border border-white/20 hover:border-white/30 group" onclick="closeCreateAssignmentModal()">
                <i class="fa fa-times text-lg group-hover:rotate-90 transition-transform duration-200"></i>
            </button>

            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- 课程选择区域 - 缩小高度 -->
                <div class="p-4 border-b border-light-2 bg-light-1 flex-shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="form-label text-xs">选择课程 <span class="text-danger">*</span></label>
                            <select id="assignment-course-select" class="form-select text-sm py-2" onchange="onCourseSelectionChange()" required>
                                <option value="">请选择课程...</option>
                                <!-- 课程选项将通过JavaScript动态生成 -->
                            </select>
                        </div>

                        <div>
                            <label class="form-label text-xs">作业名称 <span class="text-danger">*</span></label>
                            <input type="text" id="assignment-name" class="form-input text-sm py-2" placeholder="请输入作业名称" required>
                        </div>

                        <div>
                            <label class="form-label text-xs">发布日期 <span class="text-danger">*</span></label>
                            <input type="datetime-local" id="publish-date" class="form-input text-sm py-2" required>
                        </div>

                        <div>
                            <label class="form-label text-xs">截止日期 <span class="text-danger">*</span></label>
                            <input type="datetime-local" id="deadline" class="form-input text-sm py-2" required>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden flex">
                    <!-- 班级选择区域 - 优化布局 -->
                    <div class="w-80 max-w-sm border-r border-light-2 flex flex-col">
                        <div class="p-3 border-b border-light-2 bg-light-1 flex-shrink-0">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-dark text-sm">选择班级</h4>
                                <span class="text-xs text-dark-2" id="selected-classes-count">已选择 0 个班级</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="text-xs text-primary hover:underline" onclick="selectAllClasses()">全选</button>
                                <button class="text-xs text-dark-2 hover:text-primary" onclick="deselectAllClasses()">取消全选</button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-3 min-h-0" id="classes-selection-area" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                            <div class="text-center py-8 text-dark-2">
                                <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                <p class="text-sm">加载班级列表中...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 题目选择区域 - 优化布局 -->
                    <div class="flex-1 flex flex-col">
                        <!-- 顶部操作栏 - 更紧凑 -->
                        <div class="p-3 border-b border-light-2 bg-light-1 flex-shrink-0">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h4 class="font-medium text-dark text-sm">选择题目</h4>
                                    <p class="text-xs text-dark-2 mt-0.5" id="language-filter-info">显示所有语言的题目</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-dark-2" id="selected-problems-count">已选择 0 道题目</span>
                                    <div class="flex gap-1 mt-1">
                                        <button class="text-xs text-primary hover:underline" onclick="selectAllProblems()">全选</button>
                                        <button class="text-xs text-dark-2 hover:text-primary" onclick="deselectAllProblems()">取消全选</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 搜索和筛选区域 - 单行布局 -->
                            <div class="flex gap-3 items-end">
                                <div class="flex-1">
                                    <label class="form-label text-xs">搜索题目</label>
                                    <div class="relative">
                                        <input type="text" id="problem-search-input" placeholder="搜索题目标题或知识点..." class="form-input text-sm pl-8 py-2" oninput="filterProblems()">
                                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-3 text-sm"></i>
                                    </div>
                                </div>

                                <div class="w-24">
                                    <label class="form-label text-xs">题型</label>
                                    <select id="problem-type-filter-modal" class="form-select text-sm py-2" onchange="filterProblems()">
                                        <option value="">全部题型</option>
                                        <option value="progressing">编程题</option>
                                        <option value="choice">选择题</option>
                                        <option value="judgment">判断题</option>
                                    </select>
                                </div>

                                <div class="w-24">
                                    <label class="form-label text-xs">难度</label>
                                    <select id="problem-difficulty-filter-modal" class="form-select text-sm py-2" onchange="filterProblems()">
                                        <option value="">全部难度</option>
                                        <option value="简单">简单</option>
                                        <option value="中等">中等</option>
                                        <option value="困难">困难</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 题目列表区域 -->
                        <div class="flex-1 overflow-hidden">
                            <!-- 题目网格容器 -->
                            <div class="h-full overflow-y-auto p-4" id="problems-selection-area" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                                <div class="text-center py-8 text-dark-2">
                                    <i class="fa fa-spinner fa-spin text-2xl text-light-3 mb-3"></i>
                                    <p class="text-sm">加载题目列表中...</p>
                                </div>
                            </div>

                            <!-- 分页控制 -->
                            <div class="border-t border-light-2 p-4 bg-light-1 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-dark-2">
                                        <span id="problems-page-info">第 0 页，共 0 页</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="problems-prev-page" class="px-3 py-1 text-sm border border-light-2 rounded hover:border-primary hover:text-primary disabled:opacity-50 disabled:hover:border-light-2 disabled:hover:text-dark-2" disabled>
                                            <i class="fa fa-chevron-left"></i>
                                        </button>
                                        <span class="text-sm px-3 py-1 text-dark-2" id="problems-current-page">1</span>
                                        <button id="problems-next-page" class="px-3 py-1 text-sm border border-light-2 rounded hover:border-primary hover:text-primary disabled:opacity-50 disabled:hover:border-light-2 disabled:hover:text-dark-2">
                                            <i class="fa fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeCreateAssignmentModal()">取消</button>
                <button class="btn btn-primary" onclick="submitCreateAssignment()" id="submit-assignment-btn">
                    <i class="fa fa-plus"></i>
                    <span>创建作业</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 题目详情模态框 -->
    <div id="problem-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-dark" id="problem-detail-title">题目详情</h3>
                    <p class="text-sm text-dark-2 mt-1">查看题目的完整信息</p>
                </div>
                <button class="p-2 rounded-full hover:bg-light-1 transition-colors" onclick="closeProblemDetailModal()">
                    <i class="fa fa-times text-dark-2"></i>
                </button>
            </div>

            <div class="flex-1 overflow-auto p-6" id="problem-detail-content">
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载题目详情...</p>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end flex-shrink-0">
                <button class="btn btn-outline" onclick="closeProblemDetailModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编辑题目模态框 -->
    <div id="edit-problem-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark" id="edit-problem-title">编辑题目</h3>
                <p class="text-sm text-dark-2 mt-1">修改题目信息和内容</p>
            </div>

            <div class="flex-1 overflow-auto p-6">
                <div id="edit-problem-form" class="space-y-6">
                    <!-- 加载状态 -->
                    <div class="loading-state text-center py-8">
                        <div class="text-center py-8 text-dark-2">
                            <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                            <p class="text-sm">正在加载题目数据...</p>
                        </div>
                    </div>

                    <!-- 编辑表单内容 -->
                    <div class="form-content" style="display: none;">
                        <!-- 基本信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">编程语言 <span class="text-danger">*</span></label>
                                <select id="edit-problem-language" class="form-select" required>
                                    <option value="">请选择语言</option>
                                    <option value="Python">Python</option>
                                    <option value="C++">C++</option>
                                    <option value="Java">Java</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-label">知识点 <span class="text-danger">*</span></label>
                                <select id="edit-problem-knowledge-point" class="form-select" required>
                                    <option value="">请选择知识点</option>
                                    <option value="数组">数组</option>
                                    <option value="字符串">字符串</option>
                                    <option value="哈希表">哈希表</option>
                                    <option value="动态规划">动态规划</option>
                                    <option value="排序算法">排序算法</option>
                                    <option value="贪心算法">贪心算法</option>
                                    <option value="深度优先搜索">深度优先搜索</option>
                                    <option value="广度优先搜索">广度优先搜索</option>
                                    <option value="二分查找">二分查找</option>
                                    <option value="树">树</option>
                                    <option value="二叉树">二叉树</option>
                                    <option value="图">图</option>
                                    <option value="堆">堆</option>
                                    <option value="栈">栈</option>
                                    <option value="队列">队列</option>
                                    <option value="链表">链表</option>
                                    <option value="位运算">位运算</option>
                                    <option value="双指针">双指针</option>
                                    <option value="滑动窗口">滑动窗口</option>
                                    <option value="递归">递归</option>
                                    <option value="分治">分治</option>
                                    <option value="数学">数学</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-label">难度 <span class="text-danger">*</span></label>
                                <select id="edit-problem-difficulty" class="form-select" required>
                                    <option value="">请选择难度</option>
                                    <option value="简单">简单</option>
                                    <option value="中等">中等</option>
                                    <option value="困难">困难</option>
                                </select>
                            </div>
                        </div>

                        <!-- 标题 -->
                        <div>
                            <label class="form-label">标题 <span class="text-danger">*</span></label>
                            <input type="text" id="edit-problem-title-input" class="form-input" placeholder="请输入题目标题" required>
                        </div>

                        <!-- 题目描述 -->
                        <div>
                            <label class="form-label">题目描述 <span class="text-danger">*</span></label>
                            <textarea id="edit-problem-description" class="form-input" rows="4" placeholder="请输入题目描述" required></textarea>
                        </div>

                        <!-- 解决思路 -->
                        <div>
                            <label class="form-label">解决思路</label>
                            <textarea id="edit-problem-solution-idea" class="form-input" rows="3" placeholder="请输入解决思路"></textarea>
                        </div>

                        <!-- 编程题特有字段 -->
                        <div id="edit-programming-fields" class="space-y-4" style="display: none;">
                            <div class="border-t border-light-2 pt-4">
                                <h4 class="font-medium text-dark mb-4">编程题信息</h4>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="form-label">输入描述</label>
                                        <textarea id="edit-problem-input-desc" class="form-input" rows="3" placeholder="描述输入格式"></textarea>
                                    </div>

                                    <div>
                                        <label class="form-label">输出描述</label>
                                        <textarea id="edit-problem-output-desc" class="form-input" rows="3" placeholder="描述输出格式"></textarea>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label">参考代码</label>
                                    <textarea id="edit-problem-reference-code" class="form-input" rows="6" placeholder="请输入参考代码"></textarea>
                                </div>

                                <!-- 测试用例 -->
                                <div>
                                    <label class="form-label">测试用例</label>
                                    <div id="edit-test-cases-container">
                                        <!-- 测试用例将动态添加 -->
                                    </div>

                                    <button type="button" class="btn btn-outline btn-sm mt-2" onclick="addEditTestCase()">
                                        <i class="fa fa-plus"></i>
                                        添加更多的测试用例
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 选择题特有字段 -->
                        <div id="edit-choice-fields" class="space-y-4" style="display: none;">
                            <div class="border-t border-light-2 pt-4">
                                <h4 class="font-medium text-dark mb-4">选择题选项</h4>

                                <div class="space-y-3">
                                    <div>
                                        <label class="form-label">选项 A <span class="text-danger">*</span></label>
                                        <input type="text" id="edit-option-a" class="form-input" placeholder="请输入选项A内容" required>
                                    </div>

                                    <div>
                                        <label class="form-label">选项 B <span class="text-danger">*</span></label>
                                        <input type="text" id="edit-option-b" class="form-input" placeholder="请输入选项B内容" required>
                                    </div>

                                    <div>
                                        <label class="form-label">选项 C <span class="text-danger">*</span></label>
                                        <input type="text" id="edit-option-c" class="form-input" placeholder="请输入选项C内容" required>
                                    </div>

                                    <div>
                                        <label class="form-label">选项 D <span class="text-danger">*</span></label>
                                        <input type="text" id="edit-option-d" class="form-input" placeholder="请输入选项D内容" required>
                                    </div>

                                    <div>
                                        <label class="form-label">正确答案 <span class="text-danger">*</span></label>
                                        <select id="edit-correct-answer-choice" class="form-select" required>
                                            <option value="">请选择正确答案</option>
                                            <option value="A">A</option>
                                            <option value="B">B</option>
                                            <option value="C">C</option>
                                            <option value="D">D</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 判断题特有字段 -->
                        <div id="edit-judgment-fields" class="space-y-4" style="display: none;">
                            <div class="border-t border-light-2 pt-4">
                                <h4 class="font-medium text-dark mb-4">判断题答案</h4>

                                <div>
                                    <label class="form-label">正确答案 <span class="text-danger">*</span></label>
                                    <select id="edit-correct-answer-judgment" class="form-select" required>
                                        <option value="">请选择正确答案</option>
                                        <option value="true">对</option>
                                        <option value="false">错</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeEditProblemModal()">取消</button>
                <button class="btn btn-primary" onclick="submitEditProblem()">
                    <i class="fa fa-save"></i>
                    <span>保存更改</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 增加题目模态框 -->
    <div id="add-problem-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-dark">增加题目</h3>
                <p class="text-sm text-dark-2 mt-1">创建新的编程题目</p>
            </div>

            <div class="flex-1 overflow-auto p-6">
                <form id="add-problem-form" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">题型 <span class="text-danger">*</span></label>
                            <select id="problem-type" class="form-select" onchange="onProblemTypeChange()" required>
                                <option value="">请选择题型</option>
                                <option value="programming">编程题</option>
                                <option value="choice">选择题</option>
                                <option value="judgment">判断题</option>
                            </select>
                        </div>

                        <!-- 统一的语言选择器 -->
                        <div id="language-field">
                            <label class="form-label">编程语言 <span class="text-danger">*</span></label>
                            <select id="problem-language" class="form-select" required>
                                <option value="">请选择语言</option>
                                <option value="C++">C++</option>
                                <option value="Python">Python</option>
                                <option value="Java">Java</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">知识点 <span class="text-danger">*</span></label>
                            <select id="problem-knowledge-point" class="form-select" required>
                                <option value="">请选择知识点</option>
                                <option value="数组">数组</option>
                                <option value="字符串">字符串</option>
                                <option value="哈希表">哈希表</option>
                                <option value="动态规划">动态规划</option>
                                <option value="排序算法">排序算法</option>
                                <option value="贪心算法">贪心算法</option>
                                <option value="深度优先搜索">深度优先搜索</option>
                                <option value="广度优先搜索">广度优先搜索</option>
                                <option value="二分查找">二分查找</option>
                                <option value="树">树</option>
                                <option value="二叉树">二叉树</option>
                                <option value="图">图</option>
                                <option value="堆">堆</option>
                                <option value="栈">栈</option>
                                <option value="队列">队列</option>
                                <option value="链表">链表</option>
                                <option value="位运算">位运算</option>
                                <option value="双指针">双指针</option>
                                <option value="滑动窗口">滑动窗口</option>
                                <option value="递归">递归</option>
                                <option value="分治">分治</option>
                                <option value="数学">数学</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">难度 <span class="text-danger">*</span></label>
                            <select id="problem-difficulty" class="form-select" required>
                                <option value="">请选择难度</option>
                                <option value="简单">简单</option>
                                <option value="中等">中等</option>
                                <option value="困难">困难</option>
                            </select>
                        </div>
                    </div>

                    <!-- 标题 -->
                    <div>
                        <label class="form-label">标题 <span class="text-danger">*</span></label>
                        <input type="text" id="problem-title" class="form-input" placeholder="请输入题目标题" required>
                    </div>

                    <!-- 题目描述 -->
                    <div>
                        <label class="form-label">题目描述 <span class="text-danger">*</span></label>
                        <textarea id="problem-description" class="form-input" rows="4" placeholder="请输入题目描述" required></textarea>
                    </div>

                    <!-- 解决思路 -->
                    <div>
                        <label class="form-label">解决思路</label>
                        <textarea id="problem-solution-idea" class="form-input" rows="3" placeholder="请输入解决思路"></textarea>
                    </div>

                    <!-- 编程题特有字段 -->
                    <div id="programming-fields" class="space-y-4" style="display: none;">
                        <div class="border-t border-light-2 pt-4">
                            <h4 class="font-medium text-dark mb-4">编程题信息</h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">输入描述</label>
                                    <textarea id="problem-input-desc" class="form-input" rows="3" placeholder="描述输入格式"></textarea>
                                </div>

                                <div>
                                    <label class="form-label">输出描述</label>
                                    <textarea id="problem-output-desc" class="form-input" rows="3" placeholder="描述输出格式"></textarea>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">参考代码</label>
                                <textarea id="problem-reference-code" class="form-input" rows="6" placeholder="请输入参考代码"></textarea>
                            </div>

                            <!-- 测试用例 -->
                            <div>
                                <label class="form-label">测试用例</label>
                                <div id="test-cases-container">
                                    <!-- 默认显示3个测试用例 -->
                                    <div class="test-case-item bg-light-1 p-4 rounded-lg mb-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-medium text-sm">测试用例 1</h5>
                                            <button type="button" class="text-danger hover:underline text-sm" onclick="removeTestCase(this)">删除</button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label class="form-label text-xs">输入</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="测试输入"></textarea>
                                            </div>
                                            <div>
                                                <label class="form-label text-xs">输出</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="预期输出"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="test-case-item bg-light-1 p-4 rounded-lg mb-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-medium text-sm">测试用例 2</h5>
                                            <button type="button" class="text-danger hover:underline text-sm" onclick="removeTestCase(this)">删除</button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label class="form-label text-xs">输入</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="测试输入"></textarea>
                                            </div>
                                            <div>
                                                <label class="form-label text-xs">输出</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="预期输出"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="test-case-item bg-light-1 p-4 rounded-lg mb-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-medium text-sm">测试用例 3</h5>
                                            <button type="button" class="text-danger hover:underline text-sm" onclick="removeTestCase(this)">删除</button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label class="form-label text-xs">输入</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="测试输入"></textarea>
                                            </div>
                                            <div>
                                                <label class="form-label text-xs">输出</label>
                                                <textarea class="form-input text-xs" rows="3" placeholder="预期输出"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-outline btn-sm mt-2" onclick="addTestCase()">
                                    <i class="fa fa-plus"></i>
                                    添加更多的测试用例
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 选择题特有字段 -->
                    <div id="choice-fields" class="space-y-4" style="display: none;">
                        <div class="border-t border-light-2 pt-4">
                            <h4 class="font-medium text-dark mb-4">选择题选项</h4>

                            <div class="space-y-3">
                                <div>
                                    <label class="form-label">选项 A <span class="text-danger">*</span></label>
                                    <input type="text" id="option-a" class="form-input" placeholder="请输入选项A内容" required>
                                </div>

                                <div>
                                    <label class="form-label">选项 B <span class="text-danger">*</span></label>
                                    <input type="text" id="option-b" class="form-input" placeholder="请输入选项B内容" required>
                                </div>

                                <div>
                                    <label class="form-label">选项 C <span class="text-danger">*</span></label>
                                    <input type="text" id="option-c" class="form-input" placeholder="请输入选项C内容" required>
                                </div>

                                <div>
                                    <label class="form-label">选项 D <span class="text-danger">*</span></label>
                                    <input type="text" id="option-d" class="form-input" placeholder="请输入选项D内容" required>
                                </div>

                                <div>
                                    <label class="form-label">正确答案 <span class="text-danger">*</span></label>
                                    <select id="correct-answer-choice" class="form-select" required>
                                        <option value="">请选择正确答案</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 判断题特有字段 -->
                    <div id="judgment-fields" class="space-y-4" style="display: none;">
                        <div class="border-t border-light-2 pt-4">
                            <h4 class="font-medium text-dark mb-4">判断题答案</h4>

                            <div>
                                <label class="form-label">正确答案 <span class="text-danger">*</span></label>
                                <select id="correct-answer-judgment" class="form-select" required>
                                    <option value="">请选择正确答案</option>
                                    <option value="true">对</option>
                                    <option value="false">错</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end gap-3 flex-shrink-0">
                <button class="btn btn-outline" onclick="closeAddProblemModal()">取消</button>
                <button class="btn btn-primary" onclick="submitAddProblem()">
                    <i class="fa fa-save"></i>
                    <span>保存题目</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 作业详情模态框 -->
    <div id="assignment-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-light-2 flex-shrink-0 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-dark" id="assignment-detail-title">作业详情</h3>
                    <p class="text-sm text-dark-2 mt-1">查看作业包含的题目信息</p>
                </div>
                <button class="p-2 rounded-full hover:bg-light-1 transition-colors" onclick="closeAssignmentDetailModal()">
                    <i class="fa fa-times text-dark-2"></i>
                </button>
            </div>

            <div class="flex-1 overflow-auto p-6" id="assignment-detail-content">
                <div class="text-center py-8 text-dark-2">
                    <i class="fa fa-spinner fa-spin text-4xl text-light-3 mb-3"></i>
                    <p class="text-sm">正在加载作业详情...</p>
                </div>
            </div>

            <div class="p-6 border-t border-light-2 flex justify-end flex-shrink-0">
                <button class="btn btn-outline" onclick="closeAssignmentDetailModal()">关闭</button>
            </div>
        </div>
    </div>
</body>
</html>
